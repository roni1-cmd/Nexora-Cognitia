<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexora - AI Chatbot</title>
    <link rel="icon" href="Nexora Crescent.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --text-color: #333;
            --light-text: #f8f9fa;
            --bg-color: #f8f9fa;
            --chat-bg: #ffffff;
            --message-user-bg: linear-gradient(to right, #6a11cb, #2575fc);
            --message-bot-bg: #f8f9fa;
            --border-color: #dee2e6;
            --input-bg: #ffffff;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --sidebar-bg: #f8f9fa;
            --sidebar-text: #333;
            --sidebar-hover: #e9ecef;
            --sidebar-overlay: rgba(0, 0, 0, 0.5);
            --toast-bg: rgba(0, 0, 0, 0.8);
            --toast-text: #fff;
            --search-highlight: #ffeb3b;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --keyword-highlight: #6a11cb;
        }

        [data-theme="dark"] {
            --primary-color: #8a2be2;
            --secondary-color: #4169e1;
            --text-color: #e9ecef;
            --light-text: #f8f9fa;
            --bg-color: #121212;
            --chat-bg: #1e1e2d;
            --message-user-bg: linear-gradient(to right, #8a2be2, #4169e1);
            --message-bot-bg: #2a2a3c;
            --border-color: #2a2a3c;
            --input-bg: #2a2a3c;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --sidebar-bg: #1e1e2d;
            --sidebar-text: #a3a3b5;
            --sidebar-hover: #2a2a3c;
            --sidebar-overlay: rgba(0, 0, 0, 0.7);
            --toast-bg: rgba(255, 255, 255, 0.8);
            --toast-text: #000;
            --search-highlight: #ffd700;
            --modal-bg: rgba(0, 0, 0, 0.8);
            --keyword-highlight: #8a2be2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .sidebar-toggle {
            background: transparent;
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--sidebar-overlay);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: transform 0.3s ease, background-color 0.3s, color 0.3s;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1001;
            border-radius: 0 20px 20px 0;
            box-shadow: var(--box-shadow);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('Nexora1.png');
            background-size: 1000px;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.2;
            z-index: -1;
            border-radius: 0 20px 20px 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 1;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-color);
        }

        .user-status {
            font-size: 12px;
            opacity: 0.7;
        }

        .sidebar-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            z-index: 1;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
        }

        .sidebar-item:hover {
            background-color: var(--sidebar-hover);
        }

        .sidebar-item.active {
            background-color: var(--sidebar-hover);
            border-left: 3px solid var(--primary-color);
        }

        .sidebar-item-icon {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-item-text {
            flex: 1;
        }

        .sidebar-item-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .sidebar-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-left: 0;
            transition: margin-left 0.3s ease;
            width: 100%;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: transparent;
            position: relative;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 28px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            cursor: pointer;
            width: 40px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            position: relative;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 4px;
        }

        .theme-toggle svg {
            width: 12px;
            height: 12px;
            color: var(--text-color);
            z-index: 1;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        [data-theme="dark"] .theme-toggle {
            background-color: var(--primary-color);
        }

        [data-theme="dark"] .theme-toggle::after {
            transform: translateX(20px);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: transparent;
            transition: background-color 0.3s;
            min-height: 0;
            position: relative;
        }

        .empty-chat-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            height: 100%;
            transform: translateY(-10%); /* Lift up the container */
        }

        .empty-chat-container.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .empty-chat-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            border-radius: 50%;
            overflow: hidden;
        }

        .empty-chat-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .empty-chat-title {
            font-size: 3rem;
            font-weight: 600;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }

        .empty-chat-description {
            font-size: 1.2rem;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--bg-color);
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color);
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            position: relative;
        }

        .message-content {
            max-width: 80%;
            padding: 12px 15px;
            line-height: 1.5;
            border-radius: 18px;
            position: relative;
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            color: var(--light-text);
            background: var(--message-user-bg);
            border-radius: 18px;
        }

        .bot-message .message-content {
            color: var(--text-color);
            background-color: transparent;
            border-radius: 18px;
        }

        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            background-color: var(--bg-color);
            border-radius: 15px;
            padding: 3px 8px;
            box-shadow: var(--box-shadow);
            z-index: 5;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .message-action-btn:hover {
            background-color: var(--sidebar-hover);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar-chat {
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .input-container {
            display: flex;
            padding: 15px;
            background-color: transparent;
            position: relative;
            z-index: 10;
            border-radius: 20px 20px 0 0;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding-right: 90px; /* Space for buttons */
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 16px;
            background-color: transparent;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        #user-input::placeholder {
            color: var(--text-color);
            opacity: 0.6;
        }

        .input-buttons {
            position: absolute;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        #send-button, #stop-button, #regenerate-button {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        #send-button:hover, #stop-button:hover, #regenerate-button:hover {
            transform: scale(1.05);
        }

        #stop-button, #regenerate-button {
            display: none;
        }

        #stop-button {
            background: #ff4757;
        }

        #stop-button.visible, #regenerate-button.visible {
            display: flex;
        }

        .thinking-dots {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-color);
            border-radius: 50%;
            margin: 0 3px;
            animation: thinking 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .system-message {
            text-align: center;
            margin: 10px 0;
            color: var(--text-color);
            opacity: 0.7;
            font-style: italic;
        }

        pre {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 15px;
            overflow-x: auto;
            margin: 5px 0;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
        }

        /* Cursor animation */
        .cursor {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-content {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            background-color: var(--sidebar-hover);
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--border-color);
        }

        .search-highlight {
            background-color: var(--search-highlight);
            padding: 0 2px;
            border-radius: 3px;
        }

        /* Keyword highlight in bot messages */
        .keyword {
            font-weight: bold;
            color: var(--keyword-highlight);
        }

        /* Login popup styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup-container {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }

        .popup-overlay.active .popup-container {
            transform: translateY(0);
        }

        .popup-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .popup-content {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .popup-button {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 30px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: transform 0.2s;
        }

        .popup-button:hover {
            transform: scale(1.05);
        }

        .popup-button svg {
            margin-right: 10px;
        }

        .popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Conversation history styles */
        .conversation-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
        }

        .conversation-item:hover {
            background-color: var(--sidebar-hover);
        }

        .conversation-item.active {
            background-color: var(--sidebar-hover);
            border-left: 3px solid var(--primary-color);
        }

        .conversation-icon {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .conversation-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .conversation-date {
            font-size: 10px;
            opacity: 0.7;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--toast-bg);
            color: var(--toast-text);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .toast.active {
            opacity: 1;
            visibility: visible;
        }

        /* Logout confirmation modal */
        .logout-modal {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .logout-modal-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .logout-modal-content {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .logout-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .logout-modal-button {
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .logout-modal-button:hover {
            transform: scale(1.05);
        }

        .logout-modal-button.cancel {
            background-color: var(--border-color);
            color: var(--text-color);
            border: none;
        }

        .logout-modal-button.confirm {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }

        /* Libraries and Connections content */
        .content-section {
            padding: 20px;
            background-color: var(--bg-color);
            border-radius: 15px;
            margin: 15px;
            box-shadow: var(--box-shadow);
        }

        .content-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .content-description {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .content-card {
            background-color: var(--input-bg);
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--box-shadow);
            transition: transform 0.2s;
            cursor: pointer;
        }

        .content-card:hover {
            transform: translateY(-5px);
        }

        .content-card-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            color: white;
        }

        .content-card-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .content-card-description {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .header {
                padding: 10px 15px;
            }
            
            .logo h1 {
                font-size: 24px;
            }
            
            .empty-chat-title {
                font-size: 2.5rem;
            }
            
            .empty-chat-description {
                font-size: 1rem;
            }
            
            .message-content { 
                max-width: 85%; 
            }
            
            .avatar { 
                width: 30px; 
                height: 30px; 
                margin: 0 5px; 
            }
            
            .input-container {
                padding: 10px;
            }
            
            #user-input {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            #send-button, #stop-button, #regenerate-button {
                width: 30px;
                height: 30px;
            }

            .message-actions {
                top: -25px;
            }
        }

        @media (min-width: 769px) {
            .app-container.sidebar-expanded .main-content {
                margin-left: 280px;
            }
            
            .app-container.sidebar-expanded .sidebar {
                transform: translateX(0);
            }
            
            .app-container:not(.sidebar-expanded) .sidebar {
                transform: translateX(-100%);
            }
        }
    </style>
</head>
<body>
    <div class="app-container" id="app-container">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar" id="sidebar-avatar">
                    <img src="Nexora.png" alt="Nexora Logo" id="user-profile-pic">
                </div>
                <div class="user-info">
                    <div class="user-name" id="user-display-name">Nexora</div>
                    <div class="user-status" id="user-status">Free Planning</div>
                </div>
            </div>
            
            <div class="sidebar-item active" id="new-chat-btn">
                <div class="sidebar-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                </div>
                <div class="sidebar-item-text">New chat</div>
            </div>
            
            <div class="sidebar-divider"></div>
            
            <div id="conversations-container">
                <!-- Conversation history will be added here -->
            </div>
            
            <div class="sidebar-divider"></div>
            
            <div class="sidebar-item" id="search-btn">
                <div class="sidebar-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                </div>
                <div class="sidebar-item-text">Search</div>
            </div>
            
            <div class="sidebar-item" id="libraries-btn">
                <div class="sidebar-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                    </svg>
                </div>
                <div class="sidebar-item-text">Libraries</div>
                <div class="sidebar-item-badge">Beta</div>
            </div>
            
            <div class="sidebar-item" id="connections-btn">
                <div class="sidebar-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M6 1H1v14h5V1zm9 0h-5v5h5V1zm0 9v5h-5v-5h5zM0 1a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V1zm9 0a1 1 0 0 1 1-1h5a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1h-5a1 1 0 0 1-1-1V1zm1 8a1 1 0 0 0-1 1v5a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1v-5a1 1 0 0 0-1-1h-5z"/>
                    </svg>
                </div>
                <div class="sidebar-item-text">Connections</div>
                <div class="sidebar-item-badge">Beta</div>
            </div>
            
            <div class="sidebar-divider"></div>
            
            <div class="sidebar-item" id="login-btn">
                <div class="sidebar-item-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                    </svg>
                </div>
                <div class="sidebar-item-text">Sign In</div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="logo">
                    <button class="sidebar-toggle" id="sidebar-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                    </button>
                    <h1>Nexora</h1>
                </div>
                <div class="header-actions">
                    <div class="theme-toggle" id="theme-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="sun-icon">
                            <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="moon-icon">
                            <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chat-container">
                <div class="empty-chat-container" id="empty-chat-container">
                    <div class="empty-chat-logo">
                        <img src="Nexora.png" alt="Nexora Logo">
                    </div>
                    <h1 class="empty-chat-title">Nexora</h1>
                    <p class="empty-chat-description">How can I help you today?</p>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <!-- Chat messages will be added here -->
                </div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <input type="text" id="user-input" placeholder="Ask Nexora something..." autocomplete="off">
                        <div class="input-buttons">
                            <button id="regenerate-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                                    <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                                </svg>
                            </button>
                            <button id="stop-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                                </svg>
                            </button>
                            <button id="send-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Search Modal -->
    <div class="modal-overlay" id="search-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Search Messages</h2>
                <button class="modal-close" id="search-modal-close">×</button>
            </div>
            <div class="modal-content">
                <input type="text" class="search-input" id="search-input" placeholder="Type to search messages...">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
    </div>

    <!-- Libraries Modal -->
    <div class="modal-overlay" id="libraries-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Libraries</h2>
                <button class="modal-close" id="libraries-modal-close">×</button>
            </div>
            <div class="modal-content">
                <div class="content-section">
                    <p class="content-description">Access pre-built libraries to enhance your AI experience.</p>
                    <div class="content-grid">
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                    <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/>
                                    <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Knowledge Base</div>
                            <div class="content-card-description">Access scientific papers and research</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                    <path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0zm2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Code Library</div>
                            <div class="content-card-description">Programming examples and snippets</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">3D Models</div>
                            <div class="content-card-description">Pre-built 3D assets and models</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Verified Data</div>
                            <div class="content-card-description">Curated and fact-checked information</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5c0 .538-.012 1.05-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33.076 33.076 0 0 1 2.5.5zm.099 2.54a2 2 0 0 0 .72 3.935c-.333-1.05-.588-2.346-.72-3.935zm10.083 3.935a2 2 0 0 0 .72-3.935c-.133 1.59-.388 2.885-.72 3.935zM3.504 1c.007.517.026 1.006.056 1.469.13 2.028.457 3.546.87 4.667C5.294 9.48 6.484 10 7 10a.5.5 0 0 1 .5.5v2.61a1 1 0 0 1-.757.97l-1.426.356a.5.5 0 0 0-.179.085L4.5 15h7l-.638-.479a.501.501 0 0 0-.18-.085l-1.425-.356a1 1 0 0 1-.757-.97V10.5A.5.5 0 0 1 9 10c.516 0 1.706-.52 2.57-2.864.413-1.12.74-2.64.87-4.667.03-.463.049-.952.056-1.469H3.504z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Prompt Templates</div>
                            <div class="content-card-description">Pre-designed prompts for better results</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Documentation</div>
                            <div class="content-card-description">Guides and tutorials for Nexora</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connections Modal -->
    <div class="modal-overlay" id="connections-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Connections</h2>
                <button class="modal-close" id="connections-modal-close">×</button>
            </div>
            <div class="modal-content">
                <div class="content-section">
                    <p class="content-description">Connect Nexora to your favorite services and data sources.</p>
                    <div class="content-grid">
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M13.5 3a.5.5 0 0 1 .5.5V11H2V3.5a.5.5 0 0 1 .5-.5h11zm-11-1A1.5 1.5 0 0 0 1 3.5V12h14V3.5A1.5 1.5 0 0 0 13.5 2h-11zM0 12.5h16a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 12.5z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Google Drive</div>
                            <div class="content-card-description">Access your documents and files</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Email</div>
                            <div class="content-card-description">Connect to your email accounts</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Cloud Storage</div>
                            <div class="content-card-description">Connect to Dropbox, OneDrive, etc.</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                    <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Slack</div>
                            <div class="content-card-description">Connect to your Slack workspace</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
                                    <path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5L9.5 0zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Notion</div>
                            <div class="content-card-description">Connect to your Notion workspace</div>
                        </div>
                        <div class="content-card">
                            <div class="content-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M1.333 2.667C1.333 1.194 4.318 0 8 0s6.667 1.194 6.667 2.667V4c0 1.473-2.985 2.667-6.667 2.667S1.333 5.473 1.333 4V2.667z"/>
                                    <path d="M1.333 6.334v3C1.333 10.805 4.318 12 8 12s6.667-1.194 6.667-2.667V6.334a6.51 6.51 0 0 1-1.458.79C11.81 7.684 9.967 8 8 8c-1.966 0-3.809-.317-5.208-.876a6.508 6.508 0 0 1-1.458-.79z"/>
                                    <path d="M14.667 11.668a6.51 6.51 0 0 1-1.458.789c-1.4.56-3.242.876-5.21.876-1.966 0-3.809-.316-5.208-.876a6.51 6.51 0 0 1-1.458-.79v1.666C1.333 14.806 4.318 16 8 16s6.667-1.194 6.667-2.667v-1.665z"/>
                                </svg>
                            </div>
                            <div class="content-card-title">Database</div>
                            <div class="content-card-description">Connect to SQL, MongoDB, etc.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login popup -->
    <div class="popup-overlay" id="login-popup">
        <div class="popup-container">
            <button class="popup-close" id="popup-close">×</button>
            <h2 class="popup-title">Sign in to Nexora Cognitia</h2>
            <p class="popup-content" id="popup-message">You have 1 credit left to chat anonymously. Sign in to experience Nexora Cognitia with unlimited access.</p>
            <button class="popup-button" id="google-signin-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
                    <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                    <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
                    <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Logout confirmation modal -->
    <div class="popup-overlay" id="logout-popup">
        <div class="popup-container logout-modal">
            <h2 class="logout-modal-title">Sign Out</h2>
            <p class="logout-modal-content">Are you sure you want to sign out? Your conversations will remain saved to your account.</p>
            <div class="logout-modal-buttons">
                <button class="logout-modal-button cancel" id="logout-cancel">Cancel</button>
                <button class="logout-modal-button confirm" id="logout-confirm">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyD9rh3soAgWPAPO8o5OVRAQc7t_VHSAvbU",
                authDomain: "nexora-8b146.firebaseapp.com",
                projectId: "nexora-8b146",
                storageBucket: "nexora-8b146.firebasestorage.app",
                messagingSenderId: "383585586026",
                appId: "1:383585586026:web:6948e25da92bf620b53313",
                measurementId: "G-C3NS5QBJM5"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const analytics = firebase.analytics();

            // DOM Elements
            const appContainer = document.getElementById('app-container');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const stopButton = document.getElementById('stop-button');
            const regenerateButton = document.getElementById('regenerate-button');
            const themeToggle = document.getElementById('theme-toggle');
            const emptyChat = document.getElementById('empty-chat-container');
            const loginBtn = document.getElementById('login-btn');
            const loginPopup = document.getElementById('login-popup');
            const logoutPopup = document.getElementById('logout-popup');
            const logoutCancel = document.getElementById('logout-cancel');
            const logoutConfirm = document.getElementById('logout-confirm');
            const googleSignInBtn = document.getElementById('google-signin-btn');
            const userDisplayName = document.getElementById('user-display-name');
            const userStatus = document.getElementById('user-status');
            const userProfilePic = document.getElementById('user-profile-pic');
            const conversationsContainer = document.getElementById('conversations-container');
            const newChatBtn = document.getElementById('new-chat-btn');
            const searchBtn = document.getElementById('search-btn');
            const searchModal = document.getElementById('search-modal');
            const searchModalClose = document.getElementById('search-modal-close');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const librariesBtn = document.getElementById('libraries-btn');
            const librariesModal = document.getElementById('libraries-modal');
            const librariesModalClose = document.getElementById('libraries-modal-close');
            const connectionsBtn = document.getElementById('connections-btn');
            const connectionsModal = document.getElementById('connections-modal');
            const connectionsModalClose = document.getElementById('connections-modal-close');
            const popupMessage = document.getElementById('popup-message');
            const popupClose = document.getElementById('popup-close');
            const toast = document.getElementById('toast');
            
            // App state
            let isGenerating = false;
            let shouldStop = false;
            let currentMessageElement = null;
            let typingSpeed = 30; // Default typing speed in ms
            let currentUser = null;
            let anonymousPromptCount = 0;
            let currentConversationId = null;
            let conversations = [];
            let anonymousAuthEnabled = true; // Will be set to false if anonymous auth fails
            let lastUserMessage = ''; // Store the last user message for regeneration
            let allMessages = []; // Store all messages for search functionality
            let initialPrompt = ''; // Store the initial prompt for title change

            // Update document title based on initial prompt
            function updateDocumentTitle(prompt) {
                if (prompt && prompt.length > 0) {
                    // Limit title length
                    const titleText = prompt.length > 30 ? prompt.substring(0, 30) + '...' : prompt;
                    document.title = `${titleText} - Nexora`;
                } else {
                    document.title = 'Nexora - AI Chatbot';
                }
            }

            // Sidebar toggle functionality
            function toggleSidebar() {
                if (window.innerWidth < 769) {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                } else {
                    appContainer.classList.toggle('sidebar-expanded');
                }
            }

            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // Initialize sidebar state based on screen size
            function initSidebar() {
                if (window.innerWidth >= 769) {
                    appContainer.classList.add('sidebar-expanded');
                }
            }

            // Call on load
            initSidebar();

            // Update on resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 769) {
                    sidebarOverlay.classList.remove('active');
                    sidebar.classList.remove('active');
                } else {
                    appContainer.classList.remove('sidebar-expanded');
                }
            });

            // Theme toggle functionality
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });

            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }

            // Toast notification
            function showToast(message, duration = 3000) {
                toast.textContent = message;
                toast.classList.add('active');
                
                setTimeout(() => {
                    toast.classList.remove('active');
                }, duration);
            }

            // Authentication state observer
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                
                if (user) {
                    // User is signed in
                    if (!user.isAnonymous) {
                        // Update UI for signed-in user
                        userDisplayName.textContent = user.displayName || 'User';
                        userStatus.textContent = 'Free Planning';
                        
                        if (user.photoURL) {
                            userProfilePic.src = user.photoURL;
                        } else {
                            userProfilePic.src = 'Nexora.png';
                        }
                        
                        loginBtn.querySelector('.sidebar-item-text').textContent = 'Sign Out';
                        
                        // Load user's conversations
                        loadConversations();
                    }
                } else {
                    // User is signed out, try to proceed without authentication
                    userDisplayName.textContent = 'Nexora';
                    userStatus.textContent = 'Free Planning';
                    userProfilePic.src = 'Nexora.png';
                    loginBtn.querySelector('.sidebar-item-text').textContent = 'Sign In';
                    
                    // Clear conversations
                    conversationsContainer.innerHTML = '';
                    
                    // Try anonymous auth if needed for features, but don't block the app
                    if (anonymousAuthEnabled) {
                        auth.signInAnonymously()
                            .catch((error) => {
                                console.error('Anonymous auth error:', error);
                                anonymousAuthEnabled = false;
                                // Continue without anonymous auth
                            });
                    }
                }
            });

            // Google Sign In
            googleSignInBtn.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                
                auth.signInWithPopup(provider)
                    .then((result) => {
                        // Close the popup
                        loginPopup.classList.remove('active');
                        
                        // If user was anonymous before, transfer their conversation
                        if (currentConversationId && auth.currentUser && auth.currentUser.isAnonymous) {
                            transferAnonymousConversation(currentConversationId, result.user.uid);
                        }
                        
                        showToast('Successfully signed in!');
                    })
                    .catch((error) => {
                        console.error('Google sign in error:', error);
                        
                        // Show a helpful error message
                        if (error.code === 'auth/unauthorized-domain') {
                            showToast('This domain is not authorized for OAuth operations.');
                        } else {
                            showToast('Error signing in: ' + error.message);
                        }
                    });
            });

            // Close popup when clicking the X
            popupClose.addEventListener('click', () => {
                loginPopup.classList.remove('active');
            });

            // Login button click handler
            loginBtn.addEventListener('click', () => {
                if (currentUser && !currentUser.isAnonymous) {
                    // Show logout confirmation
                    logoutPopup.classList.add('active');
                } else {
                    // Show login popup
                    popupMessage.textContent = 'Sign in to experience Nexora Cognitia with unlimited access.';
                    loginPopup.classList.add('active');
                }
            });

            // Logout confirmation handlers
            logoutCancel.addEventListener('click', () => {
                logoutPopup.classList.remove('active');
            });

            logoutConfirm.addEventListener('click', () => {
                // Sign out
                auth.signOut()
                    .then(() => {
                        logoutPopup.classList.remove('active');
                        showToast('Successfully signed out');
                        console.log('User signed out');
                    })
                    .catch((error) => {
                        console.error('Sign out error:', error);
                        showToast('Error signing out');
                    });
            });

            // Close popup when clicking outside
            loginPopup.addEventListener('click', (e) => {
                if (e.target === loginPopup) {
                    loginPopup.classList.remove('active');
                }
            });

            logoutPopup.addEventListener('click', (e) => {
                if (e.target === logoutPopup) {
                    logoutPopup.classList.remove('active');
                }
            });

            // Modal handlers
            searchBtn.addEventListener('click', () => {
                searchModal.classList.add('active');
                searchInput.focus();
            });

            searchModalClose.addEventListener('click', () => {
                searchModal.classList.remove('active');
            });

            librariesBtn.addEventListener('click', () => {
                librariesModal.classList.add('active');
            });

            librariesModalClose.addEventListener('click', () => {
                librariesModal.classList.remove('active');
            });

            connectionsBtn.addEventListener('click', () => {
                connectionsModal.classList.add('active');
            });

            connectionsModalClose.addEventListener('click', () => {
                connectionsModal.classList.remove('active');
            });

            // Close modals when clicking outside
            searchModal.addEventListener('click', (e) => {
                if (e.target === searchModal) {
                    searchModal.classList.remove('active');
                }
            });

            librariesModal.addEventListener('click', (e) => {
                if (e.target === librariesModal) {
                    librariesModal.classList.remove('active');
                }
            });

            connectionsModal.addEventListener('click', (e) => {
                if (e.target === connectionsModal) {
                    connectionsModal.classList.remove('active');
                }
            });

            // Load user's conversations from Firestore
            function loadConversations() {
                if (!currentUser || currentUser.isAnonymous) return;
                
                db.collection('conversations')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('updatedAt', 'desc')
                    .limit(20)
                    .get()
                    .then((querySnapshot) => {
                        conversations = [];
                        conversationsContainer.innerHTML = '';
                        
                        querySnapshot.forEach((doc) => {
                            const conversation = doc.data();
                            conversation.id = doc.id;
                            conversations.push(conversation);
                            
                            // Create conversation item in sidebar
                            addConversationToSidebar(conversation);
                        });
                    })
                    .catch((error) => {
                        console.error('Error loading conversations:', error);
                        showToast('Error loading conversations');
                    });
            }

            // Add conversation to sidebar
            function addConversationToSidebar(conversation) {
                const conversationItem = document.createElement('div');
                conversationItem.className = 'conversation-item';
                conversationItem.dataset.id = conversation.id;
                
                if (conversation.id === currentConversationId) {
                    conversationItem.classList.add('active');
                }
const date = conversation.updatedAt.toDate();              const formattedDate = date.toLocaleDateString();
                
                conversationItem.innerHTML = `
                    <div class="conversation-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                            <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                        </svg>
                    </div>
                    <div class="conversation-title">${conversation.title || 'New Conversation'}</div>
                    <div class="conversation-date">${formattedDate}</div>
                `;
                
                conversationItem.addEventListener('click', () => {
                    loadConversation(conversation.id);
                });
                
                conversationsContainer.appendChild(conversationItem);
            }

            // Load a specific conversation
            function loadConversation(conversationId) {
                if (!conversationId) return;
                
                currentConversationId = conversationId;
                
                // Update active state in sidebar
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.id === conversationId) {
                        item.classList.add('active');
                    }
                });
                
                // Clear current chat
                chatMessages.innerHTML = '';
                emptyChat.classList.add('hidden');
                allMessages = []; // Clear stored messages
                
                // Load messages from Firestore
                db.collection('conversations').doc(conversationId)
                    .collection('messages')
                    .orderBy('timestamp')
                    .get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            const message = doc.data();
                            
                            if (message.role === 'USER') {
                                addMessageToChat('user', message.content, false);
                                // Store for search functionality
                                allMessages.push({
                                    role: 'user',
                                    content: message.content,
                                    timestamp: message.timestamp
                                });
                                
                                // Update last user message for regeneration
                                lastUserMessage = message.content;
                                
                                // Update title if this is the first message
                                if (allMessages.length === 1) {
                                    initialPrompt = message.content;
                                    updateDocumentTitle(initialPrompt);
                                }
                            } else if (message.role === 'CHATBOT') {
                                addMessageToChat('bot', message.content, false);
                                // Store for search functionality
                                allMessages.push({
                                    role: 'bot',
                                    content: message.content,
                                    timestamp: message.timestamp
                                });
                            }
                        });
                        
                        // Scroll to bottom
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    })
                    .catch((error) => {
                        console.error('Error loading messages:', error);
                        showToast('Error loading conversation');
                    });
            }

            // Create a new conversation
            function createNewConversation(firstMessage) {
                const userId = currentUser ? currentUser.uid : null;
                const isAnonymous = currentUser ? currentUser.isAnonymous : true;
                
                const conversationData = {
                    userId: userId,
                    isAnonymous: isAnonymous,
                    title: firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                return db.collection('conversations').add(conversationData)
                    .then((docRef) => {
                        currentConversationId = docRef.id;
                        
                        // Add to conversations array and sidebar if user is signed in
                        if (userId && !isAnonymous) {
                            const conversation = {
                                ...conversationData,
                                id: docRef.id
                            };
                            conversations.unshift(conversation);
                            addConversationToSidebar(conversation);
                        }
                        
                        return docRef.id;
                    });
            }

            // Add message to Firestore
            function saveMessageToFirestore(conversationId, role, content) {
                if (!conversationId || !currentUser) return Promise.resolve(); // Skip if no conversation ID or user
                
                const messageData = {
                    role: role,
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                return db.collection('conversations').doc(conversationId)
                    .collection('messages').add(messageData)
                    .then(() => {
                        // Update conversation timestamp
                        return db.collection('conversations').doc(conversationId)
                            .update({
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                    });
            }

            // Transfer anonymous conversation to signed-in user
            function transferAnonymousConversation(conversationId, newUserId) {
                db.collection('conversations').doc(conversationId)
                    .update({
                        userId: newUserId,
                        isAnonymous: false
                    })
                    .then(() => {
                        console.log('Conversation transferred to signed-in user');
                    })
                    .catch((error) => {
                        console.error('Error transferring conversation:', error);
                    });
            }

            // New chat button
            newChatBtn.addEventListener('click', () => {
                // Clear current chat
                chatMessages.innerHTML = '';
                emptyChat.classList.remove('hidden');
                currentConversationId = null;
                lastUserMessage = '';
                allMessages = [];
                initialPrompt = '';
                updateDocumentTitle('');
                
                // Update active state in sidebar
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                newChatBtn.classList.add('active');
                regenerateButton.classList.remove('visible');
            });

            // Search functionality
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim().toLowerCase();
                searchResults.innerHTML = '';
                
                if (query.length < 2) return;
                
                // Search through all messages
                const results = allMessages.filter(msg => 
                    msg.content.toLowerCase().includes(query)
                );
                
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                    return;
                }
                
                results.forEach((result, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    // Highlight the matching text
                    let content = result.content;
                    const queryRegex = new RegExp(`(${query})`, 'gi');
                    content = content.replace(queryRegex, '<span class="search-highlight">$1</span>');
                    
                    // Truncate long messages
                    if (content.length > 100) {
                        const startIndex = content.toLowerCase().indexOf(query.toLowerCase());
                        const startPos = Math.max(0, startIndex - 40);
                        content = (startPos > 0 ? '...' : '') + 
                                 content.substring(startPos, startPos + 100) + 
                                 (content.length > startPos + 100 ? '...' : '');
                    }
                    
                    resultItem.innerHTML = `
                        <strong>${result.role === 'user' ? 'You' : 'Nexora'}:</strong> ${content}
                    `;
                    
                    // Scroll to the message when clicked
                    resultItem.addEventListener('click', () => {
                        // Find the message in the chat
                        const messages = chatMessages.querySelectorAll('.message');
                        let targetMessage = null;
                        
                        for (let i = 0; i < messages.length; i++) {
                            const messageContent = messages[i].querySelector('.message-content');
                            if (messageContent.textContent.includes(result.content.substring(0, 30))) {
                                targetMessage = messages[i];
                                break;
                            }
                        }
                        
                        if (targetMessage) {
                            // Scroll to the message
                            targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Highlight the message briefly
                            targetMessage.style.backgroundColor = 'rgba(var(--primary-color-rgb), 0.1)';
                            setTimeout(() => {
                                targetMessage.style.backgroundColor = '';
                            }, 2000);
                            
                            // Close search modal
                            searchModal.classList.remove('active');
                        }
                    });
                    
                    searchResults.appendChild(resultItem);
                });
            });

            // Handle user message
            sendButton.addEventListener('click', handleUserMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleUserMessage();
            });
            
            // Stop button functionality
            stopButton.addEventListener('click', () => {
                if (isGenerating) {
                    shouldStop = true;
                    stopButton.classList.remove('visible');
                    sendButton.style.display = 'flex';
                    regenerateButton.classList.add('visible');
                    
                    // Add cursor at the end of the current message
                    if (currentMessageElement) {
                        const cursor = document.createElement('span');
                        cursor.className = 'cursor';
                        currentMessageElement.appendChild(cursor);
                    }
                }
            });
            
            // Regenerate button functionality
            regenerateButton.addEventListener('click', () => {
                if (isGenerating) return;
                
                if (lastUserMessage) {
                    // Remove the last bot message
                    const messages = chatMessages.querySelectorAll('.message');
                    if (messages.length > 0) {
                        const lastMessage = messages[messages.length - 1];
                        if (lastMessage.classList.contains('bot-message')) {
                            lastMessage.remove();
                            
                            // Also remove from Firestore if possible
                            if (currentConversationId) {
                                db.collection('conversations').doc(currentConversationId)
                                    .collection('messages')
                                    .orderBy('timestamp', 'desc')
                                    .limit(1)
                                    .get()
                                    .then((querySnapshot) => {
                                        querySnapshot.forEach((doc) => {
                                            if (doc.data().role === 'CHATBOT') {
                                                doc.ref.delete();
                                            }
                                        });
                                    })
                                    .catch(error => console.error('Error deleting message:', error));
                            }
                        }
                    }
                    
                    // Get a new response
                    getBotResponse(lastUserMessage);
                    regenerateButton.classList.remove('visible');
                } else {
                    showToast('No previous message to regenerate');
                }
            });

            async function handleUserMessage() {
                const message = userInput.value.trim();
                if (!message || isGenerating) return;

                // Hide regenerate button
                regenerateButton.classList.remove('visible');
                
                // Store for regeneration
                lastUserMessage = message;

                // Check if user is anonymous and has reached the limit
                if (currentUser && currentUser.isAnonymous) {
                    anonymousPromptCount++;
                    
                    // Show warning after 5th prompt
                    if (anonymousPromptCount === 5) {
                        popupMessage.textContent = 'You have 1 credit left to chat anonymously. Sign in to experience Nexora Cognitia with unlimited access.';
                        loginPopup.classList.add('active');
                    }
                    
                    // Block after 6th prompt
                    if (anonymousPromptCount > 6) {
                        popupMessage.textContent = 'You have used all your anonymous credits. Please sign in to continue using Nexora Cognitia.';
                        loginPopup.classList.add('active');
                        return;
                    }
                } else if (!currentUser && anonymousPromptCount >= 6) {
                    // Handle case where anonymous auth failed but we still want to limit
                    popupMessage.textContent = 'You have used all your anonymous credits. Please sign in to continue using Nexora Cognitia.';
                    loginPopup.classList.add('active');
                    return;
                }

                // Count prompts even if not authenticated
                if (!currentUser) {
                    anonymousPromptCount++;
                    
                    // Show warning after 5th prompt
                    if (anonymousPromptCount === 5) {
                        popupMessage.textContent = 'You have 1 credit left to chat anonymously. Sign in to experience Nexora Cognitia with unlimited access.';
                        loginPopup.classList.add('active');
                    }
                }

                // Hide empty chat screen on first message
                if (emptyChat && !emptyChat.classList.contains('hidden')) {
                    emptyChat.classList.add('hidden');
                }

                // If this is the first message, update the title and store initial prompt
                if (allMessages.length === 0) {
                    initialPrompt = message;
                    updateDocumentTitle(initialPrompt);
                }

                // Create new conversation if needed and if we can
                if (!currentConversationId && currentUser) {
                    try {
                        await createNewConversation(message);
                    } catch (error) {
                        console.error('Error creating conversation:', error);
                        showToast('Error creating conversation');
                    }
                }

                // Add message to UI
                addMessageToChat('user', message);
                userInput.value = '';
                
                // Store for search functionality
                allMessages.push({
                    role: 'user',
                    content: message,
                    timestamp: new Date()
                });
                
                // Save message to Firestore if possible
                if (currentConversationId && currentUser) {
                    saveMessageToFirestore(currentConversationId, 'USER', message)
                        .catch(error => console.error('Error saving message:', error));
                }
                
                // Get bot response
                getBotResponse(message);
            }

            function addMessageToChat(sender, message, animate = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;

                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                if (sender === 'user') {
                    avatar.classList.add('user-avatar-chat');
                    
                    if (currentUser && !currentUser.isAnonymous && currentUser.photoURL) {
                        const img = document.createElement('img');
                        img.src = currentUser.photoURL;
                        img.alt = currentUser.displayName || 'User';
                        avatar.innerHTML = '';
                        avatar.appendChild(img);
                    } else {
                        avatar.textContent = 'U';
                    }
                } else {
                    const img = document.createElement('img');
                    img.src = 'Nexora.png';
                    img.alt = 'Nexora';
                    avatar.appendChild(img);
                }

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                if (sender === 'user') {
                    // Add message actions for user messages
                    const messageActions = document.createElement('div');
                    messageActions.className = 'message-actions';
                    messageActions.innerHTML = `
                        <button class="message-action-btn copy-btn" title="Copy message">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                        </button>
                    `;
                    
                    messageDiv.appendChild(messageContent);
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(messageActions);
                    
                    // For user messages, display immediately
                    if (message.includes('\`\`\`')) {
                        let parts = message.split('\`\`\`');
                        let formattedMessage = '';
                        for (let i = 0; i < parts.length; i++) {
                            formattedMessage += i % 2 === 0 ? parts[i] : `<pre><code>${parts[i]}</code></pre>`;
                        }
                        messageContent.innerHTML = formattedMessage;
                    } else {
                        messageContent.innerHTML = message.replace(/\n/g, '<br>');
                    }
                    
                    // Add copy functionality
                    messageDiv.querySelector('.copy-btn').addEventListener('click', () => {
                        navigator.clipboard.writeText(message)
                            .then(() => {
                                showToast('Message copied to clipboard');
                            })
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                showToast('Failed to copy message');
                            });
                    });
                } else {
                    // Add message actions for bot messages
                    const messageActions = document.createElement('div');
                    messageActions.className = 'message-actions';
                    messageActions.innerHTML = `
                        <button class="message-action-btn copy-btn" title="Copy response">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                        </button>
                    `;
                    
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(messageContent);
                    messageDiv.appendChild(messageActions);
                    
                    if (animate) {
                        // For bot messages, add thinking dots first
                        const thinkingDots = document.createElement('div');
                        thinkingDots.className = 'thinking-dots';
                        for (let i = 0; i < 3; i++) {
                            const dot = document.createElement('div');
                            dot.className = 'dot';
                            thinkingDots.appendChild(dot);
                        }
                        messageContent.appendChild(thinkingDots);
                    } else {
                        // For loaded messages, display immediately with keyword highlighting
                        if (message.includes('\`\`\`')) {
                            let parts = message.split('\`\`\`');
                            let formattedMessage = '';
                            for (let i = 0; i < parts.length; i++) {
                                if (i % 2 === 0) {
                                    // Apply keyword highlighting to regular text
                                    formattedMessage += highlightKeywords(parts[i]);
                                } else {
                                    formattedMessage += `<pre><code>${parts[i]}</code></pre>`;
                                }
                            }
                            messageContent.innerHTML = formattedMessage;
                        } else {
                            // Apply keyword highlighting
                            messageContent.innerHTML = highlightKeywords(message);
                        }
                        
                        // Add copy functionality
                        messageDiv.querySelector('.copy-btn').addEventListener('click', () => {
                            navigator.clipboard.writeText(message)
                                .then(() => {
                                    showToast('Response copied to clipboard');
                                })
                                .catch(err => {
                                    console.error('Could not copy text: ', err);
                                    showToast('Failed to copy response');
                                });
                        });
                    }
                }
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                return messageContent;
            }

            // Function to highlight keywords in bot responses
            function highlightKeywords(text) {
                // List of keywords to highlight (can be expanded)
                const keywords = [
                    'AI', 'machine learning', 'neural network', 'algorithm', 'data', 
                    'analysis', 'processing', 'intelligence', 'model', 'training',
                    'Nexora', 'chatbot', 'assistant', 'help', 'support', 'information',
                    'important', 'critical', 'essential', 'key', 'significant', 'vital',
                    'recommend', 'suggest', 'advise', 'consider', 'note', 'remember',
                    'feature', 'function', 'capability', 'integration', 'connection',
                    'security', 'privacy', 'encryption', 'protected', 'confidential'
                ];
                
                // Replace newlines with <br> tags
                let formattedText = text.replace(/\n/g, '<br>');
                
                // Highlight each keyword
                keywords.forEach(keyword => {
                    const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
                    formattedText = formattedText.replace(regex, '<span class="keyword">$1</span>');
                });
                
                return formattedText;
            }

            // Function to type out message word by word
            async function typeMessage(element, message) {
                if (!element) return; // Guard against null element
                
                isGenerating = true;
                shouldStop = false;
                sendButton.style.display = 'none';
                stopButton.classList.add('visible');
                
                // Clear thinking dots
                element.innerHTML = '';
                
                // Check if message contains code blocks
                if (message.includes('\`\`\`')) {
                    let parts = message.split('\`\`\`');
                    for (let i = 0; i < parts.length; i++) {
                        if (i % 2 === 0) {
                            // Regular text with keyword highlighting
                            await typeTextWordByWord(element, parts[i], true);
                        } else {
                            // Code block
                            if (shouldStop) break;
                            const pre = document.createElement('pre');
                            const code = document.createElement('code');
                            pre.appendChild(code);
                            element.appendChild(pre);
                            await typeTextWordByWord(code, parts[i], false);
                        }
                    }
                } else {
                    // Regular text with keyword highlighting
                    await typeTextWordByWord(element, message, true);
                }
                
                // Add cursor at the end
                const cursor = document.createElement('span');
                cursor.className = 'cursor';
                element.appendChild(cursor);
                
                isGenerating = false;
                stopButton.classList.remove('visible');
                sendButton.style.display = 'flex';
                regenerateButton.classList.add('visible');
                
                // Add copy functionality to the message
                const messageDiv = element.closest('.message');
                if (messageDiv) {
                    const copyBtn = messageDiv.querySelector('.copy-btn');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', () => {
                            navigator.clipboard.writeText(message)
                                .then(() => {
                                    showToast('Response copied to clipboard');
                                })
                                .catch(err => {
                                    console.error('Could not copy text: ', err);
                                    showToast('Failed to copy response');
                                });
                        });
                    }
                }
            }
            
            // Function to type text word by word
            async function typeTextWordByWord(element, text, highlightKeywords = false) {
                if (!element) return; // Guard against null element
                
                // List of keywords to highlight
                const keywords = [
                    'AI', 'machine learning', 'neural network', 'algorithm', 'data', 
                    'analysis', 'processing', 'intelligence', 'model', 'training',
                    'Nexora', 'chatbot', 'assistant', 'help', 'support', 'information',
                    'important', 'critical', 'essential', 'key', 'significant', 'vital',
                    'recommend', 'suggest', 'advise', 'consider', 'note', 'remember',
                    'feature', 'function', 'capability', 'integration', 'connection',
                    'security', 'privacy', 'encryption', 'protected', 'confidential'
                ];
                
                const words = text.split(' ');
                for (let i = 0; i < words.length; i++) {
                    if (shouldStop) break;
                    
                    const word = words[i];
                    
                    // Handle newlines
                    if (word.includes('\n')) {
                        const parts = word.split('\n');
                        for (let j = 0; j < parts.length; j++) {
                            if (j > 0) {
                                element.appendChild(document.createElement('br'));
                            }
                            if (parts[j].length > 0) {
                                const partSpan = document.createElement('span');
                                
                                // Check if this word should be highlighted
                                if (highlightKeywords && keywords.some(keyword => 
                                    keyword.toLowerCase() === parts[j].toLowerCase() ||
                                    keyword.toLowerCase() === parts[j].toLowerCase().replace(/[.,!?;:]/g, '')
                                )) {
                                    partSpan.className = 'keyword';
                                }
                                
                                partSpan.textContent = parts[j];
                                element.appendChild(partSpan);
                                if (j < parts.length - 1 || i < words.length - 1) {
                                    element.appendChild(document.createTextNode(' '));
                                }
                            }
                        }
                    } else {
                        const wordSpan = document.createElement('span');
                        
                        // Check if this word should be highlighted
                        if (highlightKeywords && keywords.some(keyword => 
                            keyword.toLowerCase() === word.toLowerCase() ||
                            keyword.toLowerCase() === word.toLowerCase().replace(/[.,!?;:]/g, '')
                        )) {
                            wordSpan.className = 'keyword';
                        }
                        
                        wordSpan.textContent = word;
                        element.appendChild(wordSpan);
                        if (i < words.length - 1) {
                            element.appendChild(document.createTextNode(' '));
                        }
                    }
                    
                    // Adjust typing speed based on "network speed"
                    // In a real app, you'd measure actual network latency
                    const networkQuality = Math.random(); // Simulate network quality (0-1)
                    const adjustedSpeed = Math.max(10, Math.min(100, typingSpeed * (1 + (1 - networkQuality))));
                    
                    await new Promise(resolve => setTimeout(resolve, adjustedSpeed));
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }

            async function getBotResponse(userMessage) {
                try {
                    console.log('Sending request to backend:', {
                        message: userMessage,
                        chat_history: []
                    });
                    
                    // Show stop button while waiting for response
                    stopButton.classList.add('visible');
                    sendButton.style.display = 'none';
                    
                    // Create bot message with thinking dots
                    const botMessageContent = addMessageToChat('bot', '');
                    currentMessageElement = botMessageContent;
                    
                    const response = await fetch('https://nexora-backend-1.onrender.com/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            chat_history: [],
                            model: 'command',
                            connectors: []
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Backend error:', response.status, errorText);
                        await typeMessage(botMessageContent, `Error: Server returned status ${response.status}. Please try again later.`);
                        return;
                    }

                    const data = await response.json();
                    console.log('Backend response:', data);

                    if (data && data.text) {
                        await typeMessage(botMessageContent, data.text);
                        
                        // Store for search functionality
                        allMessages.push({
                            role: 'bot',
                            content: data.text,
                            timestamp: new Date()
                        });
                        
                        // Save bot response to Firestore
                        if (currentConversationId) {
                            saveMessageToFirestore(currentConversationId, 'CHATBOT', data.text)
                                .catch(error => console.error('Error saving bot message:', error));
                        }
                    } else {
                        console.error('No valid text in response:', data);
                        await typeMessage(botMessageContent, "I'm sorry, I couldn't process your request. Please try again.");
                    }
                } catch (error) {
                    console.error('Fetch error:', error.message);
                    if (currentMessageElement) {
                        await typeMessage(currentMessageElement, "I'm having trouble connecting to the server. Please check your internet or try again later.");
                    }
                } finally {
                    stopButton.classList.remove('visible');
                    sendButton.style.display = 'flex';
                    regenerateButton.classList.add('visible');
                }
            }
            
            // Measure network speed to adjust typing speed
            function measureNetworkSpeed() {
                const startTime = Date.now();
                fetch('https://nexora-backend-1.onrender.com/api/ping', { 
                    method: 'GET',
                    cache: 'no-store'
                })
                .then(() => {
                    const endTime = Date.now();
                    const latency = endTime - startTime;
                    // Adjust typing speed based on latency
                    // Lower latency = faster typing
                    typingSpeed = Math.max(10, Math.min(80, 20 + latency / 10));
                    console.log(`Network latency: ${latency}ms, Typing speed: ${typingSpeed}ms`);
                })
                .catch(err => {
                    console.error('Error measuring network speed:', err);
                    // Default to medium speed if measurement fails
                    typingSpeed = 30;
                });
            }
            
            // Measure network speed on load and periodically
            measureNetworkSpeed();
            setInterval(measureNetworkSpeed, 60000); // Check every minute
        });
    </script>
</body>
</html>
