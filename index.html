<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexora - AI Chatbot</title>
    <link rel="icon" href="Nexora.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --text-color: #333;
            --light-text: #f8f9fa;
            --bg-color: #f8f9fa;
            --chat-bg: #ffffff;
            --message-user-bg: linear-gradient(to right, #6a11cb, #2575fc);
            --message-bot-bg: #f8f9fa;
            --border-color: #dee2e6;
            --input-bg: #ffffff;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --sidebar-bg: #f8f9fa;
            --sidebar-text: #333;
            --sidebar-hover: #e9ecef;
            --sidebar-overlay: rgba(0, 0, 0, 0.5);
            --toast-bg: rgba(0, 0, 0, 0.8);
            --toast-text: #fff;
            --search-highlight: #ffeb3b;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --keyword-highlight: #6a11cb;
            --credit-bar-bg: #e9ecef;
            --credit-bar-fill: linear-gradient(to right, #6a11cb, #2575fc);
            --credit-warning: #ff4757;
        }

        [data-theme="dark"] {
            --primary-color: #8a2be2;
            --secondary-color: #4169e1;
            --text-color: #e9ecef;
            --light-text: #f8f9fa;
            --bg-color: #121212;
            --chat-bg: #1e1e2d;
            --message-user-bg: linear-gradient(to right, #8a2be2, #4169e1);
            --message-bot-bg: #2a2a3c;
            --border-color: #2a2a3c;
            --input-bg: #2a2a3c;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --sidebar-bg: #1e1e2d;
            --sidebar-text: #a3a3b5;
            --sidebar-hover: #2a2a3c;
            --sidebar-overlay: rgba(0, 0, 0, 0.7);
            --toast-bg: rgba(255, 255, 255, 0.8);
            --toast-text: #000;
            --search-highlight: #ffd700;
            --modal-bg: rgba(0, 0, 0, 0.8);
            --keyword-highlight: #8a2be2;
            --credit-bar-bg: #2a2a3c;
            --credit-bar-fill: linear-gradient(to right, #8a2be2, #4169e1);
            --credit-warning: #ff4757;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .sidebar-toggle {
            background: transparent;
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--sidebar-overlay);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, background-color 0.3s, color 0.3s;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1001;
            border-radius: 0 20px 20px 0;
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('Corea.png');
            background-size: 1000px;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.2;
            z-index: -1;
            border-radius: 0 20px 20px 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-color);
        }

        .user-status {
            font-size: 12px;
            opacity: 0.7;
        }

        .sidebar-sections {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .sidebar-nav {
            padding: 10px 0;
            flex-shrink: 0;
        }

        .sidebar-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            z-index: 1;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
        }

        .sidebar-item:hover {
            background-color: var(--sidebar-hover);
        }

        .sidebar-item.active {
            background-color: var(--sidebar-hover);
            border-left: 3px solid var(--primary-color);
        }

        .sidebar-item-icon {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-item-text {
            flex: 1;
        }

        .sidebar-item-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .sidebar-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 10px 0;
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }

        .conversations-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .conversations-container::-webkit-scrollbar {
            width: 5px;
        }

        .conversations-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversations-container::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }

        .conversations-container::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color);
        }

        .sidebar-footer {
            padding: 10px 0;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-left: 0;
            transition: margin-left 0.3s ease;
            width: 100%;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: transparent;
            position: relative;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .logo h1 {
            font-size: 28px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            cursor: pointer;
            width: 40px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            position: relative;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 4px;
        }

        .theme-toggle svg {
            width: 12px;
            height: 12px;
            color: var(--text-color);
            z-index: 1;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        [data-theme="dark"] .theme-toggle {
            background-color: var(--primary-color);
        }

        [data-theme="dark"] .theme-toggle::after {
            transform: translateX(20px);
        }

        .credit-icon {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            transition: background-color 0.2s;
        }

        .credit-icon:hover {
            background-color: var(--sidebar-hover);
        }

        .credit-popup {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: var(--bg-color);
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--box-shadow);
            width: 250px;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .credit-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .credit-popup-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .credit-info {
            margin-bottom: 10px;
        }

        .credit-bar {
            height: 6px;
            background-color: var(--credit-bar-bg);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .credit-bar-fill {
            height: 100%;
            background: var(--credit-bar-fill);
            border-radius: 3px;
            width: 70%;
            transition: width 0.3s;
        }

        .credit-bar-fill.warning {
            background: var(--credit-warning);
        }

        .credit-text {
            font-size: 11px;
            display: flex;
            justify-content: space-between;
        }

        .credit-warning-text {
            color: var(--credit-warning);
            font-size: 11px;
            margin-top: 5px;
            display: none;
        }

        .credit-warning-text.active {
            display: block;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: transparent;
            transition: background-color 0.3s;
            min-height: 0;
            position: relative;
        }

        .empty-chat-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            height: 100%;
            transform: translateY(-10%);
        }

        .empty-chat-container.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .empty-chat-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            border-radius: 50%;
            overflow: hidden;
        }

        .empty-chat-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .empty-chat-title {
            font-size: 3rem;
            font-weight: 600;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .empty-chat-title img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .empty-chat-description {
            font-size: 1.2rem;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--bg-color);
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color);
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            position: relative;
        }

        .message-content {
            max-width: 80%;
            padding: 12px 15px;
            line-height: 1.5;
            border-radius: 18px;
            position: relative;
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            color: var(--light-text);
            background: var(--message-user-bg);
            border-radius: 18px;
        }

        .bot-message .message-content {
            color: var(--text-color);
            background-color: transparent;
            border-radius: 18px;
        }

        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            background-color: var(--bg-color);
            border-radius: 15px;
            padding: 3px 8px;
            box-shadow: var(--box-shadow);
            z-index: 5;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .message-action-btn:hover {
            background-color: var(--sidebar-hover);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar-chat {
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .input-container {
            display: flex;
            padding: 15px;
            background-color: transparent;
            position: relative;
            z-index: 10;
            border-radius: 20px 20px 0 0;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding-right: 90px;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 16px;
            background-color: transparent;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        #user-input::placeholder {
            color: var(--text-color);
            opacity: 0.6;
        }

        .input-buttons {
            position: absolute;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        #send-button, #stop-button, #regenerate-button {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        #send-button:hover, #stop-button:hover, #regenerate-button:hover {
            transform: scale(1.05);
        }

        #stop-button, #regenerate-button {
            display: none;
        }

        #stop-button {
            background: #ff4757;
        }

        #stop-button.visible, #regenerate-button.visible {
            display: flex;
        }

        .thinking-dots {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-color);
            border-radius: 50%;
            margin: 0 3px;
            animation: thinking 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .system-message {
            text-align: center;
            margin: 10px 0;
            color: var(--text-color);
            opacity: 0.7;
            font-style: italic;
        }

        pre {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 15px;
            overflow-x: auto;
            margin: 5px 0;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-content {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            background-color: var(--sidebar-hover);
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--border-color);
        }

        .search-highlight {
            background-color: var(--search-highlight);
            padding: 0 2px;
            border-radius: 3px;
        }

        .keyword {
            font-weight: bold;
            color: var(--keyword-highlight);
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup-container {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }

        .popup-overlay.active .popup-container {
            transform: translateY(0);
        }

        .popup-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .popup-content {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .popup-button {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 30px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: transform 0.2s;
        }

        .popup-button:hover {
            transform: scale(1.05);
        }

        .popup-button svg {
            margin-right: 10px;
        }

        .popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .conversation-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
            position: relative;
        }

        .conversation-item:hover {
            background-color: var(--sidebar-hover);
        }

        .conversation-item.active {
            background-color: var(--sidebar-hover);
            border-left: 3px solid var(--primary-color);
        }

        .conversation-icon {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .conversation-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .conversation-actions {
            position: absolute;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .conversation-action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .conversation-action-btn:hover {
            background-color: var(--sidebar-hover);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--toast-bg);
            color: var(--toast-text);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .toast.active {
            opacity: 1;
            visibility: visible;
        }

        .logout-modal {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .logout-modal-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .logout-modal-content {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .logout-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .logout-modal-button {
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .logout-modal-button:hover {
            transform: scale(1.05);
        }

        .logout-modal-button.cancel {
            background-color: var(--border-color);
            color: var(--text-color);
            border: none;
        }

        .logout-modal-button.confirm {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }

        .edit-modal-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px 15px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
            resize: vertical;
            font-family: 'Poppins', sans-serif;
        }

        .edit-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .edit-modal-button {
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .edit-modal-button.cancel {
            background-color: var(--border-color);
            color: var(--text-color);
            border: none;
        }

        .edit-modal-button.save {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .header {
                padding: 10px 15px;
            }
            
            .logo h1 {
                font-size: 24px;
            }
            
            .empty-chat-title {
                font-size: 2.5rem;
            }
            
            .empty-chat-description {
                font-size: 1rem;
            }
            
            .message-content { 
                max-width: 85%; 
            }
            
            .avatar { 
                width: 30px; 
                height: 30px; 
                margin: 0 5px; 
            }
            
            .input-container {
                padding: 10px;
            }
            
            #user-input {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            #send-button, #stop-button, #regenerate-button {
                width: 30px;
                height: 30px;
            }

            .message-actions {
                top: -25px;
            }

            .credit-popup {
                top: 60px;
                right: 10px;
                width: 220px;
            }
        }

        @media (min-width: 769px) {
            .app-container.sidebar-expanded .main-content {
                margin-left: 280px;
            }
            
            .app-container.sidebar-expanded .sidebar {
                transform: translateX(0);
            }
            
            .app-container:not(.sidebar-expanded) .sidebar {
                transform: translateX(-100%);
            }
        }
    </style>
</head>
<body>
    <div class="app-container" id="app-container">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar" id="sidebar-avatar">
                    <img src="Nexora.png" alt="Nexora Logo" id="user-profile-pic">
                </div>
                <div class="user-info">
                    <div class="user-name" id="user-display-name">nexora</div>
                    <div class="user-status" id="user-status">Free Planning</div>
                </div>
            </div>
            
            <div class="sidebar-sections">
                <div class="sidebar-nav">
                    <div class="sidebar-item active" id="new-chat-btn">
                        <div class="sidebar-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                            </svg>
                        </div>
                        <div class="sidebar-item-text">New chat</div>
                    </div>
                    
                    <div class="sidebar-divider"></div>
                </div>
                
                <div class="conversations-container" id="conversations-container">
                    <!-- Conversation history will be added here -->
                </div>
                
                <div class="sidebar-footer">
                    <div class="sidebar-item" id="search-btn">
                        <div class="sidebar-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                        </div>
                        <div class="sidebar-item-text">Search</div>
                    </div>
                    
                    <div class="sidebar-divider"></div>
                    
                    <div class="sidebar-item" id="login-btn">
                        <div class="sidebar-item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                                <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                            </svg>
                        </div>
                        <div class="sidebar-item-text">Sign In</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="logo">
                    <button class="sidebar-toggle" id="sidebar-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                    </button>
                    <h1>nexora</h1>
                </div>
                <div class="header-actions">
                    <div class="credit-icon" id="credit-icon">
<div class="credit-icon" id="credit-icon">
<img src="Credits.png" alt="Gem Star Credit Icon" width="50" height="50"></div>
                    </div>
                    <div class="theme-toggle" id="theme-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="sun-icon">
                            <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="moon-icon">
                            <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Credit popup -->
                <div class="credit-popup" id="credit-popup">
                    <div class="credit-popup-title">Your Credits</div>
                    <div class="credit-info">
                        <div class="credit-bar">
                            <div class="credit-bar-fill" id="credit-bar-fill"></div>
                        </div>
                        <div class="credit-text">
                            <span id="credit-label"><span id="credit-amount">10.00</span> credits</span>
                            <span>Resets on <span id="reset-date">Jun 1</span></span>
                        </div>
                        <div class="credit-warning-text" id="credit-warning-text">
                            Low credit! Only <span id="credit-remaining">2</span> credits remaining.
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chat-container">
                <div class="empty-chat-container" id="empty-chat-container">
                    <div class="empty-chat-title">
                        <img src="Nexora.png" alt="Nexora Logo">
                        nexora
                    </div>
                    <p class="empty-chat-description">How can I help you today?</p>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <!-- Chat messages will be added here -->
                </div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <input type="text" id="user-input" placeholder="Ask nexora something..." autocomplete="off">
                        <div class="input-buttons">
                            <button id="regenerate-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                                    <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                                </svg>
                            </button>
                            <button id="stop-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/>
                                </svg>
                            </button>
                            <button id="send-button">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Search Modal -->
    <div class="modal-overlay" id="search-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Search Messages</h2>
                <button class="modal-close" id="search-modal-close">×</button>
            </div>
            <div class="modal-content">
                <input type="text" class="search-input" id="search-input" placeholder="Type to search messages...">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
    </div>

    <!-- Login popup -->
    <div class="popup-overlay" id="login-popup">
        <div class="popup-container">
            <button class="popup-close" id="popup-close">×</button>
            <h2 class="popup-title">Sign in to nexora cognitia</h2>
            <p class="popup-content" id="popup-message">You have 1 credit left to chat anonymously. Sign in to experience nexora cognitia.</p>
            <button class="popup-button" id="google-signin-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
                    <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                    <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
                    <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Logout confirmation modal -->
    <div class="popup-overlay" id="logout-popup">
        <div class="popup-container logout-modal">
            <h2 class="logout-modal-title">Sign Out</h2>
            <p class="logout-modal-content">Are you sure you want to sign out? Your conversations will remain saved to your account.</p>
            <div class="logout-modal-buttons">
                <button class="logout-modal-button cancel" id="logout-cancel">Cancel</button>
                <button class="logout-modal-button confirm" id="logout-confirm">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Edit prompt modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Edit Prompt</h2>
                <button class="modal-close" id="edit-modal-close">×</button>
            </div>
            <div class="modal-content">
                <textarea class="edit-modal-textarea" id="edit-prompt-textarea"></textarea>
                <div class="edit-modal-buttons">
                    <button class="edit-modal-button cancel" id="edit-cancel">Cancel</button>
                    <button class="edit-modal-button save" id="edit-save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyD9rh3soAgWPAPO8o5OVRAQc7t_VHSAvbU",
        authDomain: "nexora-8b146.firebaseapp.com",
        projectId: "nexora-8b146",
        storageBucket: "nexora-8b146.firebasestorage.app",
        messagingSenderId: "383585586026",
        appId: "1:383585586026:web:6948e25da92bf620b53313",
        measurementId: "G-C3NS5QBJM5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    // DOM Elements
    const appContainer = document.getElementById('app-container');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const regenerateButton = document.getElementById('regenerate-button');
    const themeToggle = document.getElementById('theme-toggle');
    const emptyChat = document.getElementById('empty-chat-container');
    const loginBtn = document.getElementById('login-btn');
    const loginPopup = document.getElementById('login-popup');
    const logoutPopup = document.getElementById('logout-popup');
    const logoutCancel = document.getElementById('logout-cancel');
    const logoutConfirm = document.getElementById('logout-confirm');
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const userDisplayName = document.getElementById('user-display-name');
    const userStatus = document.getElementById('user-status');
    const userProfilePic = document.getElementById('user-profile-pic');
    const conversationsContainer = document.getElementById('conversations-container');
    const newChatBtn = document.getElementById('new-chat-btn');
    const searchBtn = document.getElementById('search-btn');
    const searchModal = document.getElementById('search-modal');
    const searchModalClose = document.getElementById('search-modal-close');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const popupMessage = document.getElementById('popup-message');
    const popupClose = document.getElementById('popup-close');
    const toast = document.getElementById('toast');
    const creditIcon = document.getElementById('credit-icon');
    const creditPopup = document.getElementById('credit-popup');
    const creditBarFill = document.getElementById('credit-bar-fill');
    const creditAmount = document.getElementById('credit-amount');
    const creditLabel = document.getElementById('credit-label');
    const creditRemaining = document.getElementById('credit-remaining');
    const creditWarningText = document.getElementById('credit-warning-text');
    const resetDate = document.getElementById('reset-date');
    const editModal = document.getElementById('edit-modal');
    const editModalClose = document.getElementById('edit-modal-close');
    const editPromptTextarea = document.getElementById('edit-prompt-textarea');
    const editCancel = document.getElementById('edit-cancel');
    const editSave = document.getElementById('edit-save');
    
    // App state
    let isGenerating = false;
    let shouldStop = false;
    let currentMessageElement = null;
    let typingSpeed = 30; // Default typing speed in ms
    let currentUser = null;
    let anonymousPromptCount = 0;
    let currentConversationId = null;
    let conversations = [];
    let anonymousAuthEnabled = true; // Will be set to false if anonymous auth fails
    let lastUserMessage = ''; // Store the last user message for regeneration
    let allMessages = []; // Store all messages for search functionality
    let initialPrompt = ''; // Store the initial prompt for title change
    let currentEditingMessageId = null; // Store the ID of the message being edited
    
    // Credit system
    const ANONYMOUS_MAX_CREDITS = 6; // Anonymous users get 6 credits
    const SIGNED_IN_MAX_CREDITS = 10; // Signed-in users get $10
    let userCredits = ANONYMOUS_MAX_CREDITS; // Default to anonymous credits
    let creditsUsed = 0; // Amount used
    let lastCreditReset = new Date(); // Last credit reset date
    let lowCreditWarningShown = false; // Track if low credit warning has been shown
    let isAnonymous = true; // Track if user is anonymous
    let firestoreAvailable = true; // Track if Firestore is available

    // Update document title based on initial prompt
    function updateDocumentTitle(prompt) {
        if (prompt && prompt.length > 0) {
            // Limit title length
            const titleText = prompt.length > 30 ? prompt.substring(0, 30) + '...' : prompt;
            document.title = `${titleText} - Nexora`;
        } else {
            document.title = 'Nexora - AI Chatbot';
        }
    }

    // Sidebar toggle functionality
    function toggleSidebar() {
        if (window.innerWidth < 769) {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        } else {
            appContainer.classList.toggle('sidebar-expanded');
        }
    }

    sidebarToggle.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);

    // Initialize sidebar state based on screen size
    function initSidebar() {
        if (window.innerWidth >= 769) {
            appContainer.classList.add('sidebar-expanded');
        }
    }

    // Call on load
    initSidebar();

    // Update on resize
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 769) {
            sidebarOverlay.classList.remove('active');
            sidebar.classList.remove('active');
        } else {
            appContainer.classList.remove('sidebar-expanded');
        }
    });

    // Credit icon click handler
    creditIcon.addEventListener('click', () => {
        // Force update before showing
        forceUpdateCreditDisplay();
        
        creditPopup.classList.toggle('active');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            creditPopup.classList.remove('active');
        }, 5000);
    });

    // Close credit popup when clicking outside
    document.addEventListener('click', (e) => {
        if (!creditIcon.contains(e.target) && !creditPopup.contains(e.target)) {
            creditPopup.classList.remove('active');
        }
    });

    // Force update credit display
    function forceUpdateCreditDisplay() {
        const remainingCredits = userCredits - creditsUsed;
        
        // Update the credit amount display
        const creditAmountElement = document.getElementById('credit-amount');
        if (creditAmountElement) {
            creditAmountElement.textContent = remainingCredits.toFixed(isAnonymous ? 0 : 2);
        }
        
        // Update the credit bar fill
        const creditBarFillElement = document.getElementById('credit-bar-fill');
        if (creditBarFillElement) {
            const percentage = (remainingCredits / userCredits) * 100;
            creditBarFillElement.style.width = `${percentage}%`;
        }
        
        console.log('Forced credit display update:', {
            remainingCredits,
            percentage: (remainingCredits / userCredits) * 100,
            element: creditAmountElement ? 'found' : 'not found',
            barElement: creditBarFillElement ? 'found' : 'not found'
        });
    }

    // Update credit bar
    function updateCreditBar() {
        const remainingCredits = userCredits - creditsUsed;
        const percentage = (remainingCredits / userCredits) * 100;
        
        console.log('Updating credit bar:', {
            userCredits,
            creditsUsed,
            remainingCredits,
            percentage,
            isAnonymous
        });
        
        // Force update the DOM elements directly
        document.getElementById('credit-bar-fill').style.width = `${percentage}%`;
        document.getElementById('credit-amount').textContent = remainingCredits.toFixed(isAnonymous ? 0 : 2);
        
        // Set warning threshold based on user type
        const warningThreshold = isAnonymous ? 2 : 2.00;
        
        // Check if credits are low
        if (remainingCredits <= warningThreshold && !lowCreditWarningShown) {
            document.getElementById('credit-warning-text').classList.add('active');
            document.getElementById('credit-remaining').textContent = remainingCredits.toFixed(isAnonymous ? 0 : 2);
            document.getElementById('credit-bar-fill').classList.add('warning');
            showToast(`Warning: Low credits remaining! Only ${remainingCredits.toFixed(isAnonymous ? 0 : 2)} left.`);
            lowCreditWarningShown = true;
        } else if (remainingCredits > warningThreshold) {
            document.getElementById('credit-warning-text').classList.remove('active');
            document.getElementById('credit-bar-fill').classList.remove('warning');
            lowCreditWarningShown = false;
        }
        
        // Set next reset date (15th or 1st of month)
        const now = new Date();
        let nextResetDate;
        
        if (now.getDate() < 15) {
            // Next reset is on the 15th
            nextResetDate = new Date(now.getFullYear(), now.getMonth(), 15);
        } else {
            // Next reset is on the 1st of next month
            nextResetDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        }
        
        document.getElementById('reset-date').textContent = nextResetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        // Force a repaint to ensure the UI updates
        setTimeout(() => {
            document.getElementById('credit-popup').style.display = 'none';
            document.getElementById('credit-popup').offsetHeight; // Force reflow
            document.getElementById('credit-popup').style.display = '';
        }, 0);
    }

    // Check if credits need to be reset
    function checkCreditReset() {
        const now = new Date();
        const lastResetDay = lastCreditReset.getDate();
        const currentDay = now.getDate();
        
        // Reset on the 1st and 15th of each month
        if ((currentDay === 1 || currentDay === 15) && 
            (lastResetDay !== 1 && lastResetDay !== 15 || 
             lastCreditReset.getMonth() !== now.getMonth() ||
             lastCreditReset.getFullYear() !== now.getFullYear())) {
            
            // Reset credits
            creditsUsed = 0;
            lastCreditReset = now;
            lowCreditWarningShown = false;
            
            // Update UI
            updateCreditBar();
            forceUpdateCreditDisplay();
            showToast('Your credits have been reset!');
            
            // Save to localStorage
            saveCreditsToStorage();
        }
    }

    // Save user credits to storage (Firestore or localStorage)
    function saveCreditsToStorage() {
        if (!isAnonymous && currentUser && firestoreAvailable) {
            // Try to save to Firestore for signed-in users
            db.collection('users').doc(currentUser.uid).set({
                creditsUsed: creditsUsed,
                lastCreditReset: firebase.firestore.Timestamp.fromDate(lastCreditReset)
            }, { merge: true })
            .catch(error => {
                console.error('Error saving user credits:', error);
                // If Firestore fails, mark it as unavailable and fall back to localStorage
                firestoreAvailable = false;
                saveToLocalStorage();
            });
        } else {
            // Save to localStorage for anonymous users or if Firestore is unavailable
            saveToLocalStorage();
        }
    }

    // Save credits to localStorage
    function saveToLocalStorage() {
        const storageKey = isAnonymous ? 'anonymousCreditsUsed' : `userCredits_${currentUser?.uid || 'default'}`;
        const resetKey = isAnonymous ? 'anonymousLastCreditReset' : `userCreditReset_${currentUser?.uid || 'default'}`;
        
        localStorage.setItem(storageKey, creditsUsed);
        localStorage.setItem(resetKey, lastCreditReset.toISOString());
        
        console.log('Saved credits to localStorage:', {
            storageKey,
            creditsUsed,
            resetKey,
            lastCreditReset: lastCreditReset.toISOString()
        });
    }

    // Load user credits from storage
    function loadCreditsFromStorage() {
        if (!isAnonymous && currentUser && firestoreAvailable) {
            // Try to load from Firestore for signed-in users
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        if (userData.creditsUsed !== undefined) {
                            creditsUsed = userData.creditsUsed;
                        }
                        
                        if (userData.lastCreditReset) {
                            lastCreditReset = userData.lastCreditReset.toDate();
                        }
                    }
                    
                    // Check if we need to reset credits
                    checkCreditReset();
                    
                    // Update UI
                    updateCreditBar();
                    forceUpdateCreditDisplay();
                    
                    console.log('Loaded credits from Firestore:', {
                        creditsUsed,
                        lastCreditReset,
                        remaining: userCredits - creditsUsed
                    });
                })
                .catch(error => {
                    console.error('Error loading user credits:', error);
                    // If Firestore fails, mark it as unavailable and fall back to localStorage
                    firestoreAvailable = false;
                    loadFromLocalStorage();
                });
        } else {
            // Load from localStorage for anonymous users or if Firestore is unavailable
            loadFromLocalStorage();
        }
    }

    // Load credits from localStorage
    function loadFromLocalStorage() {
        const storageKey = isAnonymous ? 'anonymousCreditsUsed' : `userCredits_${currentUser?.uid || 'default'}`;
        const resetKey = isAnonymous ? 'anonymousLastCreditReset' : `userCreditReset_${currentUser?.uid || 'default'}`;
        
        const savedCreditsUsed = localStorage.getItem(storageKey);
        const savedLastReset = localStorage.getItem(resetKey);
        
        if (savedCreditsUsed !== null) {
            creditsUsed = parseFloat(savedCreditsUsed);
        }
        
        if (savedLastReset !== null) {
            lastCreditReset = new Date(savedLastReset);
        }
        
        // Check if we need to reset credits
        checkCreditReset();
        
        // Update UI
        updateCreditBar();
        forceUpdateCreditDisplay();
        
        console.log('Loaded credits from localStorage:', {
            storageKey,
            creditsUsed,
            resetKey,
            lastCreditReset,
            remaining: userCredits - creditsUsed
        });
    }

    // Theme toggle functionality
    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
    }

    // Toast notification
    function showToast(message, duration = 3000) {
        toast.textContent = message;
        toast.classList.add('active');
        
        setTimeout(() => {
            toast.classList.remove('active');
        }, duration);
    }

    // Authentication state observer
    auth.onAuthStateChanged((user) => {
        currentUser = user;
        
        if (user) {
            // User is signed in
            if (!user.isAnonymous) {
                // Update UI for signed-in user
                userDisplayName.textContent = user.displayName || 'User';
                userStatus.textContent = 'Free Planning';
                isAnonymous = false;
                userCredits = SIGNED_IN_MAX_CREDITS;
                creditLabel.innerHTML = `$<span id="credit-amount">${SIGNED_IN_MAX_CREDITS.toFixed(2)}</span> credit`;
                
                if (user.photoURL) {
                    userProfilePic.src = user.photoURL;
                } else {
                    userProfilePic.src = 'Nexora.png';
                }
                
                loginBtn.querySelector('.sidebar-item-text').textContent = 'Sign Out';
                
                // Load user's conversations
                loadConversations();
                
                // Load user's credits
                loadCreditsFromStorage();
            } else {
                // Anonymous user
                isAnonymous = true;
                userCredits = ANONYMOUS_MAX_CREDITS;
                creditLabel.innerHTML = `<span id="credit-amount">${ANONYMOUS_MAX_CREDITS}</span> credits`;
                loadCreditsFromStorage();
            }
        } else {
            // User is signed out, try to proceed without authentication
            userDisplayName.textContent = 'Nexora';
            userStatus.textContent = 'Free Planning';
            userProfilePic.src = 'Nexora.png';
            loginBtn.querySelector('.sidebar-item-text').textContent = 'Sign In';
            isAnonymous = true;
            userCredits = ANONYMOUS_MAX_CREDITS;
            creditLabel.innerHTML = `<span id="credit-amount">${ANONYMOUS_MAX_CREDITS}</span> credits`;
            
            // Clear conversations
            conversationsContainer.innerHTML = '';
            
            // Load anonymous credits
            loadCreditsFromStorage();
            
            // Try anonymous auth if needed for features, but don't block the app
            if (anonymousAuthEnabled) {
                auth.signInAnonymously()
                    .catch((error) => {
                        console.error('Anonymous auth error:', error);
                        anonymousAuthEnabled = false;
                        // Continue without anonymous auth
                    });
            }
        }
    });

    // Google Sign In
    googleSignInBtn.addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        
        auth.signInWithPopup(provider)
            .then((result) => {
                // Close the popup
                loginPopup.classList.remove('active');
                
                // If user was anonymous before, transfer their conversation
                if (currentConversationId && auth.currentUser && auth.currentUser.isAnonymous) {
                    transferAnonymousConversation(currentConversationId, result.user.uid);
                }
                
                showToast('Successfully signed in!');
            })
            .catch((error) => {
                console.error('Google sign in error:', error);
                
                // Show a helpful error message
                if (error.code === 'auth/unauthorized-domain') {
                    showToast('This domain is not authorized for OAuth operations.');
                } else {
                    showToast('Error signing in: ' + error.message);
                }
            });
    });

    // Close popup when clicking the X
    popupClose.addEventListener('click', () => {
        loginPopup.classList.remove('active');
    });

    // Login button click handler
    loginBtn.addEventListener('click', () => {
        if (currentUser && !currentUser.isAnonymous) {
            // Show logout confirmation
            logoutPopup.classList.add('active');
        } else {
            // Show login popup
            popupMessage.textContent = 'Sign in to experience Nexora Cognitia with unlimited access.';
            loginPopup.classList.add('active');
        }
    });

    // Logout confirmation handlers
    logoutCancel.addEventListener('click', () => {
        logoutPopup.classList.remove('active');
    });

    logoutConfirm.addEventListener('click', () => {
        // Sign out
        auth.signOut()
            .then(() => {
                logoutPopup.classList.remove('active');
                showToast('Successfully signed out');
                console.log('User signed out');
            })
            .catch((error) => {
                console.error('Sign out error:', error);
                showToast('Error signing out');
            });
    });

    // Close popup when clicking outside
    loginPopup.addEventListener('click', (e) => {
        if (e.target === loginPopup) {
            loginPopup.classList.remove('active');
        }
    });

    logoutPopup.addEventListener('click', (e) => {
        if (e.target === logoutPopup) {
            logoutPopup.classList.remove('active');
        }
    });

    // Modal handlers
    searchBtn.addEventListener('click', () => {
        searchModal.classList.add('active');
        searchInput.focus();
    });

    searchModalClose.addEventListener('click', () => {
        searchModal.classList.remove('active');
    });

    // Edit modal handlers
    editModalClose.addEventListener('click', () => {
        editModal.classList.remove('active');
    });

    editCancel.addEventListener('click', () => {
        editModal.classList.remove('active');
    });

    editSave.addEventListener('click', () => {
        const newPrompt = editPromptTextarea.value.trim();
        if (newPrompt && currentEditingMessageId) {
            // Update the message in the UI
            const messageElement = document.querySelector(`[data-message-id="${currentEditingMessageId}"]`);
            if (messageElement) {
                messageElement.textContent = newPrompt;
            }
            
            // Update in Firestore if possible
            if (currentConversationId && firestoreAvailable) {
                db.collection('conversations').doc(currentConversationId)
                    .collection('messages')
                    .doc(currentEditingMessageId)
                    .update({
                        content: newPrompt
                    })
                    .then(() => {
                        showToast('Prompt updated successfully');
                    })
                    .catch(error => {
                        console.error('Error updating prompt:', error);
                        firestoreAvailable = false;
                        showToast('Error updating prompt - using local storage instead');
                    });
            }
            
            // Update in local storage
            for (let i = 0; i < allMessages.length; i++) {
                if (allMessages[i].id === currentEditingMessageId) {
                    allMessages[i].content = newPrompt;
                    break;
                }
            }
            
            // If this was the first message, update the title
            if (allMessages.length > 0 && allMessages[0].id === currentEditingMessageId) {
                initialPrompt = newPrompt;
                updateDocumentTitle(initialPrompt);
            }
        }
        
        editModal.classList.remove('active');
    });

    // Close modals when clicking outside
    searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
            searchModal.classList.remove('active');
        }
    });

    editModal.addEventListener('click', (e) => {
        if (e.target === editModal) {
            editModal.classList.remove('active');
        }
    });

    // Load user's conversations from Firestore
    function loadConversations() {
        if (!currentUser || currentUser.isAnonymous || !firestoreAvailable) return;
        
        db.collection('conversations')
            .where('userId', '==', currentUser.uid)
            .orderBy('updatedAt', 'desc')
            .limit(20)
            .get()
            .then((querySnapshot) => {
                conversations = [];
                conversationsContainer.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const conversation = doc.data();
                    conversation.id = doc.id;
                    conversations.push(conversation);
                    
                    // Create conversation item in sidebar
                    addConversationToSidebar(conversation);
                });
            })
            .catch((error) => {
                console.error('Error loading conversations:', error);
                firestoreAvailable = false;
                showToast('Error loading conversations - using local storage instead');
            });
    }

    // Add conversation to sidebar
    function addConversationToSidebar(conversation) {
        const conversationItem = document.createElement('div');
        conversationItem.className = 'conversation-item';
        conversationItem.dataset.id = conversation.id;
        
        if (conversation.id === currentConversationId) {
            conversationItem.classList.add('active');
        }
        
        conversationItem.innerHTML = `
            <div class="conversation-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                    <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.273.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.193-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                </svg>
            </div>
            <div class="conversation-title">${conversation.title || 'New Conversation'}</div>
            <div class="conversation-actions">
                <button class="conversation-action-btn edit-btn" title="Edit conversation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                    </svg>
                </button>
                <button class="conversation-action-btn delete-btn" title="Delete conversation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>
            </div>
        `;
        
        // Add click event to load conversation
        conversationItem.addEventListener('click', (e) => {
            // Don't load if clicking on action buttons
            if (e.target.closest('.conversation-actions')) {
                return;
            }
            loadConversation(conversation.id);
        });
        
        // Add edit conversation handler
        const editBtn = conversationItem.querySelector('.edit-btn');
        if (editBtn) {
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Load the conversation first if not already loaded
                if (currentConversationId !== conversation.id) {
                    loadConversation(conversation.id, () => {
                        // After loading, edit the first message
                        if (allMessages.length > 0) {
                            const firstUserMessage = allMessages.find(msg => msg.role === 'user');
                            if (firstUserMessage) {
                                editPromptTextarea.value = firstUserMessage.content;
                                currentEditingMessageId = firstUserMessage.id;
                                editModal.classList.add('active');
                            }
                        }
                    });
                } else {
                    // Conversation already loaded, edit the first message
                    if (allMessages.length > 0) {
                        const firstUserMessage = allMessages.find(msg => msg.role === 'user');
                        if (firstUserMessage) {
                            editPromptTextarea.value = firstUserMessage.content;
                            currentEditingMessageId = firstUserMessage.id;
                            editModal.classList.add('active');
                        }
                    }
                }
            });
        }
        
        // Add delete conversation handler
        const deleteBtn = conversationItem.querySelector('.delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this conversation?')) {
                    deleteConversation(conversation.id);
                }
            });
        }
        
        conversationsContainer.appendChild(conversationItem);
    }

    // Delete conversation
    function deleteConversation(conversationId) {
        if (!conversationId) return;
        
        if (firestoreAvailable) {
            db.collection('conversations').doc(conversationId).delete()
                .then(() => {
                    handleConversationDeleted(conversationId);
                })
                .catch((error) => {
                    console.error('Error deleting conversation:', error);
                    firestoreAvailable = false;
                    showToast('Error deleting conversation from server - removing locally');
                    handleConversationDeleted(conversationId);
                });
        } else {
            // Just handle the UI update if Firestore is not available
            handleConversationDeleted(conversationId);
        }
    }

    // Handle conversation deleted (UI updates)
    function handleConversationDeleted(conversationId) {
        // Remove from UI
        const conversationItem = document.querySelector(`.conversation-item[data-id="${conversationId}"]`);
        if (conversationItem) {
            conversationItem.remove();
        }
        
        // Remove from conversations array
        conversations = conversations.filter(conv => conv.id !== conversationId);
        
        // If this was the current conversation, clear the chat
        if (currentConversationId === conversationId) {
            chatMessages.innerHTML = '';
            emptyChat.classList.remove('hidden');
            currentConversationId = null;
            lastUserMessage = '';
            allMessages = [];
            initialPrompt = '';
            updateDocumentTitle('');
            regenerateButton.classList.remove('visible');
        }
        
        showToast('Conversation deleted');
    }

    // Load a specific conversation
    function loadConversation(conversationId, callback) {
        if (!conversationId) return;
        
        currentConversationId = conversationId;
        
        // Update active state in sidebar
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.id === conversationId) {
                item.classList.add('active');
            }
        });
        
        // Clear current chat
        chatMessages.innerHTML = '';
        emptyChat.classList.add('hidden');
        allMessages = []; // Clear stored messages
        
        if (firestoreAvailable) {
            // Load messages from Firestore
            db.collection('conversations').doc(conversationId)
                .collection('messages')
                .orderBy('timestamp')
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const message = doc.data();
                        message.id = doc.id; // Store the message ID
                        
                        if (message.role === 'USER') {
                            addMessageToChat('user', message.content, false, message.id);
                            // Store for search functionality
                            allMessages.push({
                                id: message.id,
                                role: 'user',
                                content: message.content,
                                timestamp: message.timestamp
                            });
                            
                            // Update last user message for regeneration
                            lastUserMessage = message.content;
                            
                            // Update title if this is the first message
                            if (allMessages.length === 1) {
                                initialPrompt = message.content;
                                updateDocumentTitle(initialPrompt);
                            }
                        } else if (message.role === 'CHATBOT') {
                            addMessageToChat('bot', message.content, false, message.id);
                            // Store for search functionality
                            allMessages.push({
                                id: message.id,
                                role: 'bot',
                                content: message.content,
                                timestamp: message.timestamp
                            });
                        }
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Call callback if provided
                    if (typeof callback === 'function') {
                        callback();
                    }
                })
                .catch((error) => {
                    console.error('Error loading messages:', error);
                    firestoreAvailable = false;
                    showToast('Error loading conversation from server');
                    
                    // Try to load from localStorage as fallback
                    loadConversationFromLocalStorage(conversationId, callback);
                });
        } else {
            // Load from localStorage if Firestore is not available
            loadConversationFromLocalStorage(conversationId, callback);
        }
    }

    // Load conversation from localStorage
    function loadConversationFromLocalStorage(conversationId, callback) {
        const savedMessages = localStorage.getItem(`conversation_${conversationId}`);
        if (savedMessages) {
            try {
                const messages = JSON.parse(savedMessages);
                messages.forEach(message => {
                    if (message.role === 'user') {
                        addMessageToChat('user', message.content, false, message.id);
                        allMessages.push(message);
                        
                        // Update last user message for regeneration
                        lastUserMessage = message.content;
                        
                        // Update title if this is the first message
                        if (allMessages.length === 1) {
                            initialPrompt = message.content;
                            updateDocumentTitle(initialPrompt);
                        }
                    } else if (message.role === 'bot') {
                        addMessageToChat('bot', message.content, false, message.id);
                        allMessages.push(message);
                    }
                });
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Call callback if provided
                if (typeof callback === 'function') {
                    callback();
                }
            } catch (error) {
                console.error('Error parsing saved messages:', error);
                showToast('Error loading conversation');
            }
        } else {
            showToast('No saved conversation found');
        }
    }

    // Create a new conversation
    function createNewConversation(firstMessage) {
        const userId = currentUser ? currentUser.uid : null;
        const isAnonymousUser = currentUser ? currentUser.isAnonymous : true;
        
        const conversationData = {
            userId: userId,
            isAnonymous: isAnonymousUser,
            title: firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (firestoreAvailable && currentUser) {
            return db.collection('conversations').add(conversationData)
                .then((docRef) => {
                    currentConversationId = docRef.id;
                    
                    // Add to conversations array and sidebar if user is signed in
                    if (userId && !isAnonymousUser) {
                        const conversation = {
                            ...conversationData,
                            id: docRef.id
                        };
                        conversations.unshift(conversation);
                        addConversationToSidebar(conversation);
                    }
                    
                    return docRef.id;
                })
                .catch((error) => {
                    console.error('Error creating conversation in Firestore:', error);
                    firestoreAvailable = false;
                    
                    // Fall back to localStorage
                    return createLocalConversation(conversationData);
                });
        } else {
            // Use localStorage if Firestore is not available
            return Promise.resolve(createLocalConversation(conversationData));
        }
    }

    // Create a conversation in localStorage
    function createLocalConversation(conversationData) {
        const conversationId = 'local_' + Date.now();
        currentConversationId = conversationId;
        
        // Save conversation metadata
        localStorage.setItem(`conversationMeta_${conversationId}`, JSON.stringify({
            ...conversationData,
            id: conversationId,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        }));
        
        // Initialize empty messages array
        localStorage.setItem(`conversation_${conversationId}`, JSON.stringify([]));
        
        return conversationId;
    }

    // Add message to Firestore
    function saveMessageToFirestore(conversationId, role, content) {
        if (!conversationId) return Promise.resolve(null);
        
        const messageId = 'msg_' + Date.now();
        const messageData = {
            role: role,
            content: content,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (firestoreAvailable && currentUser) {
            return db.collection('conversations').doc(conversationId)
                .collection('messages').add(messageData)
                .then((docRef) => {
                    // Update conversation timestamp
                    db.collection('conversations').doc(conversationId)
                        .update({
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        })
                        .catch(error => {
                            console.error('Error updating conversation timestamp:', error);
                            firestoreAvailable = false;
                        });
                    
                    return docRef.id; // Return the message ID
                })
                .catch((error) => {
                    console.error('Error saving message to Firestore:', error);
                    firestoreAvailable = false;
                    
                    // Fall back to localStorage
                    return saveMessageToLocalStorage(conversationId, role, content, messageId);
                });
        } else {
            // Use localStorage if Firestore is not available
            return Promise.resolve(saveMessageToLocalStorage(conversationId, role, content, messageId));
        }
    }

    // Save message to localStorage
    function saveMessageToLocalStorage(conversationId, role, content, messageId) {
        const savedMessages = localStorage.getItem(`conversation_${conversationId}`);
        let messages = [];
        
        if (savedMessages) {
            try {
                messages = JSON.parse(savedMessages);
            } catch (error) {
                console.error('Error parsing saved messages:', error);
            }
        }
        
        // Add new message
        messages.push({
            id: messageId,
            role: role === 'USER' ? 'user' : 'bot',
            content: content,
            timestamp: new Date().toISOString()
        });
        
        // Save updated messages
        localStorage.setItem(`conversation_${conversationId}`, JSON.stringify(messages));
        
        // Update conversation metadata
        const savedMeta = localStorage.getItem(`conversationMeta_${conversationId}`);
        if (savedMeta) {
            try {
                const meta = JSON.parse(savedMeta);
                meta.updatedAt = new Date().toISOString();
                localStorage.setItem(`conversationMeta_${conversationId}`, JSON.stringify(meta));
            } catch (error) {
                console.error('Error updating conversation metadata:', error);
            }
        }
        
        return messageId;
    }

    // Transfer anonymous conversation to signed-in user
    function transferAnonymousConversation(conversationId, newUserId) {
        if (firestoreAvailable) {
            db.collection('conversations').doc(conversationId)
                .update({
                    userId: newUserId,
                    isAnonymous: false
                })
                .then(() => {
                    console.log('Conversation transferred to signed-in user');
                })
                .catch((error) => {
                    console.error('Error transferring conversation:', error);
                    firestoreAvailable = false;
                });
        }
    }

    // New chat button
    newChatBtn.addEventListener('click', () => {
        // Clear current chat
        chatMessages.innerHTML = '';
        emptyChat.classList.remove('hidden');
        currentConversationId = null;
        lastUserMessage = '';
        allMessages = [];
        initialPrompt = '';
        updateDocumentTitle('');
        
        // Update active state in sidebar
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        
        newChatBtn.classList.add('active');
        regenerateButton.classList.remove('visible');
    });

    // Search functionality - Fixed to properly search through messages
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim().toLowerCase();
        searchResults.innerHTML = '';
        
        if (query.length < 2) return;
        
        // Search through all messages
        const results = allMessages.filter(msg => 
            msg.content.toLowerCase().includes(query)
        );
        
        if (results.length === 0) {
            searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
            return;
        }
        
        results.forEach((result, index) => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            
            // Highlight the matching text
            let content = result.content;
            const queryRegex = new RegExp(`(${query})`, 'gi');
            content = content.replace(queryRegex, '<span class="search-highlight">$1</span>');
            
            // Truncate long messages
            if (content.length > 100) {
                const startIndex = content.toLowerCase().indexOf(query.toLowerCase());
                const startPos = Math.max(0, startIndex - 40);
                content = (startPos > 0 ? '...' : '') + 
                         content.substring(startPos, startPos + 100) + 
                         (content.length > startPos + 100 ? '...' : '');
            }
            
            resultItem.innerHTML = `
                <strong>${result.role === 'user' ? 'You' : 'Nexora'}:</strong> ${content}
            `;
            
            // Scroll to the message when clicked
            resultItem.addEventListener('click', () => {
                // Find the message in the chat
                const messages = chatMessages.querySelectorAll('.message');
                let targetMessage = null;
                
                for (let i = 0; i < messages.length; i++) {
                    const messageContent = messages[i].querySelector('.message-content');
                    if (messageContent && messageContent.textContent.includes(result.content.substring(0, 30))) {
                        targetMessage = messages[i];
                        break;
                    }
                }
                
                if (targetMessage) {
                    // Scroll to the message
                    targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Highlight the message briefly
                    targetMessage.style.backgroundColor = 'rgba(106, 17, 203, 0.1)';
                    setTimeout(() => {
                        targetMessage.style.backgroundColor = '';
                    }, 2000);
                    
                    // Close search modal
                    searchModal.classList.remove('active');
                }
            });
            
            searchResults.appendChild(resultItem);
        });
    });

    // Handle user message
    sendButton.addEventListener('click', handleUserMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleUserMessage();
    });
    
    // Stop button functionality
    stopButton.addEventListener('click', () => {
        if (isGenerating) {
            shouldStop = true;
            stopButton.classList.remove('visible');
            sendButton.style.display = 'flex';
            regenerateButton.classList.add('visible');
            
            // Add cursor at the end of the current message
            if (currentMessageElement) {
                const cursor = document.createElement('span');
                cursor.className = 'cursor';
                currentMessageElement.appendChild(cursor);
            }
        }
    });
    
    // Regenerate button functionality
    regenerateButton.addEventListener('click', () => {
        if (isGenerating) return;
        
        if (lastUserMessage) {
            // Remove the last bot message
            const messages = chatMessages.querySelectorAll('.message');
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                if (lastMessage.classList.contains('bot-message')) {
                    lastMessage.remove();
                    
                    // Also remove from Firestore if possible
                    if (currentConversationId && firestoreAvailable) {
                        db.collection('conversations').doc(currentConversationId)
                            .collection('messages')
                            .orderBy('timestamp', 'desc')
                            .limit(1)
                            .get()
                            .then((querySnapshot) => {
                                querySnapshot.forEach((doc) => {
                                    if (doc.data().role === 'CHATBOT') {
                                        doc.ref.delete();
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Error deleting message:', error);
                                firestoreAvailable = false;
                            });
                    }
                    
                    // Remove from allMessages array
                    if (allMessages.length > 0 && allMessages[allMessages.length - 1].role === 'bot') {
                        allMessages.pop();
                    }
                    
                    // Remove from localStorage if needed
                    if (!firestoreAvailable && currentConversationId) {
                        const savedMessages = localStorage.getItem(`conversation_${currentConversationId}`);
                        if (savedMessages) {
                            try {
                                let messages = JSON.parse(savedMessages);
                                if (messages.length > 0 && messages[messages.length - 1].role === 'bot') {
                                    messages.pop();
                                    localStorage.setItem(`conversation_${currentConversationId}`, JSON.stringify(messages));
                                }
                            } catch (error) {
                                console.error('Error updating localStorage messages:', error);
                            }
                        }
                    }
                }
            }
            
            // Get a new response
            getBotResponse(lastUserMessage);
            regenerateButton.classList.remove('visible');
        } else {
            showToast('No previous message to regenerate');
        }
    });

    async function handleUserMessage() {
        const message = userInput.value.trim();
        if (!message || isGenerating) return;

        // Hide regenerate button
        regenerateButton.classList.remove('visible');
        
        // Store for regeneration
        lastUserMessage = message;

        // Check if user is anonymous and has reached the limit
        if (isAnonymous) {
            anonymousPromptCount++;
            
            // Show warning after 5th prompt
            if (anonymousPromptCount === 5) {
                popupMessage.textContent = 'You have 1 credit left to chat anonymously. Sign in to experience Nexora Cognitia with unlimited access.';
                loginPopup.classList.add('active');
            }
            
            // Block after 6th prompt
            if (anonymousPromptCount > 6) {
                popupMessage.textContent = 'You have used all your anonymous credits. Please sign in to continue using Nexora Cognitia.';
                loginPopup.classList.add('active');
                return;
            }
        }

        // Hide empty chat screen on first message
        if (emptyChat && !emptyChat.classList.contains('hidden')) {
            emptyChat.classList.add('hidden');
        }

        // If this is the first message, update the title and store initial prompt
        if (allMessages.length === 0) {
            initialPrompt = message;
            updateDocumentTitle(initialPrompt);
        }

        // Create new conversation if needed
        if (!currentConversationId) {
            try {
                currentConversationId = await createNewConversation(message);
            } catch (error) {
                console.error('Error creating conversation:', error);
                showToast('Error creating conversation');
            }
        }

        // Add message to UI
        const messageId = await addMessageToChat('user', message);
        userInput.value = '';
        
        // Store for search functionality
        allMessages.push({
            id: messageId,
            role: 'user',
            content: message,
            timestamp: new Date()
        });
        
        // Save message to storage
        saveMessageToFirestore(currentConversationId, 'USER', message)
            .then(id => {
                // Update the message ID in allMessages
                for (let i = 0; i < allMessages.length; i++) {
                    if (allMessages[i].role === 'user' && allMessages[i].content === message) {
                        allMessages[i].id = id;
                        break;
                    }
                }
            })
            .catch(error => console.error('Error saving message:', error));
        
        // Get bot response
        getBotResponse(message);
        
        // Update credit usage (approximately 1 credit per message for anonymous, 0.05 for signed-in)
        if (isAnonymous) {
            creditsUsed += 1; // 1 credit per message for anonymous
            localStorage.setItem('anonymousCreditsUsed', creditsUsed);
            console.log('Anonymous credits used (after user message):', creditsUsed);
        } else {
            creditsUsed += 0.05; // $0.05 per message for signed-in
            console.log('Signed-in user credits used (after user message):', creditsUsed);
            saveCreditsToStorage(); // Save to Firestore immediately
        }
        
        // Update UI
        updateCreditBar();
        forceUpdateCreditDisplay(); // Force update the UI
    }

    async function addMessageToChat(sender, message, animate = true, messageId = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        
        if (sender === 'user') {
            avatar.classList.add('user-avatar-chat');
            
            if (currentUser && !currentUser.isAnonymous && currentUser.photoURL) {
                const img = document.createElement('img');
                img.src = currentUser.photoURL;
                img.alt = currentUser.displayName || 'User';
                avatar.innerHTML = '';
                avatar.appendChild(img);
            } else {
                avatar.textContent = 'U';
            }
        } else {
            const img = document.createElement('img');
            img.src = 'Nexora.png';
            img.alt = 'Nexora';
            avatar.appendChild(img);
        }

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        // Store message ID if provided
        if (messageId) {
            messageContent.dataset.messageId = messageId;
        }

        if (sender === 'user') {
            // Add message actions for user messages
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            messageActions.innerHTML = `
                <button class="message-action-btn edit-btn" title="Edit message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                    </svg>
                </button>
                <button class="message-action-btn copy-btn" title="Copy message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                    </svg>
                </button>
            `;
            
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageActions);
            
            // For user messages, display immediately
            if (message.includes('\`\`\`')) {
                let parts = message.split('\`\`\`');
                let formattedMessage = '';
                for (let i = 0; i < parts.length; i++) {
                    formattedMessage += i % 2 === 0 ? parts[i] : `<pre><code>${parts[i]}</code></pre>`;
                }
                messageContent.innerHTML = formattedMessage;
            } else {
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
            }
            
            // Add edit functionality
            const editBtn = messageDiv.querySelector('.edit-btn');
            if (editBtn) {
                editBtn.addEventListener('click', () => {
                    editPromptTextarea.value = message;
                    currentEditingMessageId = messageContent.dataset.messageId;
                    editModal.classList.add('active');
                });
            }
            
            // Add copy functionality
            const copyBtn = messageDiv.querySelector('.copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(message)
                        .then(() => {
                            showToast('Message copied to clipboard');
                        })
                        .catch(err => {
                            console.error('Could not copy text: ', err);
                            showToast('Failed to copy message');
                        });
                });
            }
        } else {
            // Add message actions for bot messages
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            messageActions.innerHTML = `
                <button class="message-action-btn copy-btn" title="Copy response">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                    </svg>
                </button>
            `;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageActions);
            
            if (animate) {
                // For bot messages, add thinking dots first
                const thinkingDots = document.createElement('div');
                thinkingDots.className = 'thinking-dots';
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    thinkingDots.appendChild(dot);
                }
                messageContent.appendChild(thinkingDots);
            } else {
                // For loaded messages, display immediately with keyword highlighting
                if (message.includes('\`\`\`')) {
                    let parts = message.split('\`\`\`');
                    let formattedMessage = '';
                    for (let i = 0; i < parts.length; i++) {
                        if (i % 2 === 0) {
                            // Apply keyword highlighting to regular text
                            formattedMessage += highlightKeywords(parts[i]);
                        } else {
                            formattedMessage += `<pre><code>${parts[i]}</code></pre>`;
                        }
                    }
                    messageContent.innerHTML = formattedMessage;
                } else {
                    // Apply keyword highlighting
                    messageContent.innerHTML = highlightKeywords(message);
                }
                
                // Add copy functionality
                const copyBtn = messageDiv.querySelector('.copy-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        navigator.clipboard.writeText(message)
                            .then(() => {
                                showToast('Response copied to clipboard');
                            })
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                showToast('Failed to copy response');
                            });
                    });
                }
            }
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Generate a temporary ID if none provided
        if (!messageId) {
            messageId = 'temp-' + Date.now();
            messageContent.dataset.messageId = messageId;
        }
        
        return messageId;
    }

    // Function to highlight keywords in bot responses
    function highlightKeywords(text) {
        // List of keywords to highlight (can be expanded)
        const keywords = [
            'AI', 'machine learning', 'neural network', 'algorithm', 'data', 
            'analysis', 'processing', 'intelligence', 'model', 'training',
            'Nexora', 'chatbot', 'assistant', 'help', 'support', 'information',
            'important', 'critical', 'essential', 'key', 'significant', 'vital',
            'recommend', 'suggest', 'advise', 'consider', 'note', 'remember',
            'feature', 'function', 'capability', 'integration', 'connection',
            'security', 'privacy', 'encryption', 'protected', 'confidential'
        ];
        
        // Replace newlines with <br> tags
        let formattedText = text.replace(/\n/g, '<br>');
        
        // Highlight each keyword
        keywords.forEach(keyword => {
            const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
            formattedText = formattedText.replace(regex, '<span class="keyword">$1</span>');
        });
        
        return formattedText;
    }

    // Function to type out message word by word
    async function typeMessage(element, message) {
        if (!element) return; // Guard against null element
        
        isGenerating = true;
        shouldStop = false;
        sendButton.style.display = 'none';
        stopButton.classList.add('visible');
        
        // Clear thinking dots
        element.innerHTML = '';
        
        // Check if message contains code blocks
        if (message.includes('\`\`\`')) {
            let parts = message.split('\`\`\`');
            for (let i = 0; i < parts.length; i++) {
                if (i % 2 === 0) {
                    // Regular text with keyword highlighting
                    await typeTextWordByWord(element, parts[i], true);
                } else {
                    // Code block
                    if (shouldStop) break;
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    pre.appendChild(code);
                    element.appendChild(pre);
                    await typeTextWordByWord(code, parts[i], false);
                }
            }
        } else {
            // Regular text with keyword highlighting
            await typeTextWordByWord(element, message, true);
        }
        
        // Add cursor at the end
        const cursor = document.createElement('span');
        cursor.className = 'cursor';
        element.appendChild(cursor);
        
        isGenerating = false;
        stopButton.classList.remove('visible');
        sendButton.style.display = 'flex';
        regenerateButton.classList.add('visible');
        
        // Add copy functionality to the message
        const messageDiv = element.closest('.message');
        if (messageDiv) {
            const copyBtn = messageDiv.querySelector('.copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(message)
                        .then(() => {
                            showToast('Response copied to clipboard');
                        })
                        .catch(err => {
                            console.error('Could not copy text: ', err);
                            showToast('Failed to copy response');
                        });
                });
            }
        }
    }
    
    // Function to type text word by word
    async function typeTextWordByWord(element, text, highlightKeywords = false) {
        if (!element) return; // Guard against null element
        
        // List of keywords to highlight
        const keywords = [
            'AI', 'machine learning', 'neural network', 'algorithm', 'data', 
            'analysis', 'processing', 'intelligence', 'model', 'training',
            'Nexora', 'chatbot', 'assistant', 'help', 'support', 'information',
            'important', 'critical', 'essential', 'key', 'significant', 'vital',
            'recommend', 'suggest', 'advise', 'consider', 'note', 'remember',
            'feature', 'function', 'capability', 'integration', 'connection',
            'security', 'privacy', 'encryption', 'protected', 'confidential'
        ];
        
        const words = text.split(' ');
        for (let i = 0; i < words.length; i++) {
            if (shouldStop) break;
            
            const word = words[i];
            
            // Handle newlines
            if (word.includes('\n')) {
                const parts = word.split('\n');
                for (let j = 0; j < parts.length; j++) {
                    if (j > 0) {
                        element.appendChild(document.createElement('br'));
                    }
                    if (parts[j].length > 0) {
                        const partSpan = document.createElement('span');
                        
                        // Check if this word should be highlighted
                        if (highlightKeywords && keywords.some(keyword => 
                            keyword.toLowerCase() === parts[j].toLowerCase() ||
                            keyword.toLowerCase() === parts[j].toLowerCase().replace(/[.,!?;:]/g, '')
                        )) {
                            partSpan.className = 'keyword';
                        }
                        
                        partSpan.textContent = parts[j];
                        element.appendChild(partSpan);
                        if (j < parts.length - 1 || i < words.length - 1) {
                            element.appendChild(document.createTextNode(' '));
                        }
                    }
                }
            } else {
                const wordSpan = document.createElement('span');
                
                // Check if this word should be highlighted
                if (highlightKeywords && keywords.some(keyword => 
                    keyword.toLowerCase() === word.toLowerCase() ||
                    keyword.toLowerCase() === word.toLowerCase().replace(/[.,!?;:]/g, '')
                )) {
                    wordSpan.className = 'keyword';
                }
                
                wordSpan.textContent = word;
                element.appendChild(wordSpan);
                if (i < words.length - 1) {
                    element.appendChild(document.createTextNode(' '));
                }
            }
            
            const networkQuality = Math.random(); // Simulate network quality (0-1)
            const adjustedSpeed = Math.max(10, Math.min(100, typingSpeed * (1 + (1 - networkQuality))));
            
            await new Promise(resolve => setTimeout(resolve, adjustedSpeed));
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    async function getBotResponse(userMessage) {
        try {
            console.log('Sending request to backend:', {
                message: userMessage,
                chat_history: []
            });
            
            // Show stop button while waiting for response
            stopButton.classList.add('visible');
            sendButton.style.display = 'none';
            
            // Create bot message with thinking dots
            const botMessageContent = await addMessageToChat('bot', '');
            currentMessageElement = document.querySelector(`[data-message-id="${botMessageContent}"]`);
            
            const response = await fetch('https://nexora-backend-1.onrender.com/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    chat_history: [],
                    model: 'command',
                    connectors: []
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Backend error:', response.status, errorText);
                await typeMessage(currentMessageElement, `Error: Server returned status ${response.status}. Please try again later.`);
                return;
            }

            const data = await response.json();
            console.log('Backend response:', data);

            if (data && data.text) {
                // Estimate token count for credit calculation
                const tokenEstimate = data.text.split(/\s+/).length * 1.5;
                
                // Type out the response
                await typeMessage(currentMessageElement, data.text);
                
                // Save the bot response to storage
                if (currentConversationId) {
                    const messageId = await saveMessageToFirestore(currentConversationId, 'CHATBOT', data.text);
                    
                    // Store for search functionality
                    allMessages.push({
                        id: messageId,
                        role: 'bot',
                        content: data.text,
                        timestamp: new Date()
                    });
                }
                
                // Update credit usage based on response length
                if (isAnonymous) {
                    creditsUsed += Math.ceil(tokenEstimate / 500);
                    localStorage.setItem('anonymousCreditsUsed', creditsUsed);
                    console.log('Anonymous credits used (after bot response):', creditsUsed);
                } else {
                    const responseCredit = tokenEstimate * 0.0001;
                    creditsUsed += responseCredit;
                    console.log('Signed-in user credits used (after bot response):', creditsUsed, 'for', tokenEstimate, 'tokens');
                    saveCreditsToStorage();
                }
                
                // Update UI
                updateCreditBar();
                forceUpdateCreditDisplay(); // Force update the UI
            } else {
                await typeMessage(currentMessageElement, "I'm sorry, I couldn't generate a response. Please try again.");
            }
        } catch (error) {
            console.error('Error getting bot response:', error);
            if (currentMessageElement) {
                await typeMessage(currentMessageElement, "I'm sorry, there was an error processing your request. Please try again later.");
            }
        }
    }

    // Initialize the app
    // Load saved theme
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
    }
    
    // Initialize credit display
    updateCreditBar();
    forceUpdateCreditDisplay();
    
    // Debug function to log credit state
    window.debugCredits = function() {
        console.log({
            userCredits,
            creditsUsed,
            remaining: userCredits - creditsUsed,
            isAnonymous,
            lastCreditReset,
            lowCreditWarningShown,
            firestoreAvailable
        });
        
        // Force update the UI
        forceUpdateCreditDisplay();
    };
});
    </script>
</body>
</html>
