<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>nexora</title>
  <link rel="icon" href="nexora.png">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --background: #000000;
      --text: #ffffff;
      --secondary-text: #aaaaaa;
      --user-bubble: #4a4a4a;
      --dropdown-bg: rgba(26, 28, 30, 0.9);
      --input-bg: #1a1a1a;
      --border: #333333;
      --accent-blue: rgb(63, 159, 255);
      --accent-purple: rgb(156, 77, 255);
      --accent-hot-pink: rgb(255, 77, 156);
      --accent-magenta: rgb(255, 46, 178);
      --accent-rose-pink: rgb(255, 118, 178);
      --accent-deep-violet: rgb(106, 0, 255);
      --preview-bg: #1a1a1a;
      --code-bg: #2a2a2a;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --background: #ffffff;
        --text: #1a1a1a;
        --secondary-text: #666666;
        --user-bubble: #d3d3d3;
        --dropdown-bg: rgba(255, 255, 255, 0.9);
        --input-bg: #f5f5f5;
        --border: #cccccc;
        --accent-blue: rgb(63, 159, 255);
        --accent-purple: rgb(156, 77, 255);
        --accent-hot-pink: rgb(255, 77, 156);
        --accent-magenta: rgb(255, 46, 178);
        --accent-rose-pink: rgb(255, 118, 178);
        --accent-deep-violet: rgb(106, 0, 255);
        --preview-bg: #f5f5f5;
        --code-bg: #f5f5f5;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', sans-serif;
      background: var(--background);
      color: var(--text);
      height: 100vh;
      display: flex;
      overflow-y: hidden;
    }

    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      gap: 0;
      position: relative;
      height: 100vh;
    }

    .header {
      padding: 10px 20px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      z-index: 5;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .header-title:hover {
      color: var(--accent-purple);
    }

    .header-upgrade {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upgrade-container {
      background: var(--dropdown-bg);
      border-radius: 12px;
      padding: 4px;
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
    }

    .header-upgrade button {
      display: flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: 2px solid var(--accent-blue);
      border-radius: 8px;
      padding: 6px 12px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      font-family: 'Google Sans', sans-serif;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .header-upgrade button:hover {
      background: rgba(63, 159, 255, 0.1);
      color: var(--accent-rose-pink);
    }

    .header-upgrade span.material-icons {
      font-size: 18px;
    }

    .profile-picture {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .main-content {
      flex: 1;
      background: var(--background);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .model-selector-container {
      position: relative;
      width: auto;
    }

    .model-selector {
      background: transparent;
      border: none;
      color: var(--text);
      padding: 2px 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .model-selector:hover {
      color: var(--accent-purple);
    }

    .model-selector span.material-icons {
      font-size: 18px;
    }

    .model-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--dropdown-bg);
      backdrop-filter: blur(12px);
      border-radius: 12px;
      margin-top: 4px;
      z-index: 10;
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: none;
      width: auto;
      min-width: 250px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    .model-dropdown.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .model-dropdown::-webkit-scrollbar {
      display: none;
    }

    .model-option {
      background: transparent;
      padding: 10px 14px;
      margin: 2px 4px;
      cursor: pointer;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      opacity: 0;
      transform: translateY(10px);
    }

    .model-dropdown.active .model-option {
      opacity: 1;
      transform: translateY(0);
    }

    .model-dropdown.active .model-option:nth-child(1) { transition-delay: 0s; }
    .model-dropdown.active .model-option:nth-child(2) { transition-delay: 0.05s; }
    .model-dropdown.active .model-option:nth-child(3) { transition-delay: 0.1s; }
    .model-dropdown.active .model-option:nth-child(4) { transition-delay: 0.15s; }
    .model-dropdown.active .model-option:nth-child(5) { transition-delay: 0.2s; }
    .model-dropdown.active .model-option:nth-child(6) { transition-delay: 0.25s; }
    .model-dropdown.active .model-option:nth-child(7) { transition-delay: 0.3s; }

    .model-option.upgrade-option {
      flex-direction: column;
      align-items: flex-start;
    }

    .model-option:hover {
      background: rgba(63, 159, 255, 0.1);
    }

    .model-option-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      flex-grow: 1;
    }

    .model-option-desc {
      font-size: 12px;
      color: var(--secondary-text);
      margin-top: 4px;
    }

    .upgrade-badge {
      background: var(--accent-hot-pink);
      color: var(--text);
      font-size: 10px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 10px;
      margin-bottom: 4px;
    }

    @media (max-width: 768px) {
      .model-dropdown {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 70vh;
        border-radius: 16px 16px 0 0;
        margin: 0;
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
      }

      .model-dropdown.active {
        transform: translateY(0);
      }

      .model-option {
        padding: 14px 18px;
        margin: 4px 8px;
      }
    }

    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: var(--dropdown-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--accent-blue);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 1002;
      max-width: 800px;
      width: 95%;
      text-align: left;
      opacity: 0;
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    .popup.active {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .popup-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-purple);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .popup-title::before {
      content: '‚ö†Ô∏è';
      font-size: 20px;
    }

    .popup-content {
      font-size: 14px;
      color: var(--secondary-text);
      line-height: 1.5;
      margin-bottom: 16px;
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: none;
    }

    .popup-content::-webkit-scrollbar {
      display: none;
    }

    .popup-content h3 {
      color: var(--text);
      font-size: 15px;
      margin: 12px 0 6px;
    }

    .popup-content ul {
      padding-left: 20px;
      margin: 6px 0;
    }

    .popup-content li {
      margin-bottom: 8px;
    }

    .popup-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .popup-button {
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .popup-button.continue {
      background: var(--accent-blue);
      color: var(--text);
    }

    .popup-button.continue:hover {
      background: var(--accent-rose-pink);
      transform: scale(1.05);
    }

    .popup-button.cancel {
      background: var(--input-bg);
      color: var(--text);
    }

    .popup-button.cancel:hover {
      background: var(--accent-hot-pink);
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .popup {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        max-height: 50vh;
        border-radius: 16px 16px 0 0;
        padding: 16px;
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
      }

      .popup.active {
        transform: translateY(0);
      }

      .popup-title {
        font-size: 18px;
        margin-bottom: 8px;
      }

      .popup-title::before {
        font-size: 18px;
      }

      .popup-content {
        font-size: 13px;
        line-height: 1.4;
        margin-bottom: 12px;
        max-height: 200px;
      }

      .popup-content h3 {
        font-size: 14px;
        margin: 8px 0 4px;
      }

      .popup-content ul {
        padding-left: 16px;
        margin: 4px 0;
      }

      .popup-content li {
        margin-bottom: 6px;
      }

      .popup-buttons {
        gap: 8px;
      }

      .popup-button {
        padding: 8px 16px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .popup {
        padding: 12px;
      }

      .popup-title {
        font-size: 16px;
      }

      .popup-content {
        font-size: 12px;
        max-height: 180px;
      }

      .popup-button {
        padding: 8px 12px;
        font-size: 12px;
      }
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-bottom: 0;
      overflow-y: hidden;
      position: relative;
      -webkit-overflow-scrolling: touch;
    }

    .chat-area.active {
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      mask-image: linear-gradient(
        to bottom,
        transparent 0%,
        black 20px,
        black calc(100% - 20px),
        transparent 100%
      );
    }

    .chat-area.active::-webkit-scrollbar {
      display: none;
    }

    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
    }

    .welcome-title {
      font-size: 48px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .welcome-title .highlight {
      color: var(--accent-purple);
    }

    .welcome-subtitle {
      font-size: 48px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text);
    }

    .welcome-subtitle .highlight {
      color: var(--accent-purple);
    }

    .welcome-description {
      font-size: 16px;
      color: var(--text);
      margin-bottom: 40px;
      line-height: 1.5;
    }

    .messages {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }

    .message-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 70%;
    }

    .message-group.user {
      align-self: flex-end;
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-group.assistant {
      align-self: flex-start;
      text-align: left;
    }

    @media (min-width: 769px) {
      .message-group.assistant {
        margin-left: 130px;
      }
    }

    @media (max-width: 768px) {
      .message-group.assistant {
        margin-left: 0;
      }
    }

    .message-content {
      font-size: 16px;
      line-height: 1.6;
      color: var(--text);
      padding: 0;
      width: auto;
    }

    .message-group.user .message-content {
      background: var(--user-bubble);
      padding: 16px 20px;
      border-radius: 20px 20px 4px 20px;
      color: var(--text);
      font-weight: 500;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      max-width: fit-content;
      word-wrap: break-word;
    }

    .message-group.assistant .message-content {
      background: none;
      padding: 0;
      border-radius: 0;
      border: none;
      box-shadow: none;
    }

    .message-image {
      max-width: 280px;
      max-height: 280px;
      border-radius: 16px;
      margin-bottom: 12px;
      object-fit: cover;
      border: 2px solid var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      align-self: flex-end;
    }

    .message-audio {
      width: 100%;
      max-width: 300px;
      margin-bottom: 12px;
      border-radius: 8px;
      background: var(--input-bg);
      align-self: flex-end;
    }

    .message-audio::-webkit-media-controls-panel {
      background-color: var(--input-bg);
    }

    .thinking-process {
      font-style: italic;
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 12px;
      border-radius: 12px;
      padding: 16px;
      border-left: 4px solid var(--accent-hot-pink);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .thinking-process details {
      cursor: pointer;
    }

    .thinking-process summary {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
      font-weight: 400;
      font-size: 14px;
      padding: 4px;
      margin-bottom: 0;
      transition: color 0.2s ease;
      list-style: none;
      outline: none;
    }

    .thinking-process summary::-webkit-details-marker {
      display: none;
    }

    .thinking-process summary:hover {
      color: var(--accent-rose-pink);
    }

    .thinking-process details[open] summary {
      margin-bottom: 12px;
    }

    .thinking-content {
      color: var(--secondary-text);
      font-style: italic;
      line-height: 1.4;
      margin-top: 8px;
    }

    .thinking-chevron {
      transition: transform 0.2s ease;
      font-size: 18px;
      transform: rotate(90deg);
    }

    .thinking-process details[open] .thinking-chevron {
      transform: rotate(0deg);
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0;
      max-width: 70%;
      align-self: flex-start;
    }

    @media (min-width: 769px) {
      .typing-indicator {
        margin-left: 130px;
      }
    }

    @media (max-width: 768px) {
      .typing-indicator {
        margin-left: 0;
      }
    }

    .typing-dots {
      display: flex;
      gap: 2px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-purple);
      animation: typingPulse 1.2s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingPulse {
      0%, 60%, 100% {
        opacity: 0.3;
      }
      30% {
        opacity: 1;
      }
    }

    .reference-text {
      font-size: 12px;
      color: var(--secondary-text);
      text-align: center;
      margin: 4px 0;
    }

    .input-area {
      padding: 10px;
      position: relative;
      z-index: 100;
    }

    @media (max-width: 768px) {
      .input-area {
        padding: 8px 8px 24px; /* Further increased bottom padding */
        position: sticky;
        bottom: 0;
        background: var(--background);
        z-index: 200;
        margin-bottom: calc(env(safe-area-inset-bottom) + 10px); /* Added extra margin */
      }

      .reference-text {
        font-size: 10px;
        opacity: 0.7;
        margin-top: 12px; /* Further increased margin */
        display: block;
        text-align: center;
      }
    }

    .input-container {
      max-width: 800px;
      margin: 0 auto;
      position: relative;
    }

    .input-preview {
      margin-bottom: 8px;
      padding: 8px;
      background: var(--preview-bg);
      border-radius: 16px;
      border: 1px solid var(--border);
      display: none;
    }

    .input-preview.active {
      display: block;
    }

    .preview-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .preview-item:last-child {
      margin-bottom: 0;
    }

    .preview-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .preview-audio {
      flex: 1;
      height: 40px;
      border-radius: 8px;
    }

    .preview-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .preview-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    .preview-size {
      font-size: 12px;
      color: var(--secondary-text);
    }

    .preview-remove {
      width: 24px;
      height: 24px;
      border: none;
      background: var(--accent-hot-pink);
      color: var(--text);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .preview-remove:hover {
      background: var(--accent-rose-pink);
      transform: scale(1.1);
    }

    .input-wrapper {
      background: var(--input-bg);
      border: 2px solid var(--border);
      border-radius: 24px;
      padding: 12px 20px;
      transition: all 0.2s ease;
      display: flex;
      align-items: flex-end;
      gap: 12px;
      min-height: 48px;
    }

    .input-wrapper:focus-within {
      border-color: var(--accent-purple);
      box-shadow: 0 0 0 3px rgba(156, 77, 255, 0.2);
    }

    .input-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-top {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #prompt {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      font-family: inherit;
      font-size: 16px;
      color: var(--text);
      resize: none;
      min-height: 24px;
      max-height: 150px;
      overflow-y: auto;
      scrollbar-width: none;
    }

    #prompt::-webkit-scrollbar {
      display: none;
    }

    #prompt::placeholder {
      color: var(--secondary-text);
    }

    .input-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .input-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-button {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--secondary-text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      border-radius: 6px;
    }

    .control-button:hover {
      color: var(--accent-blue);
      background: rgba(63, 159, 255, 0.1);
    }

    .control-button.active {
      color: var(--accent-hot-pink);
      background: rgba(255, 77, 156, 0.1);
    }

    .control-button.recording {
      color: var(--accent-magenta);
      background: rgba(255, 46, 178, 0.2);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .char-counter {
      color: var(--secondary-text);
      font-size: 12px;
      font-weight: 500;
    }

    .send-button {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--accent-blue);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .send-button:hover:not(:disabled) {
      color: var(--accent-rose-pink);
      transform: scale(1.1);
    }

    .send-button:disabled {
      color: var(--secondary-text);
      cursor: not-allowed;
      transform: none;
    }

    .stop-button {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--accent-hot-pink);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .stop-button:hover {
      color: var(--accent-rose-pink);
      transform: scale(1.1);
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 5px;
      }

      .chat-area {
        padding: 5px;
        padding-bottom: 0;
      }

      .welcome-title,
      .welcome-subtitle {
        font-size: 28px;
      }

      .header-title {
        font-size: 18px;
      }

      .header {
        padding: 5px 10px;
        gap: 8px;
      }

      .message-group {
        max-width: 90%;
      }

      .header-upgrade {
        display: none;
      }

      .upgrade-container {
        background: var(--dropdown-bg);
        border-radius: 12px;
        padding: 4px;
        border: 1px solid var(--border);
      }

      .header-upgrade button {
        font-size: 12px;
        padding: 4px 8px;
      }

      .input-wrapper {
        padding: 8px 16px;
        min-height: 40px;
      }

      .input-preview {
        margin-bottom: 4px;
        padding: 4px;
      }

      .send-button, .stop-button {
        width: 36px;
        height: 36px;
      }
    }

    .message-content strong {
      font-weight: 700;
    }

    .message-content em {
      font-style: italic;
    }

    .message-content code {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
      background: var(--code-bg);
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 14px;
      color: var(--accent-deep-violet);
    }

    .message-content pre {
      background: var(--code-bg);
      padding: 16px;
      border-radius: 12px;
      overflow-x: auto;
      margin: 12px 0;
      border: 1px solid var(--border);
    }

    .message-content pre code {
      background: transparent;
      padding: 0;
      color: var(--text);
    }

    .message-content ul,
    .message-content ol {
      padding-left: 20px;
      margin: 12px 0;
    }

    .message-content li {
      margin-bottom: 4px;
    }

    .message-content p {
      margin-bottom: 12px;
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="popup" id="rogueMiniPopup">
      <div class="popup-title">Notice of Usage: nexora-X RogueMini 8B</div>
      <div class="popup-content">
        <p>RogueMini is an unfiltered model for unconventional interactions. Key risks:</p>
        <ul>
          <li><strong>Unpredictable Outputs</strong>: May be inappropriate or off-topic.</li>
          <li><strong>Not for Sensitive Topics</strong>: Humor may trivialize serious subjects.</li>
          <li><strong>Not Child-Friendly</strong>: May include mature themes or language.</li>
        </ul>
        <p>Best for humorous, non-sensitive contexts. For standard queries, use nexora Cerebrus-X or others.</p>
      </div>
      <div class="popup-buttons">
        <button class="popup-button cancel" id="rogueMiniCancel">Stick to this model</button>
        <button class="popup-button continue" id="rogueMiniContinue">Proceed with RogueMini</button>
      </div>
    </div>

    <div class="main-content" id="mainContent">
      <div class="header">
        <div class="header-left">
          <div class="header-title" onclick="startNewChat()">nexora</div>
          <div class="model-selector-container">
            <div class="model-selector" id="modelSelector">
              <span id="selectedModelName">Model nexora Cerebrus-X V3 34B</span>
              <span class="material-icons">arrow_drop_down</span>
            </div>
            <div class="model-dropdown" id="modelDropdown">
              <div class="model-option" data-value="accounts/fireworks/models/qwen3-30b-a3b">
                <div class="model-option-name">nexora Cerebrus-X </div>
                <div class="model-option-desc">Advanced reasoning for complex problem-solving and logical analysis.</div>
              </div>
              <div class="model-option" data-value="accounts/sentientfoundation-serverless/models/dobby-mini-unhinged-plus-llama-3-1-8b">
                <div class="model-option-name">nexora-X RogueMini 8B</div>
                <div class="model-option-desc">Unhinged, creative responses with a bold and unconventional style.</div>
              </div>
              <div class="model-option" data-value="accounts/fireworks/models/llama-v3p1-8b-instruct">
                <div class="model-option-name">nexora Lip Instruct</div>
                <div class="model-option-desc">Literal, concise answers focused on clarity and directness.</div>
              </div>
              <div class="model-option" data-value="accounts/fireworks/models/llama4-scout-instruct-basic">
                <div class="model-option-name">nexora PetalFlow</div>
                <div class="model-option-desc">Beautified, eloquent responses with a focus on aesthetic and engaging language.</div>
              </div>
              <div class="model-option" data-value="accounts/fireworks/models/llama4-maverick-instruct-basic">
                <div class="model-option-name">nexora Casanova Scout </div>
                <div class="model-option-desc">Multimodal model for text and image understanding with superior reasoning.</div>
              </div>
              <div class="model-option" data-value="accounts/fireworks/models/streaming-speech">
                <div class="model-option-name">nexora Resonance</div>
                <div class="model-option-desc">Speech-to-text transcription and voice interaction capabilities.</div>
              </div>
              <div class="model-option upgrade-option" data-value="upgrade" onclick="window.location.href='/pricing'">
                <span class="upgrade-badge">Upgrade</span>
                <div class="model-option-name">nexora Apex-Pro</div>
                <div class="model-option-desc">Our smartest model for unparalleled reasoning and insights. Requires premium access.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="header-upgrade">
          <div class="upgrade-container">
            <button onclick="window.location.href='https://nexora.ai/upgrade'">
              <span class="material-icons">keyboard_double_arrow_up</span>
              Upgrade
            </button>
          </div>
          <img id="profilePicture" class="profile-picture" src="" alt="Profile Picture">
        </div>
      </div>
      <div class="chat-area" id="chatArea">
        <div class="welcome-screen" id="welcomeScreen">
          <h1 class="welcome-title">Hi there, <span class="highlight" id="userFirstName">User</span></h1>
          <h2 class="welcome-subtitle">What would <span class="highlight">you like to know?</span></h2>
        </div>
        <div class="messages" id="messages" style="display: none;">
        </div>
      </div>

      <div class="input-area">
        <div class="input-container">
          <div class="input-preview" id="inputPreview">
          </div>
          <div class="input-wrapper">
            <div class="input-main">
              <div class="input-top">
                <textarea 
                  id="prompt" 
                  placeholder="Ask nexora whatever you want..."
                  rows="1"
                ></textarea>
              </div>
              <div class="input-bottom">
                <div class="input-controls">
                  <button class="control-button" id="imageUploadButton" title="Upload Image">
                    <span class="material-icons">add_a_photo</span>
                  </button>
                  <button class="control-button" id="audioUploadButton" title="Upload Audio">
                    <span class="material-icons">transcribe</span>
                  </button>
                  <button class="control-button" id="microphoneButton" title="Voice Input">
                    <span class="material-icons">settings_voice</span>
                  </button>
                </div>
                <div class="char-counter" id="charCounter">0/1000</div>
              </div>
            </div>
            <button class="send-button" id="sendButton">
              <span class="material-icons">send</span>
            </button>
            <button class="stop-button" id="stopButton" style="display: none;">
              <span class="material-icons">stop</span>
            </button>
          </div>
        </div>
        <div class="reference-text">For Reference Only</div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase functions
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCB1DwFSwQLDOlUFtWQtUvqOWPnI1HrP5E",
      authDomain: "messenger-7c40c.firebaseapp.com",
      projectId: "messenger-7c40c",
      storageBucket: "messenger-7c40c.firebasestorage.app",
      messagingSenderId: "435817942279",
      appId: "1:435817942279:web:36b3f65e6358d8aa0a49a2",
      measurementId: "G-HJ094HC4F2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Check auth state and update UI
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in
        console.log('User is signed in:', user.displayName);
        const firstName = user.displayName ? user.displayName.split(' ')[0] : 'User';
        document.getElementById('userFirstName').textContent = firstName;
        const profilePicture = document.getElementById('profilePicture');
        profilePicture.src = user.photoURL || 'https://via.placeholder.com/32';
        profilePicture.style.display = 'block';
      } else {
        // No user is signed in, redirect to sign-in.html
        console.log('No user is signed in, redirecting to sign-in.html');
        window.location.href = 'sign-in.html';
      }
    });

    // Existing JavaScript code
    const chatArea = document.getElementById('chatArea');
    const messagesContainer = document.getElementById('messages');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const promptInput = document.getElementById('prompt');
    const sendButton = document.getElementById('sendButton');
    const stopButton = document.getElementById('stopButton');
    const charCounter = document.getElementById('charCounter');
    const modelSelector = document.getElementById('modelSelector');
    const modelDropdown = document.getElementById('modelDropdown');
    const selectedModelName = document.getElementById('selectedModelName');
    const mainContent = document.getElementById('mainContent');
    const imageUploadButton = document.getElementById('imageUploadButton');
    const audioUploadButton = document.getElementById('audioUploadButton');
    const microphoneButton = document.getElementById('microphoneButton');
    const inputPreview = document.getElementById('inputPreview');
    const rogueMiniPopup = document.getElementById('rogueMiniPopup');
    const rogueMiniContinue = document.getElementById('rogueMiniContinue');
    const rogueMiniCancel = document.getElementById('rogueMiniCancel');
    
    let isLoading = false;
    let currentChatId = null;
    let selectedModelValue = 'accounts/fireworks/models/qwen3-30b-a3b';
    let previousModelValue = selectedModelValue;
    let previousModelName = 'nexora Cerebrus-X V3 34B';
    let uploadedFiles = [];
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let conversationHistory = [];
    let currentAbortController = null;
    let hasSeenRogueMiniPopup = false;
    let isFirstPrompt = true;
    let initialPrompt = '';

    function showRogueMiniPopup() {
      if (!hasSeenRogueMiniPopup) {
        rogueMiniPopup.classList.add('active');
        mainContent.classList.add('blurred');
      } else {
        hasSeenRogueMiniPopup = true;
      }
    }

    rogueMiniContinue.addEventListener('click', () => {
      rogueMiniPopup.classList.remove('active');
      mainContent.classList.remove('blurred');
      hasSeenRogueMiniPopup = true;
    });

    rogueMiniCancel.addEventListener('click', () => {
      selectedModelValue = previousModelValue;
      selectedModelName.textContent = previousModelName;
      rogueMiniPopup.classList.remove('active');
      mainContent.classList.remove('blurred');
      modelDropdown.classList.remove('active');
    });

    modelSelector.addEventListener('click', () => {
      modelDropdown.classList.toggle('active');
    });

    modelDropdown.addEventListener('click', (e) => {
      const option = e.target.closest('.model-option');
      if (option && option.dataset.value !== 'upgrade') {
        previousModelValue = selectedModelValue;
        previousModelName = selectedModelName.textContent;
        selectedModelValue = option.dataset.value;
        selectedModelName.textContent = option.querySelector('.model-option-name').textContent;
        modelDropdown.classList.remove('active');
        if (selectedModelValue === 'accounts/sentientfoundation-serverless/models/dobby-mini-unhinged-plus-llama-3-1-8b') {
          showRogueMiniPopup();
        }
      }
    });

    document.addEventListener('click', (e) => {
      if (!modelSelector.contains(e.target) && !modelDropdown.contains(e.target)) {
        modelDropdown.classList.remove('active');
      }
    });

    promptInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
      
      const length = this.value.length;
      charCounter.textContent = `${length}/1000`;
      charCounter.style.color = length > 1000 ? 'var(--accent-magenta)' : 'var(--secondary-text)';
      sendButton.disabled = length > 1000;
    });

    promptInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendPrompt();
      }
    });

    sendButton.addEventListener('click', sendPrompt);

    stopButton.addEventListener('click', stopResponse);

    imageUploadButton.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.onchange = (e) => {
        Array.from(e.target.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            uploadedFiles.push({
              type: 'image',
              data: event.target.result,
              name: file.name,
              size: formatFileSize(file.size)
            });
            updatePreview();
            selectedModelValue = 'accounts/fireworks/models/llama4-maverick-instruct-basic';
            selectedModelName.textContent = 'nexora Maverick 17B';
            updateButtonStates();
          };
          reader.readAsDataURL(file);
        });
      };
      input.click();
    });

    audioUploadButton.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'audio/*';
      input.multiple = true;
      input.onchange = (e) => {
        Array.from(e.target.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            uploadedFiles.push({
              type: 'audio',
              data: event.target.result,
              name: file.name,
              size: formatFileSize(file.size)
            });
            updatePreview();
            selectedModelValue = 'accounts/fireworks/models/streaming-speech';
            selectedModelName.textContent = 'nexora Speech üé§';
            transcribeUploadedAudio(event.target.result);
            updateButtonStates();
          };
          reader.readAsDataURL(file);
        });
      };
      input.click();
    });

    microphoneButton.addEventListener('click', async () => {
      if (!isRecording) {
        await startRecording();
      } else {
        await stopRecording();
      }
    });

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function updatePreview() {
      if (uploadedFiles.length === 0) {
        inputPreview.classList.remove('active');
        return;
      }

      inputPreview.innerHTML = '';
      uploadedFiles.forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        
        if (file.type === 'image') {
          previewItem.innerHTML = `
            <img src="${file.data}" class="preview-image" alt="${file.name}">
            <div class="preview-info">
              <div class="preview-name">${file.name}</div>
              <div class="preview-size">${file.size}</div>
            </div>
            <button class="preview-remove" onclick="removeFile(${index})">
              <span class="material-icons" style="font-size: 16px;">close</span>
            </button>
          `;
        } else if (file.type === 'audio') {
          previewItem.innerHTML = `
            <audio src="${file.data}" class="preview-audio" controls></audio>
            <div class="preview-info">
              <div class="preview-name">${file.name}</div>
              <div class="preview-size">${file.size}</div>
            </div>
            <button class="preview-remove" onclick="removeFile(${index})">
              <span class="material-icons" style="font-size: 16px;">close</span>
            </button>
          `;
        }
        
        inputPreview.appendChild(previewItem);
      });
      
      inputPreview.classList.add('active');
    }

    function updateButtonStates() {
      window.removeFile = function(index) {
        uploadedFiles.splice(index, 1);
        updatePreview();
        updateButtonStates();
      }
      const hasImages = uploadedFiles.some(f => f.type === 'image');
      const hasAudio = uploadedFiles.some(f => f.type === 'audio');
      
      imageUploadButton.classList.toggle('active', hasImages);
      audioUploadButton.classList.toggle('active', hasAudio);
      sendButton.disabled = !promptInput.value.trim() && uploadedFiles.length === 0;
    }

    async function startRecording() {
      try {
        selectedModelValue = 'accounts/fireworks/models/streaming-speech';
        selectedModelName.textContent = 'nexora Speech üé§';
        
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          const reader = new FileReader();
          reader.onload = async (event) => {
            const transcribedText = await transcribeAudio(audioBlob);
            if (transcribedText) {
              promptInput.value = transcribedText;
              promptInput.dataset.isTranscription = 'true';
              promptInput.dispatchEvent(new Event('input'));
              promptInput.focus();
            }
          };
          reader.readAsDataURL(audioBlob);
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        isRecording = true;
        microphoneButton.classList.add('recording');
        microphoneButton.title = 'Stop Recording';
      } catch (error) {
        console.error('Error accessing microphone:', error);
        alert('Could not access microphone. Please check permissions.');
      }
    }

    async function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        microphoneButton.classList.remove('recording');
        microphoneButton.title = 'Voice Input';
      }
    }

    async function transcribeAudio(audioBlob) {
      try {
        const formData = new FormData();
        formData.append('file', audioBlob, 'audio.wav');
        formData.append('model', 'whisper-1');

        const response = await fetch('https://api.fireworks.ai/inference/v1/audio/transcriptions', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer fw_3ZWXAxAD6BWE4pgQkvkAqem3'
          },
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          return result.text || '';
        } else {
          console.error('Transcription failed:', await response.text());
          return await fallbackSpeechRecognition();
        }
      } catch (error) {
        console.error('Error transcribing audio:', error);
        return await fallbackSpeechRecognition();
      }
    }

    async function transcribeUploadedAudio(audioDataUrl) {
      try {
        const response = await fetch(audioDataUrl);
        const audioBlob = await response.blob();
        
        const transcribedText = await transcribeAudio(audioBlob);
        if (transcribedText) {
          if (!promptInput.value || promptInput.dataset.isTranscription === 'true') {
            promptInput.value = transcribedText;
            promptInput.dataset.isTranscription = 'true';
            promptInput.dispatchEvent(new Event('input'));
            promptInput.focus();
          }
        }
      } catch (error) {
        console.error('Error transcribing uploaded audio:', error);
      }
    }

    function fallbackSpeechRecognition() {
      return new Promise((resolve) => {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          const recognition = new SpeechRecognition();
          
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'en-US';
          
          recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            resolve(transcript);
          };
          
          recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            resolve('');
          };
          
          recognition.start();
        } else {
          resolve('');
        }
      });
    }

    function startNewChat() {
      currentChatId = Date.now().toString();
      messagesContainer.innerHTML = '';
      messagesContainer.style.display = 'none';
      welcomeScreen.style.display = 'flex';
      chatArea.classList.remove('active');
      uploadedFiles = [];
      conversationHistory = [];
      updatePreview();
      updateButtonStates();
      promptInput.value = '';
      promptInput.dataset.isTranscription = 'false';
      promptInput.dispatchEvent(new Event('input'));
      isFirstPrompt = true;
      document.title = 'nexora AI Chat';
      initialPrompt = '';
    }

    function addMessage(content, isUser = false, thinkingProcess = null, files = []) {
      if (welcomeScreen.style.display !== 'none') {
        welcomeScreen.style.display = 'none';
        messagesContainer.style.display = 'flex';
        chatArea.classList.add('active');
      }

      const messageGroup = document.createElement('div');
      messageGroup.className = `message-group ${isUser ? 'user' : 'assistant'}`;
      
      if (isUser && files.length > 0) {
        files.forEach(file => {
          if (file.type === 'image') {
            const imageElement = document.createElement('img');
            imageElement.src = file.data;
            imageElement.className = 'message-image';
            imageElement.alt = file.name;
            messageGroup.appendChild(imageElement);
          } else if (file.type === 'audio') {
            const audioElement = document.createElement('audio');
            audioElement.src = file.data;
            audioElement.className = 'message-audio';
            audioElement.controls = true;
            messageGroup.appendChild(audioElement);
          }
        });
      }
      
      if (thinkingProcess && selectedModelValue.includes('qwen') && !isUser) {
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'thinking-process';
        thinkingDiv.innerHTML = `
          <details>
            <summary>
              <span class="material-icons thinking-chevron">expand_more</span>
              <span>nexora is thinking what to say...</span>
            </summary>
            <div class="thinking-content">${escapeHtml(thinkingProcess)}</div>
          </details>
        `;
        messageGroup.appendChild(thinkingDiv);
      }
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      if (isUser) {
        messageContent.innerHTML = escapeHtml(content);
        conversationHistory.push({
          role: 'user',
          content: content,
          files: files
        });
      } else {
        messageContent.innerHTML = formatResponse(content);
        conversationHistory.push({
          role: 'assistant',
          content: content
        });
      }
      
      messageGroup.appendChild(messageContent);
      messagesContainer.appendChild(messageGroup);
      
      chatArea.scrollTop = chatArea.scrollHeight;
      
      return messageGroup;
    }

    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typingIndicator';
      typingDiv.innerHTML = `
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      messagesContainer.appendChild(typingDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function showTypingAnimation(text, messageElement) {
      const contentDiv = messageElement.querySelector('.message-content');
      contentDiv.innerHTML = '';
      
      let index = 0;
      const typingSpeed = 5;
      
      function typeCharacter() {
        if (index < text.length && !currentAbortController?.signal.aborted) {
          contentDiv.innerHTML = formatResponse(text.substring(0, index + 1));
          index++;
          chatArea.scrollTop = chatArea.scrollHeight;
          setTimeout(typeCharacter, typingSpeed);
        } else {
          contentDiv.innerHTML = formatResponse(text);
          isLoading = false;
          sendButton.style.display = 'flex';
          stopButton.style.display = 'none';
          const thinkingDetails = messageElement.parentElement.querySelector('.thinking-process details');
          if (thinkingDetails) {
            thinkingDetails.open = false;
          }
        }
      }
      
      typeCharacter();
    }

    function extractThinkingProcess(content) {
      const thinkMatch = content.match(/<think>([\s\S]*?)<\/think>/i);
      if (thinkMatch && thinkMatch[1]) {
        return thinkMatch[1].trim();
      }
      return null;
    }

    function formatResponse(text) {
      const cleanedText = text.replace(/<think>[\s\S]*?<\/think>/gi, '');
      
      let formatted = escapeHtml(cleanedText)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/```([a-z]*)\n([\s\S]*?)\n```/g, '<pre><code class="$1">$2</code></pre>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      
      return `<p>${formatted}</p>`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function stopResponse() {
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
      }
      
      hideTypingIndicator();
      isLoading = false;
      sendButton.style.display = 'flex';
      stopButton.style.display = 'none';
      const thinkingDetails = messagesContainer.querySelector('.thinking-process details');
      if (thinkingDetails) {
        thinkingDetails.open = false;
      }
      updateButtonStates();
    }

    async function sendPrompt() {
      const prompt = promptInput.value.trim();
      if ((!prompt && uploadedFiles.length === 0) || isLoading || prompt.length > 1000) return;

      if (!currentChatId) {
        currentChatId = Date.now().toString();
      }
      
      const messageContent = prompt || 'Analyze this content';
      addMessage(messageContent, true, null, [...uploadedFiles]);
      
      if (isFirstPrompt && prompt) {
        isFirstPrompt = false;
        initialPrompt = prompt.length > 60 ? prompt.substring(0, 57) + '...' : prompt;
        document.title = initialPrompt || 'nexora AI Chat';
      }
      
      promptInput.value = '';
      promptInput.dataset.isTranscription = 'false';
      promptInput.style.height = 'auto';
      charCounter.textContent = '0/1000';
      charCounter.style.color = 'var(--secondary-text)';
      
      showTypingIndicator();
      
      isLoading = true;
      sendButton.style.display = 'none';
      stopButton.style.display = 'flex';
      
      currentAbortController = new AbortController();

      try {
        const messages = [];
        
        const recentHistory = conversationHistory.slice(-10);
        recentHistory.forEach(msg => {
          if (msg.role === 'user') {
            const content = [];
            
            if (msg.files && msg.files.length > 0) {
              msg.files.forEach(file => {
                if (file.type === 'image') {
                  content.push({
                    type: 'image_url',
                    image_url: { url: file.data }
                  });
                }
              });
            }
            
            if (msg.content) {
              content.push({
                type: 'text',
                text: msg.content
              });
            }
            
            messages.push({
              role: 'user',
              content: content.length === 1 && content[0].type === 'text' ? msg.content : content
            });
          } else {
            messages.push({
              role: 'assistant',
              content: msg.content
            });
          }
        });

        const currentContent = [];
        
        uploadedFiles.forEach(file => {
          if (file.type === 'image') {
            currentContent.push({
              type: 'image_url',
              image_url: { url: file.data }
            });
          }
        });

        if (prompt) {
          currentContent.push({
            type: 'text',
            text: prompt
          });
        }

        messages.push({
          role: 'user',
          content: currentContent.length === 1 && currentContent[0].type === 'text' ? prompt : currentContent
        });

        const payload = {
          model: selectedModelValue,
          messages: messages,
          temperature: 0.7
        };

        const res = await fetch('https://api.fireworks.ai/inference/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer fw_3ZWXAxAD6BWE4pgQkvkAqem3'
          },
          body: JSON.stringify(payload),
          signal: currentAbortController.signal
        });

        hideTypingIndicator();

        if (!res.ok) {
          const errorText = await res.text();
          console.error('API error:', errorText);
          addMessage(`Error: ${errorText || 'Failed to fetch response'}`);
          isLoading = false;
          sendButton.style.display = 'flex';
          stopButton.style.display = 'none';
          return;
        }

        const data = await res.json();
        const response = data.choices[0].message.content;
        
        const messageElement = addMessage('', false, extractThinkingProcess(response));
        showTypingAnimation(response, messageElement);
        
      } catch (err) {
        if (err.name === 'AbortError') {
          console.log('Request was aborted');
        } else {
          console.error('Request failed:', err.message);
          addMessage(`Error: ${err.message || 'Unexpected error occurred'}`);
        }
        isLoading = false;
        sendButton.style.display = 'flex';
        stopButton.style.display = 'none';
        currentAbortController = null;
      } finally {
        uploadedFiles = [];
        updatePreview();
        updateButtonStates();
      }
    }

    promptInput.addEventListener('input', updateButtonStates);
  </script>
</body>
</html>
