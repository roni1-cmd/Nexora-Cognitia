<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexora Cognitia</title>
    <link rel="icon" href="Nexora.png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6a11cb;
            --secondary-color: #2575fc;
            --text-color: #333;
            --light-text: #f8f9fa;
            --bg-color: #f8f9fa;
            --chat-bg: #ffffff;
            --message-user-bg: linear-gradient(to right, #6a11cb, #2575fc);
            --message-bot-bg: #f8f9fa;
            --border-color: #dee2e6;
            --input-bg: #ffffff;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --sidebar-bg: #f8f9fa;
            --sidebar-text: #333;
            --sidebar-hover: #e9ecef;
            --sidebar-overlay: rgba(0, 0, 0, 0.5);
            --toast-bg: rgba(0, 0, 0, 0.8);
            --toast-text: #fff;
            --search-highlight: #ffeb3b;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --keyword-highlight: #6a11cb;
            --credit-bar-bg: #e9ecef;
            --credit-bar-fill: linear-gradient(to right, #6a11cb, #2575fc);
            --credit-warning: #ff4757;
        }

        [data-theme="dark"] {
            --primary-color: #8a2be2;
            --secondary-color: #4169e1;
            --text-color: #e9ecef;
            --light-text: #f8f9fa;
            --bg-color: #121212;
            --chat-bg: #1e1e2d;
            --message-user-bg: linear-gradient(to right, #8a2be2, #4169e1);
            --message-bot-bg: #2a2a3c;
            --border-color: #2a2a3c;
            --input-bg: #2a2a3c;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --sidebar-bg: #1e1e2d;
            --sidebar-text: #a3a3b5;
            --sidebar-hover: #2a2a3c;
            --sidebar-overlay: rgba(0, 0, 0, 0.7);
            --toast-bg: rgba(255, 255, 255, 0.8);
            --toast-text: #000;
            --search-highlight: #ffd700;
            --modal-bg: rgba(0, 0, 0, 0.8);
            --keyword-highlight: #8a2be2;
            --credit-bar-bg: #2a2a3c;
            --credit-bar-fill: linear-gradient(to right, #8a2be2, #4169e1);
            --credit-warning: #ff4757;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .sidebar-toggle {
            background: transparent;
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--sidebar-overlay);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, background-color 0.3s, color 0.3s;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1001;
            border-radius: 0 20px 20px 0;
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('Corea.png');
            background-size: 1000px;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.2;
            z-index: -1;
            border-radius: 0 20px 20px 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 20px;
            position: relative;
            z-index: 1;
            flex-shrink: 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .sidebar-header:hover {
            background-color: var(--sidebar-hover);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            overflow: hidden;
            position: relative;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-color);
        }

        .user-status {
            font-size: 12px;
            opacity: 0.7;
        }

        .sidebar-sections {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .sidebar-nav {
            padding: 10px 0;
            flex-shrink: 0;
        }

        .sidebar-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
        }

        .sidebar-item:hover {
            background-color: var(--sidebar-hover);
            transform: translateX(5px);
        }

        .sidebar-item.active {
            background-color: var(--sidebar-hover);
            border-left: 3px solid var(--primary-color);
        }

        .sidebar-item-icon {
            margin-right: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .sidebar-item-text {
            flex: 1;
            font-weight: 500;
        }

        .sidebar-item-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .sidebar-divider {
            height: 20px;
            position: relative;
            z-index: 1;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

     

        .conversations-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .conversations-container::-webkit-scrollbar {
            width: 5px;
        }

        .conversations-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversations-container::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }

        .conversations-container::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color);
        }

    .sidebar-footer {
    display: flex !important;
    opacity: 1 !important;
    transform: none !important;
    visibility: visible !important;
}

      .sidebar-footer.visible {
    opacity: 1;
    transform: translateY(0);
}

      .new-features-section {
            margin: 16px 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(106, 17, 203, 0.1), rgba(37, 117, 252, 0.1));
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

         .new-features-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
        }

    .new-features-list {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }


      .new-features-item {
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }   
            .new-features-item::before {
            content: "â€¢";
            color: var(--primary-color);
            font-weight: bold;
        }


        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-left: 0;
            transition: margin-left 0.3s ease;
            width: 100%;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: transparent;
            position: relative;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .logo h1 {
            font-size: 28px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 600;
            transition: all 0.3s ease;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            cursor: pointer;
            width: 40px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            position: relative;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 4px;
        }

        .theme-toggle svg {
            width: 12px;
            height: 12px;
            color: var(--text-color);
            z-index: 1;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        [data-theme="dark"] .theme-toggle {
            background-color: var(--primary-color);
        }

        [data-theme="dark"] .theme-toggle::after {
            transform: translateX(20px);
        }

        .credit-icon {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            transition: background-color 0.2s;
        }

        .credit-icon:hover {
            background-color: var(--sidebar-hover);
        }

        .credit-popup {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: var(--bg-color);
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--box-shadow);
            width: 250px;
            z-index: 1002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .credit-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .credit-popup-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .credit-info {
            margin-bottom: 10px;
        }

        .credit-bar {
            height: 6px;
            background-color: var(--credit-bar-bg);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .credit-bar-fill {
            height: 100%;
            background: var(--credit-bar-fill);
            border-radius: 3px;
            width: 70%;
            transition: width 0.3s;
        }

        .credit-bar-fill.warning {
            background: var(--credit-warning);
        }

        .credit-text {
            font-size: 11px;
            display: flex;
            justify-content: space-between;
        }

        .credit-warning-text {
            color: var(--credit-warning);
            font-size: 11px;
            margin-top: 5px;
            display: none;
        }

        .credit-warning-text.active {
            display: block;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: transparent;
            transition: background-color 0.3s;
            min-height: 0;
            position: relative;
        }

        .empty-chat-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            height: 100%;
            transform: translateY(-10%);
        }

        .empty-chat-container.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .empty-chat-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            border-radius: 50%;
            overflow: hidden;
        }

        .empty-chat-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .empty-chat-title {
            font-size: 3rem;
            font-weight: 600;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .empty-chat-title img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .empty-chat-description {
            font-size: 1.2rem;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--bg-color);
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
            display: flex;
            flex-direction: column-reverse;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color);
        }

        .messages-container {
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            position: relative;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            max-width: 80%;
            padding: 12px 15px;
            line-height: 1.5;
            border-radius: 18px;
            position: relative;
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            color: var(--light-text);
            background: var(--message-user-bg);
            border-radius: 18px;
        }

        .bot-message .message-content {
            color: var(--text-color);
            background-color: transparent;
            border-radius: 18px;
        }

        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            background-color: var(--bg-color);
            border-radius: 15px;
            padding: 3px 8px;
            box-shadow: var(--box-shadow);
            z-index: 5;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .message-action-btn:hover {
            background-color: var(--sidebar-hover);
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar-chat {
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .input-container {
            display: flex;
            padding: 15px;
            background-color: transparent;
            position: relative;
            z-index: 10;
            border-radius: 20px 20px 0 0;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding-right: 90px;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 16px;
            background-color: transparent;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        #user-input::placeholder {
            color: var(--text-color);
            opacity: 0.6;
        }

        .input-buttons {
            position: absolute;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        #send-button, #stop-button, #regenerate-button {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        #send-button:hover, #stop-button:hover, #regenerate-button:hover {
            transform: scale(1.05);
        }

        #stop-button, #regenerate-button {
            display: none;
        }

        #stop-button {
            background: #ff4757;
        }

        #stop-button.visible, #regenerate-button.visible {
            display: flex;
        }

        .thinking-dots {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-color);
            border-radius: 50%;
            margin: 0 3px;
            animation: thinking 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .system-message {
            text-align: center;
            margin: 10px 0;
            color: var(--text-color);
            opacity: 0.7;
            font-style: italic;
        }

        pre {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 15px;
            overflow-x: auto;
            margin: 5px 0;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin-left: 2px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-content {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .search-result-item {
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            background-color: var(--sidebar-hover);
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: var(--border-color);
        }

        .search-highlight {
            background-color: var(--search-highlight);
            padding: 0 2px;
            border-radius: 3px;
        }

        .keyword {
            font-weight: bold;
            color: var(--keyword-highlight);
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup-container {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s;
            position: relative;
        }

        .popup-overlay.active .popup-container {
            transform: translateY(0);
        }

        .popup-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .popup-content {
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .popup-button {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 30px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: transform 0.2s;
        }

        .popup-button:hover {
            transform: scale(1.05);
        }

        .popup-button svg {
            margin-right: 10px;
        }

        .popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .conversation-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
            position: relative;
        }

        .conversation-item:hover {
            background-color: var(--sidebar-hover);
            transform: translateX(5px);
        }

        .conversation-item.active {
            background-color: var(--sidebar-hover);
            border-left: 3px solid var(--primary-color);
        }

        .conversation-icon {
            margin-right: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .conversation-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .conversation-actions {
            position: absolute;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .conversation-action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .conversation-action-btn:hover {
            background-color: var(--sidebar-hover);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--toast-bg);
            color: var(--toast-text);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .toast.active {
            opacity: 1;
            visibility: visible;
        }

        .logout-modal {
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .logout-modal-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .logout-modal-content {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .logout-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .logout-modal-button {
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .logout-modal-button:hover {
            transform: scale(1.05);
        }

        .logout-modal-button.cancel {
            background-color: var(--border-color);
            color: var(--text-color);
            border: none;
        }

        .logout-modal-button.confirm {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }

        .edit-modal-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px 15px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
            resize: vertical;
            font-family: 'Poppins', sans-serif;
        }

        .edit-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .edit-modal-button {
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .edit-modal-button.cancel {
            background-color: var(--border-color);
            color: var(--text-color);
            border: none;
        }

        .edit-modal-button.save {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-color);
            border-radius: 15px;
            box-shadow: var(--box-shadow);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1002;
            margin-top: 10px;
        }

        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 10px;
            margin: 5px;
        }

        .profile-dropdown-item:hover {
            background-color: var(--sidebar-hover);
        }

        .profile-dropdown-item .material-icons {
            margin-right: 10px;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .header {
                padding: 10px 15px;
            }
            
            .logo h1 {
                font-size: 24px;
            }
            
            .empty-chat-title {
                font-size: 2.5rem;
            }
            
            .empty-chat-description {
                font-size: 1rem;
            }
            
            .message-content { 
                max-width: 85%; 
            }
            
            .avatar { 
                width: 30px; 
                height: 30px; 
                margin: 0 5px; 
            }
            
            .input-container {
                padding: 10px;
            }
            
            #user-input {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            #send-button, #stop-button, #regenerate-button {
                width: 30px;
                height: 30px;
            }

            .message-actions {
                top: -25px;
            }

            .credit-popup {
                top: 60px;
                right: 10px;
                width: 220px;
            }
        }

        @media (min-width: 769px) {
            .app-container.sidebar-expanded .main-content {
                margin-left: 280px;
            }
            
            .app-container.sidebar-expanded .sidebar {
                transform: translateX(0);
            }
            
            .app-container:not(.sidebar-expanded) .sidebar {
                transform: translateX(-100%);
            }
        }
    </style>
</head>
<body>
    <div class="app-container" id="app-container">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header" id="sidebar-header">
                <div class="user-avatar" id="sidebar-avatar">
                    <img src="Nexora.png" alt="Nexora Logo" id="user-profile-pic">
                </div>
                <div class="user-info">
                    <div class="user-name" id="user-display-name">nexora</div>
                    <div class="user-status" id="user-status">Free Planning</div>
                </div>
                
                <!-- Profile dropdown -->
                <div class="profile-dropdown" id="profile-dropdown">
                    <div class="profile-dropdown-item" id="profile-settings">
                        <span class="material-icons">settings</span>
                        <span>Settings</span>
                    </div>
                    <div class="profile-dropdown-item" id="profile-logout">
                        <span class="material-icons">logout</span>
                        <span>Sign Out</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-sections">
                <div class="sidebar-nav">
                    <div class="sidebar-item active" id="new-chat-btn">
                        <div class="sidebar-item-icon">
                            <span class="material-icons">add_circle_outline</span>
                        </div>
                        <div class="sidebar-item-text">New chat</div>
                    </div>
                    
                    <div class="sidebar-divider"></div>
                </div>
                
                <div class="conversations-container" id="conversations-container">
                    <!-- Conversation history will be added here -->
                </div>
                
        <div class="sidebar-footer">

    <div class="sidebar-item" id="login-btn">
        <div class="sidebar-item-icon">
            <span class="material-icons">person</span>
        </div>
        <div class="sidebar-item-text">Sign In</div>
    </div>
</div>
                
                <!-- New Features Section -->
           <div class="new-features-section" id="new-features-section">
                    <div class="new-features-title">
                        <span class="material-icons" style="font-size: 16px;">new_releases</span>
                        What's New
                    </div>
                    <div class="new-features-list">
                        <div class="new-features-item">
                            <span class="material-icons" style="font-size: 12px;">speed</span>
                            Initial prompt improvements
                        </div>
                        <div class="new-features-item">
                            <span class="material-icons" style="font-size: 12px;">person</span>
                            Profile button - BETA
                        </div>
                        <div class="new-features-item">
                            <span class="material-icons" style="font-size: 12px;">edit</span>
                            Edit message feature
                        </div>
                        <div class="new-features-item">
                            <span class="material-icons" style="font-size: 12px;">save</span>
                            Auto-save conversations
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="logo">
                    <button class="sidebar-toggle" id="sidebar-toggle">
                        <span class="material-icons">menu</span>
                    </button>
                    <h1 id="header-title">nexora</h1>
                </div>
                <div class="header-actions">
                    <div class="credit-icon" id="credit-icon">
                        <img src="Credits.png" alt="Gem Star Credit Icon" width="50" height="50">
                    </div>
                    <div class="theme-toggle" id="theme-toggle">
                        <span class="material-icons" style="font-size: 12px;">wb_sunny</span>
                        <span class="material-icons" style="font-size: 12px;">nights_stay</span>
                    </div>
                </div>
                
                <!-- Credit popup -->
                <div class="credit-popup" id="credit-popup">
                    <div class="credit-popup-title">Your Credits</div>
                    <div class="credit-info">
                        <div class="credit-bar">
                            <div class="credit-bar-fill" id="credit-bar-fill"></div>
                        </div>
                        <div class="credit-text">
                            <span id="credit-label"><span id="credit-amount">10.00</span> credits</span>
                            <span>Resets on <span id="reset-date">Jun 1</span></span>
                        </div>
                        <div class="credit-warning-text" id="credit-warning-text">
                            Low credit! Only <span id="credit-remaining">2</span> credits remaining.
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="chat-container">
                <div class="empty-chat-container" id="empty-chat-container">
                    <div class="empty-chat-title">
                        <img src="Nexora.png" alt="Nexora Logo">
                        nexora
                    </div>
                    <p class="empty-chat-description">How can I help you today?</p>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="messages-container" id="messages-container">
                        <!-- Chat messages will be added here -->
                    </div>
                </div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <input type="text" id="user-input" placeholder="Ask nexora something..." autocomplete="off">
                        <div class="input-buttons">
                            <button id="regenerate-button">
                                <span class="material-icons" style="font-size: 16px;">refresh</span>
                            </button>
                            <button id="stop-button">
                                <span class="material-icons" style="font-size: 16px;">stop</span>
                            </button>
                            <button id="send-button">
                                <span class="material-icons" style="font-size: 16px;">send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Search Modal -->
    <div class="modal-overlay" id="search-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Search Messages</h2>
                <button class="modal-close" id="search-modal-close">Ã—</button>
            </div>
            <div class="modal-content">
                <input type="text" class="search-input" id="search-input" placeholder="Type to search messages...">
                <div class="search-results" id="search-results"></div>
            </div>
        </div>
    </div>

    <!-- Login popup -->
    <div class="popup-overlay" id="login-popup">
        <div class="popup-container">
            <button class="popup-close" id="popup-close">Ã—</button>
            <h2 class="popup-title">Sign in to nexora cognitia</h2>
            <p class="popup-content" id="popup-message">You have 1 credit left to chat anonymously. Sign in to experience nexora cognitia.</p>
            <button class="popup-button" id="google-signin-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
                    <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                    <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
                    <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Logout confirmation modal -->
    <div class="popup-overlay" id="logout-popup">
        <div class="popup-container logout-modal">
            <h2 class="logout-modal-title">Sign Out</h2>
            <p class="logout-modal-content">Are you sure you want to sign out? Your conversations will remain saved to your account.</p>
            <div class="logout-modal-buttons">
                <button class="logout-modal-button cancel" id="logout-cancel">Cancel</button>
                <button class="logout-modal-button confirm" id="logout-confirm">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Edit prompt modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Edit Prompt</h2>
                <button class="modal-close" id="edit-modal-close">Ã—</button>
            </div>
            <div class="modal-content">
                <textarea class="edit-modal-textarea" id="edit-prompt-textarea"></textarea>
                <div class="edit-modal-buttons">
                    <button class="edit-modal-button cancel" id="edit-cancel">Cancel</button>
                    <button class="edit-modal-button save" id="edit-save">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyD9rh3soAgWPAPO8o5OVRAQc7t_VHSAvbU",
        authDomain: "nexora-8b146.firebaseapp.com",
        projectId: "nexora-8b146",
        storageBucket: "nexora-8b146.firebasestorage.app",
        messagingSenderId: "383585586026",
        appId: "1:383585586026:web:6948e25da92bf620b53313",
        measurementId: "G-C3NS5QBJM5"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    // DOM Elements
    const appContainer = document.getElementById('app-container');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const sidebarHeader = document.getElementById('sidebar-header');
    const profileDropdown = document.getElementById('profile-dropdown');
    const profileLogout = document.getElementById('profile-logout');
    const chatMessages = document.getElementById('chat-messages');
    const messagesContainer = document.getElementById('messages-container');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const regenerateButton = document.getElementById('regenerate-button');
    const themeToggle = document.getElementById('theme-toggle');
    const emptyChat = document.getElementById('empty-chat-container');
    const loginBtn = document.getElementById('login-btn');
    const loginPopup = document.getElementById('login-popup');
    const logoutPopup = document.getElementById('logout-popup');
    const logoutCancel = document.getElementById('logout-cancel');
    const logoutConfirm = document.getElementById('logout-confirm');
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const userDisplayName = document.getElementById('user-display-name');
    const userStatus = document.getElementById('user-status');
    const userProfilePic = document.getElementById('user-profile-pic');
    const conversationsContainer = document.getElementById('conversations-container');
    const newChatBtn = document.getElementById('new-chat-btn');
    const popupMessage = document.getElementById('popup-message');
    const popupClose = document.getElementById('popup-close');
    const toast = document.getElementById('toast');
    const creditIcon = document.getElementById('credit-icon');
    const creditPopup = document.getElementById('credit-popup');
    const creditBarFill = document.getElementById('credit-bar-fill');
    const creditAmount = document.getElementById('credit-amount');
    const creditLabel = document.getElementById('credit-label');
    const creditRemaining = document.getElementById('credit-remaining');
    const creditWarningText = document.getElementById('credit-warning-text');
    const resetDate = document.getElementById('reset-date');
    const editModal = document.getElementById('edit-modal');
    const editModalClose = document.getElementById('edit-modal-close');
    const editPromptTextarea = document.getElementById('edit-prompt-textarea');
    const editCancel = document.getElementById('edit-cancel');
    const editSave = document.getElementById('edit-save');
    const headerTitle = document.getElementById('header-title');
    const newFeaturesSection = document.getElementById('new-features-section');
    
    // App state
    let isGenerating = false;
    let shouldStop = false;
    let currentMessageElement = null;
    let typingSpeed = 30;
    let currentUser = null;
    let anonymousPromptCount = 0;
    let currentConversationId = null;
    let conversations = [];
    let anonymousAuthEnabled = true;
    let lastUserMessage = '';
    let allMessages = [];
    let initialPrompt = '';
    let currentEditingMessageId = null;
    
    // Credit system
    const ANONYMOUS_MAX_CREDITS = 6;
    const SIGNED_IN_MAX_CREDITS = 10;
    let userCredits = ANONYMOUS_MAX_CREDITS;
    let creditsUsed = 0;
    let lastCreditReset = new Date();
    let lowCreditWarningShown = false;
    let isAnonymous = true;
    let firestoreAvailable = true;

    // Load conversation from URL on page load
    function loadConversationFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const conversationId = urlParams.get('conversation');
        if (conversationId) {
            currentConversationId = conversationId;
            loadConversation(conversationId);
        }
    }

    // Update URL when conversation changes
    function updateURL(conversationId) {
        if (conversationId) {
            const newURL = `${window.location.pathname}?conversation=${conversationId}`;
            window.history.replaceState({ conversationId }, '', newURL);
        } else {
            window.history.replaceState({}, '', window.location.pathname);
        }
    }

    // Update document title based on initial prompt
    function updateDocumentTitle(prompt) {
        if (prompt && prompt.length > 0) {
            const titleText = prompt.length > 30 ? prompt.substring(0, 30) + '...' : prompt;
            document.title = `${titleText} - Nexora`;
            
            headerTitle.style.opacity = '0';
            setTimeout(() => {
                headerTitle.textContent = titleText;
                headerTitle.style.opacity = '1';
            }, 150);
        } else {
            document.title = 'Nexora - AI Chatbot';
            headerTitle.style.opacity = '0';
            setTimeout(() => {
                headerTitle.textContent = 'nexora';
                headerTitle.style.opacity = '1';
            }, 150);
        }
    }

    // Sidebar toggle functionality
    function toggleSidebar() {
        if (window.innerWidth < 769) {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        } else {
            appContainer.classList.toggle('sidebar-expanded');
        }
    }
    const featuresSection = document.getElementById('new-features-section');

    sidebarToggle.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);

    // Profile dropdown functionality
    sidebarHeader.addEventListener('click', (e) => {
        e.stopPropagation();
        profileDropdown.classList.toggle('active');
    });

    // Close profile dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!sidebarHeader.contains(e.target)) {
            profileDropdown.classList.remove('active');
        }
    });

    // Profile logout handler
    profileLogout.addEventListener('click', () => {
        if (currentUser && !currentUser.isAnonymous) {
            logoutPopup.classList.add('active');
        } else {
            popupMessage.textContent = 'Sign in to experience Nexora Cognitia with unlimited access.';
            loginPopup.classList.add('active');
        }
        profileDropdown.classList.remove('active');
    });

    // Initialize sidebar state based on screen size
    function initSidebar() {
        if (window.innerWidth >= 769) {
            appContainer.classList.add('sidebar-expanded');
        }
    }

    // Call on load
    initSidebar();

    // Update on resize
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 769) {
            sidebarOverlay.classList.remove('active');
            sidebar.classList.remove('active');
        } else {
            appContainer.classList.remove('sidebar-expanded');
        }
    });

    // Credit icon click handler
    creditIcon.addEventListener('click', () => {
        forceUpdateCreditDisplay();
        creditPopup.classList.toggle('active');
        
        setTimeout(() => {
            creditPopup.classList.remove('active');
        }, 5000);
    });

    // Close credit popup when clicking outside
    document.addEventListener('click', (e) => {
        if (!creditIcon.contains(e.target) && !creditPopup.contains(e.target)) {
            creditPopup.classList.remove('active');
        }
    });

    // Force update credit display
    function forceUpdateCreditDisplay() {
        const remainingCredits = userCredits - creditsUsed;
        
        const creditAmountElement = document.getElementById('credit-amount');
        if (creditAmountElement) {
            creditAmountElement.textContent = remainingCredits.toFixed(isAnonymous ? 0 : 2);
        }
        
        const creditBarFillElement = document.getElementById('credit-bar-fill');
        if (creditBarFillElement) {
            const percentage = (remainingCredits / userCredits) * 100;
            creditBarFillElement.style.width = `${percentage}%`;
        }
    }

    // Update credit bar
    function updateCreditBar() {
        const remainingCredits = userCredits - creditsUsed;
        const percentage = (remainingCredits / userCredits) * 100;
        
        document.getElementById('credit-bar-fill').style.width = `${percentage}%`;
        document.getElementById('credit-amount').textContent = remainingCredits.toFixed(isAnonymous ? 0 : 2);
        
        const warningThreshold = isAnonymous ? 2 : 2.00;
        
        if (remainingCredits <= warningThreshold && !lowCreditWarningShown) {
            document.getElementById('credit-warning-text').classList.add('active');
            document.getElementById('credit-remaining').textContent = remainingCredits.toFixed(isAnonymous ? 0 : 2);
            document.getElementById('credit-bar-fill').classList.add('warning');
            showToast(`Warning: Low credits remaining! Only ${remainingCredits.toFixed(isAnonymous ? 0 : 2)} left.`);
            lowCreditWarningShown = true;
        } else if (remainingCredits > warningThreshold) {
            document.getElementById('credit-warning-text').classList.remove('active');
            document.getElementById('credit-bar-fill').classList.remove('warning');
            lowCreditWarningShown = false;
        }
        
        const now = new Date();
        let nextResetDate;
        
        if (now.getDate() < 15) {
            nextResetDate = new Date(now.getFullYear(), now.getMonth(), 15);
        } else {
            nextResetDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        }
        
        document.getElementById('reset-date').textContent = nextResetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Check if credits need to be reset
    function checkCreditReset() {
        const now = new Date();
        const lastResetDay = lastCreditReset.getDate();
        const currentDay = now.getDate();
        
        if ((currentDay === 1 || currentDay === 15) && 
            (lastResetDay !== 1 && lastResetDay !== 15 || 
             lastCreditReset.getMonth() !== now.getMonth() ||
             lastCreditReset.getFullYear() !== now.getFullYear())) {
            
            creditsUsed = 0;
            lastCreditReset = now;
            lowCreditWarningShown = false;
            
            updateCreditBar();
            forceUpdateCreditDisplay();
            showToast('Your credits have been reset!');
            
            saveCreditsToStorage();
        }
    }

    // Save user credits to storage
    function saveCreditsToStorage() {
        if (!isAnonymous && currentUser && firestoreAvailable) {
            db.collection('users').doc(currentUser.uid).set({
                creditsUsed: creditsUsed,
                lastCreditReset: firebase.firestore.Timestamp.fromDate(lastCreditReset)
            }, { merge: true })
            .catch(error => {
                console.error('Error saving user credits:', error);
                firestoreAvailable = false;
                saveToLocalStorage();
            });
        } else {
            saveToLocalStorage();
        }
    }

    // Save credits to localStorage
    function saveToLocalStorage() {
        const storageKey = isAnonymous ? 'anonymousCreditsUsed' : `userCredits_${currentUser?.uid || 'default'}`;
        const resetKey = isAnonymous ? 'anonymousLastCreditReset' : `userCreditReset_${currentUser?.uid || 'default'}`;
        
        localStorage.setItem(storageKey, creditsUsed);
        localStorage.setItem(resetKey, lastCreditReset.toISOString());
    }

    // Load user credits from storage
    function loadCreditsFromStorage() {
        if (!isAnonymous && currentUser && firestoreAvailable) {
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        if (userData.creditsUsed !== undefined) {
                            creditsUsed = userData.creditsUsed;
                        }
                        
                        if (userData.lastCreditReset) {
                            lastCreditReset = userData.lastCreditReset.toDate();
                        }
                    }
                    
                    checkCreditReset();
                    updateCreditBar();
                    forceUpdateCreditDisplay();
                })
                .catch(error => {
                    console.error('Error loading user credits:', error);
                    firestoreAvailable = false;
                    loadFromLocalStorage();
                });
        } else {
            loadFromLocalStorage();
        }
    }

    // Load credits from localStorage
    function loadFromLocalStorage() {
        const storageKey = isAnonymous ? 'anonymousCreditsUsed' : `userCredits_${currentUser?.uid || 'default'}`;
        const resetKey = isAnonymous ? 'anonymousLastCreditReset' : `userCreditReset_${currentUser?.uid || 'default'}`;
        
        const savedCreditsUsed = localStorage.getItem(storageKey);
        const savedLastReset = localStorage.getItem(resetKey);
        
        if (savedCreditsUsed !== null) {
            creditsUsed = parseFloat(savedCreditsUsed);
        }
        
        if (savedLastReset !== null) {
            lastCreditReset = new Date(savedLastReset);
        }
        
        checkCreditReset();
        updateCreditBar();
        forceUpdateCreditDisplay();
    }

    // Theme toggle functionality
    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
    }

    // Toast notification
    function showToast(message, duration = 3000) {
        toast.textContent = message;
        toast.classList.add('active');
        
        setTimeout(() => {
            toast.classList.remove('active');
        }, duration);
    }

    // Authentication state observer
    auth.onAuthStateChanged((user) => {
        currentUser = user;
        
        if (user) {
            if (!user.isAnonymous) {
                userDisplayName.textContent = user.displayName || 'User';
                userStatus.innerHTML = '<div class="status-indicator"></div>Free Planning';
                isAnonymous = false;
                userCredits = SIGNED_IN_MAX_CREDITS;
                creditLabel.innerHTML = `$<span id="credit-amount">${SIGNED_IN_MAX_CREDITS.toFixed(2)}</span> credit`;
                
                if (user.photoURL) {
                    userProfilePic.src = user.photoURL;
                } else {
                    userProfilePic.src = 'Nexora.png';
                }
                
                loginBtn.querySelector('.sidebar-item-text').textContent = 'Profile';
                
                loadConversations();
                loadCreditsFromStorage();
            } else {
                isAnonymous = true;
                userCredits = ANONYMOUS_MAX_CREDITS;
                creditLabel.innerHTML = `<span id="credit-amount">${ANONYMOUS_MAX_CREDITS}</span> credits`;
                loadCreditsFromStorage();
            }
        } else {
            userDisplayName.textContent = 'Nexora';
            userStatus.innerHTML = '<div class="status-indicator"></div>Free Planning';
            userProfilePic.src = 'Nexora.png';
            loginBtn.querySelector('.sidebar-item-text').textContent = 'Sign In';
            isAnonymous = true;
            userCredits = ANONYMOUS_MAX_CREDITS;
            creditLabel.innerHTML = `<span id="credit-amount">${ANONYMOUS_MAX_CREDITS}</span> credits`;
            
            conversationsContainer.innerHTML = '';
            loadCreditsFromStorage();
            
            if (anonymousAuthEnabled) {
                auth.signInAnonymously()
                    .catch((error) => {
                        console.error('Anonymous auth error:', error);
                        anonymousAuthEnabled = false;
                    });
            }
        }
    });

    // Google Sign In
    googleSignInBtn.addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        
        auth.signInWithPopup(provider)
            .then((result) => {
                loginPopup.classList.remove('active');
                
                if (currentConversationId && auth.currentUser && auth.currentUser.isAnonymous) {
                    transferAnonymousConversation(currentConversationId, result.user.uid);
                }
                
                showToast('Successfully signed in!');
            })
            .catch((error) => {
                console.error('Google sign in error:', error);
                
                if (error.code === 'auth/unauthorized-domain') {
                    showToast('This domain is not authorized for OAuth operations.');
                } else {
                    showToast('Error signing in: ' + error.message);
                }
            });
    });

    // Close popup when clicking the X
    popupClose.addEventListener('click', () => {
        loginPopup.classList.remove('active');
    });

    // Login button click handler
    loginBtn.addEventListener('click', () => {
        if (currentUser && !currentUser.isAnonymous) {
            profileDropdown.classList.toggle('active');
        } else {
            popupMessage.textContent = 'Sign in to experience Nexora Cognitia with unlimited access.';
            loginPopup.classList.add('active');
        }
    });

    // Logout confirmation handlers
    logoutCancel.addEventListener('click', () => {
        logoutPopup.classList.remove('active');
    });

    logoutConfirm.addEventListener('click', () => {
        auth.signOut()
            .then(() => {
                logoutPopup.classList.remove('active');
                showToast('Successfully signed out');
            })
            .catch((error) => {
                console.error('Sign out error:', error);
                showToast('Error signing out');
            });
    });

    // Close popup when clicking outside
    loginPopup.addEventListener('click', (e) => {
        if (e.target === loginPopup) {
            loginPopup.classList.remove('active');
        }
    });

    logoutPopup.addEventListener('click', (e) => {
        if (e.target === logoutPopup) {
            logoutPopup.classList.remove('active');
        }
    });

    // Edit modal handlers
    editModalClose.addEventListener('click', () => {
        editModal.classList.remove('active');
    });

    editCancel.addEventListener('click', () => {
        editModal.classList.remove('active');
    });

    editSave.addEventListener('click', () => {
        const newPrompt = editPromptTextarea.value.trim();
        if (newPrompt && currentEditingMessageId) {
            const messageElement = document.querySelector(`[data-message-id="${currentEditingMessageId}"]`);
            if (messageElement) {
                messageElement.textContent = newPrompt;
            }
            
            if (currentConversationId && firestoreAvailable) {
                db.collection('conversations').doc(currentConversationId)
                    .collection('messages')
                    .doc(currentEditingMessageId)
                    .update({
                        content: newPrompt
                    })
                    .then(() => {
                        showToast('Prompt updated successfully');
                    })
                    .catch(error => {
                        console.error('Error updating prompt:', error);
                        firestoreAvailable = false;
                        showToast('Error updating prompt - using local storage instead');
                    });
            }
            
            for (let i = 0; i < allMessages.length; i++) {
                if (allMessages[i].id === currentEditingMessageId) {
                    allMessages[i].content = newPrompt;
                    break;
                }
            }
            
            if (allMessages.length > 0 && allMessages[0].id === currentEditingMessageId) {
                initialPrompt = newPrompt;
                updateDocumentTitle(initialPrompt);
            }
        }
        
        editModal.classList.remove('active');
    });

    // Close modals when clicking outside
    editModal.addEventListener('click', (e) => {
        if (e.target === editModal) {
            editModal.classList.remove('active');
        }
    });

    // Load user's conversations from Firestore
    function loadConversations() {
        if (!currentUser || currentUser.isAnonymous || !firestoreAvailable) return;
        
        db.collection('conversations')
            .where('userId', '==', currentUser.uid)
            .orderBy('updatedAt', 'desc')
            .limit(20)
            .get()
            .then((querySnapshot) => {
                conversations = [];
                conversationsContainer.innerHTML = '';
                
                querySnapshot.forEach((doc) => {
                    const conversation = doc.data();
                    conversation.id = doc.id;
                    conversations.push(conversation);
                    
                    addConversationToSidebar(conversation);
                });
            })
            .catch((error) => {
                console.error('Error loading conversations:', error);
                firestoreAvailable = false;
                showToast('Error loading conversations - using local storage instead');
            });
    }

    // Add conversation to sidebar
    function addConversationToSidebar(conversation) {
        const conversationItem = document.createElement('div');
        conversationItem.className = 'conversation-item';
        conversationItem.dataset.id = conversation.id;
        
        if (conversation.id === currentConversationId) {
            conversationItem.classList.add('active');
        }
        
        conversationItem.innerHTML = `
            <div class="conversation-icon">
                <span class="material-icons">chat_bubble_outline</span>
            </div>
            <div class="conversation-title">${conversation.title || 'New Conversation'}</div>
            <div class="conversation-actions">
                <button class="conversation-action-btn edit-btn" title="Edit conversation">
                    <span class="material-icons" style="font-size: 14px;">edit</span>
                </button>
                <button class="conversation-action-btn delete-btn" title="Delete conversation">
                    <span class="material-icons" style="font-size: 14px;">delete</span>
                </button>
            </div>
        `;
        
        conversationItem.addEventListener('click', (e) => {
            if (e.target.closest('.conversation-actions')) {
                return;
            }
            loadConversation(conversation.id);
        });
        
        const editBtn = conversationItem.querySelector('.edit-btn');
        if (editBtn) {
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentConversationId !== conversation.id) {
                    loadConversation(conversation.id, () => {
                        if (allMessages.length > 0) {
                            const firstUserMessage = allMessages.find(msg => msg.role === 'user');
                            if (firstUserMessage) {
                                editPromptTextarea.value = firstUserMessage.content;
                                currentEditingMessageId = firstUserMessage.id;
                                editModal.classList.add('active');
                            }
                        }
                    });
                } else {
                    if (allMessages.length > 0) {
                        const firstUserMessage = allMessages.find(msg => msg.role === 'user');
                        if (firstUserMessage) {
                            editPromptTextarea.value = firstUserMessage.content;
                            currentEditingMessageId = firstUserMessage.id;
                            editModal.classList.add('active');
                        }
                    }
                }
            });
        }
        
        const deleteBtn = conversationItem.querySelector('.delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this conversation?')) {
                    deleteConversation(conversation.id);
                }
            });
        }
        
        conversationsContainer.appendChild(conversationItem);
    }

    // Delete conversation
    function deleteConversation(conversationId) {
        if (!conversationId) return;
        
        if (firestoreAvailable) {
            db.collection('conversations').doc(conversationId).delete()
                .then(() => {
                    handleConversationDeleted(conversationId);
                })
                .catch((error) => {
                    console.error('Error deleting conversation:', error);
                    firestoreAvailable = false;
                    showToast('Error deleting conversation from server - removing locally');
                    handleConversationDeleted(conversationId);
                });
        } else {
            handleConversationDeleted(conversationId);
        }
    }

    // Handle conversation deleted (UI updates)
    function handleConversationDeleted(conversationId) {
        const conversationItem = document.querySelector(`.conversation-item[data-id="${conversationId}"]`);
        if (conversationItem) {
            conversationItem.remove();
        }
        
        conversations = conversations.filter(conv => conv.id !== conversationId);
        
        if (currentConversationId === conversationId) {
            messagesContainer.innerHTML = '';
            emptyChat.classList.remove('hidden');
            currentConversationId = null;
            lastUserMessage = '';
            allMessages = [];
            initialPrompt = '';
            updateDocumentTitle('');
            updateURL(null);
            regenerateButton.classList.remove('visible');
        }
        
        showToast('Conversation deleted');
    }

    // Load a specific conversation
    function loadConversation(conversationId, callback) {
        if (!conversationId) return;
        
        currentConversationId = conversationId;
        updateURL(conversationId);
        
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.id === conversationId) {
                item.classList.add('active');
            }
        });
        
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.classList.remove('active');
        });
        
        messagesContainer.innerHTML = '';
        emptyChat.classList.add('hidden');
        allMessages = [];
        
        if (firestoreAvailable) {
            db.collection('conversations').doc(conversationId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .get()
                .then((querySnapshot) => {
                    const messages = [];
                    querySnapshot.forEach((doc) => {
                        const message = doc.data();
                        message.id = doc.id;
                        messages.push(message);
                    });
                    
                    messages.forEach(message => {
                        if (message.role === 'USER') {
                            addMessageToChat('user', message.content, false, message.id);
                            allMessages.push({
                                id: message.id,
                                role: 'user',
                                content: message.content,
                                timestamp: message.timestamp
                            });
                            
                            lastUserMessage = message.content;
                            
                            if (allMessages.length === 1) {
                                initialPrompt = message.content;
                                updateDocumentTitle(initialPrompt);
                            }
                        } else if (message.role === 'CHATBOT') {
                            addMessageToChat('bot', message.content, false, message.id);
                            allMessages.push({
                                id: message.id,
                                role: 'bot',
                                content: message.content,
                                timestamp: message.timestamp
                            });
                        }
                    });
                    
                    if (typeof callback === 'function') {
                        callback();
                    }
                })
                .catch((error) => {
                    console.error('Error loading messages:', error);
                    firestoreAvailable = false;
                    showToast('Error loading conversation from server');
                    
                    loadConversationFromLocalStorage(conversationId, callback);
                });
        } else {
            loadConversationFromLocalStorage(conversationId, callback);
        }
    }

    // Load conversation from localStorage
    function loadConversationFromLocalStorage(conversationId, callback) {
        const savedMessages = localStorage.getItem(`conversation_${conversationId}`);
        if (savedMessages) {
            try {
                const messages = JSON.parse(savedMessages);
                messages.forEach(message => {
                    if (message.role === 'user') {
                        addMessageToChat('user', message.content, false, message.id);
                        allMessages.push(message);
                        
                        lastUserMessage = message.content;
                        
                        if (allMessages.length === 1) {
                            initialPrompt = message.content;
                            updateDocumentTitle(initialPrompt);
                        }
                    } else if (message.role === 'bot') {
                        addMessageToChat('bot', message.content, false, message.id);
                        allMessages.push(message);
                    }
                });
                
                if (typeof callback === 'function') {
                    callback();
                }
            } catch (error) {
                console.error('Error parsing saved messages:', error);
                showToast('Error loading conversation');
            }
        } else {
            showToast('No saved conversation found');
        }
    }

    // Create a new conversation
    function createNewConversation(firstMessage) {
        const userId = currentUser ? currentUser.uid : null;
        const isAnonymousUser = currentUser ? currentUser.isAnonymous : true;
        
        const conversationData = {
            userId: userId,
            isAnonymous: isAnonymousUser,
            title: firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (firestoreAvailable && currentUser) {
            return db.collection('conversations').add(conversationData)
                .then((docRef) => {
                    currentConversationId = docRef.id;
                    updateURL(docRef.id);
                    
                    if (userId && !isAnonymousUser) {
                        const conversation = {
                            ...conversationData,
                            id: docRef.id
                        };
                        conversations.unshift(conversation);
                        addConversationToSidebar(conversation);
                    }
                    
                    return docRef.id;
                })
                .catch((error) => {
                    console.error('Error creating conversation in Firestore:', error);
                    firestoreAvailable = false;
                    
                    return createLocalConversation(conversationData);
                });
        } else {
            return Promise.resolve(createLocalConversation(conversationData));
        }
    }

    // Create a conversation in localStorage
    function createLocalConversation(conversationData) {
        const conversationId = 'local_' + Date.now();
        currentConversationId = conversationId;
        updateURL(conversationId);
        
        localStorage.setItem(`conversationMeta_${conversationId}`, JSON.stringify({
            ...conversationData,
            id: conversationId,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        }));
        
        localStorage.setItem(`conversation_${conversationId}`, JSON.stringify([]));
        
        return conversationId;
    }

    // Add message to Firestore
    function saveMessageToFirestore(conversationId, role, content) {
        if (!conversationId) return Promise.resolve(null);
        
        const messageId = 'msg_' + Date.now();
        const messageData = {
            role: role,
            content: content,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (firestoreAvailable && currentUser) {
            return db.collection('conversations').doc(conversationId)
                .collection('messages').add(messageData)
                .then((docRef) => {
                    db.collection('conversations').doc(conversationId)
                        .update({
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        })
                        .catch(error => {
                            console.error('Error updating conversation timestamp:', error);
                            firestoreAvailable = false;
                        });
                    
                    return docRef.id;
                })
                .catch((error) => {
                    console.error('Error saving message to Firestore:', error);
                    firestoreAvailable = false;
                    
                    return saveMessageToLocalStorage(conversationId, role, content, messageId);
                });
        } else {
            return Promise.resolve(saveMessageToLocalStorage(conversationId, role, content, messageId));
        }
    }

    // Save message to localStorage
    function saveMessageToLocalStorage(conversationId, role, content, messageId) {
        const savedMessages = localStorage.getItem(`conversation_${conversationId}`);
        let messages = [];
        
        if (savedMessages) {
            try {
                messages = JSON.parse(savedMessages);
            } catch (error) {
                console.error('Error parsing saved messages:', error);
            }
        }
        
        messages.push({
            id: messageId,
            role: role === 'USER' ? 'user' : 'bot',
            content: content,
            timestamp: new Date().toISOString()
        });
        
        localStorage.setItem(`conversation_${conversationId}`, JSON.stringify(messages));
        
        const savedMeta = localStorage.getItem(`conversationMeta_${conversationId}`);
        if (savedMeta) {
            try {
                const meta = JSON.parse(savedMeta);
                meta.updatedAt = new Date().toISOString();
                localStorage.setItem(`conversationMeta_${conversationId}`, JSON.stringify(meta));
            } catch (error) {
                console.error('Error updating conversation metadata:', error);
            }
        }
        
        return messageId;
    }

    // Transfer anonymous conversation to signed-in user
    function transferAnonymousConversation(conversationId, newUserId) {
        if (firestoreAvailable) {
            db.collection('conversations').doc(conversationId)
                .update({
                    userId: newUserId,
                    isAnonymous: false
                })
                .then(() => {
                    console.log('Conversation transferred to signed-in user');
                })
                .catch((error) => {
                    console.error('Error transferring conversation:', error);
                    firestoreAvailable = false;
                });
        }
    }

    // New chat button
    newChatBtn.addEventListener('click', () => {
        messagesContainer.innerHTML = '';
        emptyChat.classList.remove('hidden');
        currentConversationId = null;
        lastUserMessage = '';
        allMessages = [];
        initialPrompt = '';
        updateDocumentTitle('');
        updateURL(null);
        
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        
        newChatBtn.classList.add('active');
        regenerateButton.classList.remove('visible');
    });

    // Handle user message
    sendButton.addEventListener('click', handleUserMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleUserMessage();
    });
    
    // Stop button functionality
    stopButton.addEventListener('click', () => {
        if (isGenerating) {
            shouldStop = true;
            stopButton.classList.remove('visible');
            sendButton.style.display = 'flex';
            regenerateButton.classList.add('visible');
            
            if (currentMessageElement) {
                const cursor = document.createElement('span');
                cursor.className = 'cursor';
                currentMessageElement.appendChild(cursor);
            }
        }
    });
    
    // Regenerate button functionality
    regenerateButton.addEventListener('click', () => {
        if (isGenerating) return;
        
        if (lastUserMessage) {
            const messages = messagesContainer.querySelectorAll('.message');
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                if (lastMessage.classList.contains('bot-message')) {
                    lastMessage.remove();
                    
                    if (currentConversationId && firestoreAvailable) {
                        db.collection('conversations').doc(currentConversationId)
                            .collection('messages')
                            .orderBy('timestamp', 'desc')
                            .limit(1)
                            .get()
                            .then((querySnapshot) => {
                                querySnapshot.forEach((doc) => {
                                    if (doc.data().role === 'CHATBOT') {
                                        doc.ref.delete();
                                    }
                                });
                            })
                            .catch(error => {
                                console.error('Error deleting message:', error);
                                firestoreAvailable = false;
                            });
                    }
                    
                    if (allMessages.length > 0 && allMessages[allMessages.length - 1].role === 'bot') {
                        allMessages.pop();
                    }
                    
                    if (!firestoreAvailable && currentConversationId) {
                        const savedMessages = localStorage.getItem(`conversation_${currentConversationId}`);
                        if (savedMessages) {
                            try {
                                let messages = JSON.parse(savedMessages);
                                if (messages.length > 0 && messages[messages.length - 1].role === 'bot') {
                                    messages.pop();
                                    localStorage.setItem(`conversation_${currentConversationId}`, JSON.stringify(messages));
                                }
                            } catch (error) {
                                console.error('Error updating localStorage messages:', error);
                            }
                        }
                    }
                }
            }
            
            getBotResponse(lastUserMessage);
            regenerateButton.classList.remove('visible');
        } else {
            showToast('No previous message to regenerate');
        }
    });

    async function handleUserMessage() {
        const message = userInput.value.trim();
        if (!message || isGenerating) return;

        regenerateButton.classList.remove('visible');
        lastUserMessage = message;

        if (isAnonymous) {
            anonymousPromptCount++;
            
            if (anonymousPromptCount === 5) {
                popupMessage.textContent = 'You have 1 credit left to chat anonymously. Sign in to experience Nexora Cognitia with unlimited access.';
                loginPopup.classList.add('active');
            }
            
            if (anonymousPromptCount > 6) {
                popupMessage.textContent = 'You have used all your anonymous credits. Please sign in to continue using Nexora Cognitia.';
                loginPopup.classList.add('active');
                return;
            }
        }

        if (emptyChat && !emptyChat.classList.contains('hidden')) {
            emptyChat.classList.add('hidden');
        }

        if (allMessages.length === 0) {
            initialPrompt = message;
            updateDocumentTitle(initialPrompt);
        }

        if (!currentConversationId) {
            try {
                currentConversationId = await createNewConversation(message);
            } catch (error) {
                console.error('Error creating conversation:', error);
                showToast('Error creating conversation');
            }
        }

        const messageId = await addMessageToChat('user', message);
        userInput.value = '';
        
        allMessages.push({
            id: messageId,
            role: 'user',
            content: message,
            timestamp: new Date()
        });
        
        saveMessageToFirestore(currentConversationId, 'USER', message)
            .then(id => {
                for (let i = 0; i < allMessages.length; i++) {
                    if (allMessages[i].role === 'user' && allMessages[i].content === message) {
                        allMessages[i].id = id;
                        break;
                    }
                }
            })
            .catch(error => console.error('Error saving message:', error));
        
        getBotResponse(message);
        
        if (isAnonymous) {
            creditsUsed += 1;
            localStorage.setItem('anonymousCreditsUsed', creditsUsed);
        } else {
            creditsUsed += 0.05;
            saveCreditsToStorage();
        }
        
        updateCreditBar();
        forceUpdateCreditDisplay();
    }

    async function addMessageToChat(sender, message, animate = true, messageId = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        
        if (sender === 'user') {
            avatar.classList.add('user-avatar-chat');
            
            if (currentUser && !currentUser.isAnonymous && currentUser.photoURL) {
                const img = document.createElement('img');
                img.src = currentUser.photoURL;
                img.alt = currentUser.displayName || 'User';
                avatar.innerHTML = '';
                avatar.appendChild(img);
            } else {
                avatar.textContent = 'U';
            }
        } else {
            const img = document.createElement('img');
            img.src = 'Nexora.png';
            img.alt = 'Nexora';
            avatar.appendChild(img);
        }

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        if (messageId) {
            messageContent.dataset.messageId = messageId;
        }

        if (sender === 'user') {
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            messageActions.innerHTML = `
                <button class="message-action-btn edit-btn" title="Edit message">
                    <span class="material-icons" style="font-size: 16px;">edit</span>
                </button>
                <button class="message-action-btn copy-btn" title="Copy message">
                    <span class="material-icons" style="font-size: 16px;">content_copy</span>
                </button>
            `;
            
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageActions);
            
            if (message.includes('\`\`\`')) {
                let parts = message.split('\`\`\`');
                let formattedMessage = '';
                for (let i = 0; i < parts.length; i++) {
                    formattedMessage += i % 2 === 0 ? parts[i] : `<pre><code>${parts[i]}</code></pre>`;
                }
                messageContent.innerHTML = formattedMessage;
            } else {
                messageContent.innerHTML = message.replace(/\n/g, '<br>');
            }
            
            const editBtn = messageDiv.querySelector('.edit-btn');
            if (editBtn) {
                editBtn.addEventListener('click', () => {
                    editPromptTextarea.value = message;
                    currentEditingMessageId = messageContent.dataset.messageId;
                    editModal.classList.add('active');
                });
            }
            
            const copyBtn = messageDiv.querySelector('.copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(message)
                        .then(() => {
                            showToast('Message copied to clipboard');
                        })
                        .catch(err => {
                            console.error('Could not copy text: ', err);
                            showToast('Failed to copy message');
                        });
                });
            }
        } else {
            const messageActions = document.createElement('div');
            messageActions.className = 'message-actions';
            messageActions.innerHTML = `
                <button class="message-action-btn copy-btn" title="Copy response">
                    <span class="material-icons" style="font-size: 16px;">content_copy</span>
                </button>
            `;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messageDiv.appendChild(messageActions);
            
            if (animate) {
                const thinkingDots = document.createElement('div');
                thinkingDots.className = 'thinking-dots';
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    thinkingDots.appendChild(dot);
                }
                messageContent.appendChild(thinkingDots);
            } else {
                if (message.includes('\`\`\`')) {
                    let parts = message.split('\`\`\`');
                    let formattedMessage = '';
                    for (let i = 0; i < parts.length; i++) {
                        if (i % 2 === 0) {
                            formattedMessage += highlightKeywords(parts[i]);
                        } else {
                            formattedMessage += `<pre><code>${parts[i]}</code></pre>`;
                        }
                    }
                    messageContent.innerHTML = formattedMessage;
                } else {
                    messageContent.innerHTML = highlightKeywords(message);
                }
                
                const copyBtn = messageDiv.querySelector('.copy-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        navigator.clipboard.writeText(message)
                            .then(() => {
                                showToast('Response copied to clipboard');
                            })
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                                showToast('Failed to copy response');
                            });
                    });
                }
            }
        }
        
        messagesContainer.appendChild(messageDiv);
        
        if (!messageId) {
            messageId = 'temp-' + Date.now();
            messageContent.dataset.messageId = messageId;
        }
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        return messageId;
    }

    // Function to highlight keywords in bot responses
    function highlightKeywords(text) {
        const keywords = [
            'AI', 'machine learning', 'neural network', 'algorithm', 'data', 
            'analysis', 'processing', 'intelligence', 'model', 'training',
            'Nexora', 'chatbot', 'assistant', 'help', 'support', 'information',
            'important', 'critical', 'essential', 'key', 'significant', 'vital',
            'recommend', 'suggest', 'advise', 'consider', 'note', 'remember',
            'feature', 'function', 'capability', 'integration', 'connection',
            'security', 'privacy', 'encryption', 'protected', 'confidential'
        ];
        
        let formattedText = text.replace(/\n/g, '<br>');
        
        keywords.forEach(keyword => {
            const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
            formattedText = formattedText.replace(regex, '<span class="keyword">$1</span>');
        });
        
        return formattedText;
    }

    // Function to type out message word by word
    async function typeMessage(element, message) {
        if (!element) return;
        
        isGenerating = true;
        shouldStop = false;
        sendButton.style.display = 'none';
        stopButton.classList.add('visible');
        
        element.innerHTML = '';
        
        if (message.includes('\`\`\`')) {
            let parts = message.split('\`\`\`');
            for (let i = 0; i < parts.length; i++) {
                if (i % 2 === 0) {
                    await typeTextWordByWord(element, parts[i], true);
                } else {
                    if (shouldStop) break;
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    pre.appendChild(code);
                    element.appendChild(pre);
                    await typeTextWordByWord(code, parts[i], false);
                }
            }
        } else {
            await typeTextWordByWord(element, message, true);
        }
        
        const cursor = document.createElement('span');
        cursor.className = 'cursor';
        element.appendChild(cursor);
        
        isGenerating = false;
        stopButton.classList.remove('visible');
        sendButton.style.display = 'flex';
        regenerateButton.classList.add('visible');
        
        const messageDiv = element.closest('.message');
        if (messageDiv) {
            const copyBtn = messageDiv.querySelector('.copy-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(message)
                        .then(() => {
                            showToast('Response copied to clipboard');
                        })
                        .catch(err => {
                            console.error('Could not copy text: ', err);
                            showToast('Failed to copy response');
                        });
                });
            }
        }
    }
    
    // Function to type text word by word
    async function typeTextWordByWord(element, text, highlightKeywords = false) {
        if (!element) return;
        
        const keywords = [
            'AI', 'machine learning', 'neural network', 'algorithm', 'data', 
            'analysis', 'processing', 'intelligence', 'model', 'training',
            'Nexora', 'chatbot', 'assistant', 'help', 'support', 'information',
            'important', 'critical', 'essential', 'key', 'significant', 'vital',
            'recommend', 'suggest', 'advise', 'consider', 'note', 'remember',
            'feature', 'function', 'capability', 'integration', 'connection',
            'security', 'privacy', 'encryption', 'protected', 'confidential'
        ];
        
        const words = text.split(' ');
        for (let i = 0; i < words.length; i++) {
            if (shouldStop) break;
            
            const word = words[i];
            
            if (word.includes('\n')) {
                const parts = word.split('\n');
                for (let j = 0; j < parts.length; j++) {
                    if (j > 0) {
                        element.appendChild(document.createElement('br'));
                    }
                    if (parts[j].length > 0) {
                        const partSpan = document.createElement('span');
                        
                        if (highlightKeywords && keywords.some(keyword => 
                            keyword.toLowerCase() === parts[j].toLowerCase() ||
                            keyword.toLowerCase() === parts[j].toLowerCase().replace(/[.,!?;:]/g, '')
                        )) {
                            partSpan.className = 'keyword';
                        }
                        
                        partSpan.textContent = parts[j];
                        element.appendChild(partSpan);
                        if (j < parts.length - 1 || i < words.length - 1) {
                            element.appendChild(document.createTextNode(' '));
                        }
                    }
                }
            } else {
                const wordSpan = document.createElement('span');
                
                if (highlightKeywords && keywords.some(keyword => 
                    keyword.toLowerCase() === word.toLowerCase() ||
                    keyword.toLowerCase() === word.toLowerCase().replace(/[.,!?;:]/g, '')
                )) {
                    wordSpan.className = 'keyword';
                }
                
                wordSpan.textContent = word;
                element.appendChild(wordSpan);
                if (i < words.length - 1) {
                    element.appendChild(document.createTextNode(' '));
                }
            }
            
            const networkQuality = Math.random();
            const adjustedSpeed = Math.max(10, Math.min(100, typingSpeed * (1 + (1 - networkQuality))));
            
            await new Promise(resolve => setTimeout(resolve, adjustedSpeed));
        }
    }

    async function getBotResponse(userMessage) {
        try {
            stopButton.classList.add('visible');
            sendButton.style.display = 'none';
            
            const botMessageContent = await addMessageToChat('bot', '');
            currentMessageElement = document.querySelector(`[data-message-id="${botMessageContent}"]`);
            
            const response = await fetch('https://nexora-backend-1.onrender.com/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    chat_history: [],
                    model: 'command',
                    connectors: []
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Backend error:', response.status, errorText);
                await typeMessage(currentMessageElement, `Error: Server returned status ${response.status}. Please try again later.`);
                return;
            }

            const data = await response.json();

            if (data && data.text) {
                const tokenEstimate = data.text.split(/\s+/).length * 1.5;
                
                await typeMessage(currentMessageElement, data.text);
                
                if (currentConversationId) {
                    const messageId = await saveMessageToFirestore(currentConversationId, 'CHATBOT', data.text);
                    
                    allMessages.push({
                        id: messageId,
                        role: 'bot',
                        content: data.text,
                        timestamp: new Date()
                    });
                }
                
                if (isAnonymous) {
                    creditsUsed += Math.ceil(tokenEstimate / 500);
                    localStorage.setItem('anonymousCreditsUsed', creditsUsed);
                } else {
                    const responseCredit = tokenEstimate * 0.0001;
                    creditsUsed += responseCredit;
                    saveCreditsToStorage();
                }
                
                updateCreditBar();
                forceUpdateCreditDisplay();
            } else {
                await typeMessage(currentMessageElement, "I'm sorry, I couldn't generate a response. Please try again.");
            }
        } catch (error) {
            console.error('Error getting bot response:', error);
            if (currentMessageElement) {
                await typeMessage(currentMessageElement, "I'm sorry, there was an error processing your request. Please try again later.");
            }
        }
    }

    // Initialize the app
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
    }
    
    updateCreditBar();
    forceUpdateCreditDisplay();
    
    // Load conversation from URL on page load
    loadConversationFromURL();
    
    window.debugCredits = function() {
        console.log({
            userCredits,
            creditsUsed,
            remaining: userCredits - creditsUsed,
            isAnonymous,
            lastCreditReset,
            lowCreditWarningShown,
            firestoreAvailable
        });
        
        forceUpdateCreditDisplay();
    };
});
    </script>
</body>
</html>
